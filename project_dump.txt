
--- FILE: /home/sami/sumyaman/main_app.py ---

from leave_utils import check_on_leave
import sys, os; sys.path.append(os.getcwd()); sys.path.append(os.path.join(os.getcwd(), "apsokara/logic"))
from apsokara.logic.teacher_modules import render_marks_entry
from apsokara.logic.student_modules import render_my_result
from apsokara.logic.class_teacher_modules import render_final_upload
from apsokara.logic.teacher_modules import render_marks_entry
from apsokara.logic.student_modules import render_my_result
from news_utility import render_news_ticker
import streamlit as st
from news_utility import render_news_ticker
import base64
import datetime
import base64
import sqlite3
import pandas as pd
import plotly.graph_objects as go # Donut chart ke liye

# 1. Page Config
st.set_page_config(page_title="ARMY PUBLIC SCHOOL & COLLAGE SYSTEM Portal", layout="wide", initial_sidebar_state="collapsed")
render_news_ticker()

# --- LEAVE SYSTEM HELPER FUNCTIONS ---
def check_on_leave(student_id):
    try:
        import sqlite3
        import datetime
        conn = sqlite3.connect('db.sqlite3')
        today = datetime.date.today().isoformat()
        cur = conn.cursor()
        # Naye table 'apsokara_studentleave' se check karna
        query = "SELECT id FROM apsokara_studentleave WHERE student_id=? AND status='Approved' AND ? BETWEEN from_date AND to_date"
        cur.execute(query, (student_id, today))
        res = cur.fetchone()
        conn.close()
        return True if res else False
    except Exception as e:
        return False

def get_pending_count(u):
    try:
        conn = sqlite3.connect('db.sqlite3')
        cur = conn.cursor()
        cur.execute("SELECT COUNT(*) FROM apsokara_leaverequests WHERE student_class=? AND student_section=? AND wing=? AND status='Pending'", (u.get('class'), u.get('sec'), u.get('wing')))
        count = cur.fetchone()[0]
        conn.close()
        return f" ({count})" if count > 0 else ""
    except: return ""

# --- PROFESSIONAL NOTIFICATION SYSTEM (INJECTED) ---
def display_notifications():
    try:
        conn = sqlite3.connect("db.sqlite3", timeout=30)
        cur = conn.cursor()
        cur.execute("SELECT title, content, date_posted FROM apsokara_schoolnotice WHERE is_active=1 ORDER BY date_posted DESC LIMIT 8")
        notices = cur.fetchall()
        conn.close()
        count = len(notices)
        badge_val = f"{count}" if count <= 9 else "9+"
        notices_html = ""
        for n in notices:
            notices_html += f"""
            <div style="padding:12px; border-bottom:1px solid #f0f0f0; transition: background 0.3s;">
                <div style="font-weight:700; color:#1A237E; font-size:14px; margin-bottom:3px;">{n[0]}</div>
                <div style="color:#444; font-size:13px; line-height:1.4;">{n[1]}</div>
                <div style="color:#999; font-size:10px; margin-top:5px; text-align:right;">{n[2]}</div>
            </div>
            """
        if not notices:
            notices_html = "<div style='padding:30px; text-align:center; color:#999;'>No new notifications</div>"

        st.markdown(f"""
        <style>
            .notif-wrapper {{ position: fixed; bottom: 30px; right: 30px; z-index: 999999; }}
            .notif-bell {{ background: #FF0000; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 2px solid white; font-size: 28px; position: relative; }}
            .notif-badge {{ position: absolute; top: -5px; right: -5px; background: #1A237E; color: white; border-radius: 50%; width: 26px; height: 26px; font-size: 11px; font-weight: 800; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }}
            .notif-window {{ position: absolute; bottom: 80px; right: 0; width: 330px; max-height: 450px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; flex-direction: column; overflow: hidden; border: 1px solid #ddd; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }}
            @keyframes popUp {{ from {{ transform: scale(0.8) translateY(20px); opacity: 0; }} to {{ transform: scale(1) translateY(0); opacity: 1; }} }}
            .notif-wrapper:focus-within .notif-window {{ display: flex; }}
            .notif-header {{ background: #1A237E; color: white; padding: 15px; font-weight: 800; font-size: 16px; border-bottom: 2px solid #FFD700; }}
            .notif-content {{ overflow-y: auto; background: #fff; }}
        </style>
        <div class="notif-wrapper" tabindex="0">
            <div class="notif-window">
                <div class="notif-header">üîî Recent Notifications</div>
                <div class="notif-content">{notices_html}</div>
            </div>
            <div class="notif-bell">
                <span>üîî</span>
                <div class="notif-badge">{badge_val}</div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    except: pass

def display_ticker():
    try:
        conn = sqlite3.connect("db.sqlite3", timeout=30)
        cur = conn.cursor()
        cur.execute("SELECT title, content, scheme FROM apsokara_schoolnotice WHERE is_active=1 ORDER BY date_posted DESC LIMIT 5")
        notices = cur.fetchall()
        conn.close()
        if notices:
            items = "".join([f"<span style='background:{n[2]};padding:2px 8px;border-radius:4px;font-size:11px;margin-right:8px;color:white;font-weight:bold;'>NEWS</span><b style='color:#FFD700;font-size:16px;'> {n[0]}: </b><span style='color:white;font-size:15px;'>{n[1]}</span> &nbsp;&nbsp;&nbsp; ‚ö° &nbsp;&nbsp;&nbsp; " for n in notices])
            st.markdown(f"""
            <style>
                .ticker-wrapper {{ display: flex; background: #1a1a1a; border-radius: 10px; overflow: hidden; border: 1px solid #333; height: 50px; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative; margin-bottom: 20px; }}
                .live-label {{ background: #ff0000; color: white; padding: 0 25px; height: 100%; display: flex; align-items: center; font-weight: 900; font-size: 14px; z-index: 10; box-shadow: 10px 0 20px rgba(0,0,0,0.5); text-transform: uppercase; }}
                .ticker-scroll-container {{ flex-grow: 1; overflow: hidden; white-space: nowrap; position: relative; display: flex; align-items: center; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }}
                .ticker-text {{ display: inline-block; padding-left: 100%; animation: tv-marquee 40s linear infinite; color: white; }}
                @keyframes tv-marquee {{ 0% {{ transform: translate3d(0, 0, 0); }} 100% {{ transform: translate3d(-100%, 0, 0); }} }}
                .live-label::after {{ content: ""; width: 10px; height: 10px; background: white; border-radius: 50%; margin-left: 10px; animation: pulse-dot 1s infinite; }}
                @keyframes pulse-dot {{ 0% {{ opacity: 1; }} 50% {{ opacity: 0.2; }} 100% {{ opacity: 1; }} }}
            </style>
            <div class="ticker-wrapper">
                <div class="live-label">Live Updates</div>
                <div class="ticker-scroll-container">
                    <div class="ticker-text">{items} {items}</div>
                </div>
            </div>
            """, unsafe_allow_html=True)
    except: pass

display_ticker()
display_notifications()

if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
    st.session_state.role = None
    st.session_state.user_info = {}

def get_base64(file_path):
    try:
        with open(file_path, "rb") as f: data = f.read()
        return base64.b64encode(data).decode()
    except: return ""

LOGO_PATH = '/home/sami/Downloads/sami.png'
img_base64 = get_base64(LOGO_PATH)

def get_history_df(student_id):
    conn = sqlite3.connect('db.sqlite3')
    q = "SELECT date, status FROM apsokara_attendance WHERE student_id=? AND session_year = (SELECT session_year FROM apsokara_student WHERE id=?) GROUP BY date ORDER BY date DESC"
    df = pd.read_sql_query(q, conn, params=(u['id'], u['id']))
    conn.close()
    if not df.empty:
        df['date'] = pd.to_datetime(df['date'])
        df['Day'] = df['date'].dt.strftime('%A')
        df['Date'] = df['date'].dt.strftime('%d-%m-%Y')
        df.refull_name(columns={'status': 'Status'}, inplace=True)
        return df[['Date', 'Day', 'Status']]
    return pd.DataFrame()

def get_student_overall_stats(student_id):
    conn = sqlite3.connect('db.sqlite3')
    # Count only unique dates for this student
    q = "SELECT status, COUNT(*) as count FROM apsokara_attendance WHERE student_id=? AND session_year = (SELECT session_year FROM apsokara_student WHERE id=?) GROUP BY status"
    df = pd.read_sql_query(q, conn, params=(u['id'], u['id']))
    conn.close()
    stats = {"P": 0, "A": 0, "L": 0, "Total": 0}
    for _, row in df.iterrows():
        stats[row['status']] = row['count']
    stats['Total'] = sum([stats['P'], stats['A'], stats['L']])
    return stats

def check_attendance_state(t_class, t_sec, t_wing):
    conn = sqlite3.connect('db.sqlite3')
    cursor = conn.cursor()
    today = datetime.date.today().isoformat()
    cursor.execute("""SELECT MAX(edit_count) FROM apsokara_attendance 
                      WHERE student_class=? AND student_section=? AND date=? 
                      AND student_id IN (SELECT cnic FROM apsokara_student WHERE wing=?)""", 
                   (t_class, t_sec, today, t_wing))
    res = cursor.fetchone()
    conn.close()
    return res[0] if res[0] is not None else 0

def save_attendance(attendance_data, t_class, t_sec, is_edit=False):
    conn = sqlite3.connect('db.sqlite3')
    cursor = conn.cursor()
    today = datetime.date.today().isoformat()
    new_count = 2 if is_edit else 1
    try:
        for s_id, status in attendance_data.items():
            cursor.execute("DELETE FROM apsokara_attendance WHERE student_id=? AND session_year = (SELECT session_year FROM apsokara_student WHERE id=?) AND date=?", (s_id, today))
            cursor.execute('''INSERT INTO apsokara_attendance 
                            (student_id, date, status, class, student_section, edit_count) 
                            VALUES (?, ?, ?, ?, ?, ?)''', (s_id, today, status, t_class, t_sec, new_count))
        conn.commit()
        return True
    except: return False
    finally: conn.close()




def fetch_user_data(user_id, dob_val, user_type):
    conn = sqlite3.connect('db.sqlite3')
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    try:
        if user_type == "Teacher":
            q = "SELECT *, assigned_wing as wing, assigned_class as class, assigned_section as sec FROM apsokara_teacher WHERE cnic = ? AND dob = ?"
        else:
            q = "SELECT *, student_class as class, student_section as sec FROM apsokara_student WHERE b_form = ? AND dob = ?"
        
        cursor.execute(q, (user_id, dob_val))
        row = cursor.fetchone()
        if row:
            data = dict(row)
            # Yahan asali jaadu hai:
            if user_type == "Teacher" and row['is_class_teacher'] == 1:
                data['role_db'] = "Class Teacher"
            else:
                data['role_db'] = user_type
            return data
        return None
    except Exception as e:
        st.error(f"Database Error: {e}")
        return None
    finally:
        conn.close()




def get_daily_analytics(t_class, t_sec, t_wing):
    conn = sqlite3.connect('db.sqlite3')
    today = datetime.date.today().isoformat()
    q_total = "SELECT COUNT(*) FROM apsokara_student WHERE student_class=? AND student_section=? AND wing=?"
    total = pd.read_sql_query(q_total, conn, params=(t_class, t_sec, t_wing)).iloc[0,0]
    q_stats = """SELECT status, COUNT(*) as count FROM apsokara_attendance 
                 WHERE student_class=? AND student_section=? AND date=?
                 AND student_id IN (SELECT cnic FROM apsokara_student WHERE wing=?)
                 GROUP BY status"""
    df_stats = pd.read_sql_query(q_stats, conn, params=(t_class, t_sec, today, t_wing))
    conn.close()
    stats = {"Present": 0, "Absent": 0, "Leave": 0, "Total": 0}
    for _, row in df_stats.iterrows():
        key = "Present" if row['status'] == 'P' else ("Absent" if row['status'] == 'A' else "Leave")
        stats[key] = row['count']
    return stats

# --- CUSTOM CSS ---
role = st.session_state.role
if role == "Student": primary, secondary, accent, btn_color = "#B22222", "#FFFFFF", "#333333", "#FF0000"
elif role == "Class Teacher": primary, secondary, accent, btn_color = "#1A237E", "#DCDCDC", "#000000", "#2196F3"
elif role == "Subject Teacher": primary, secondary, accent, btn_color = "#DC143C", "#FFFFF0", "#212121", "#FFD700"
else: primary, secondary, accent, btn_color = "#1A237E", "#F4F7F6", "#333333", "#2196F3"

st.markdown(f'''
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
    * {{ font-family: 'Poppins', sans-serif; color: {accent}; }}
    .stApp {{ background-color: {secondary}; }}
    .hero-card {{ background: #F0F0F0; border-radius: 25px; padding: 30px 40px; margin-bottom: 30px; display: flex !important; flex-direction: row !important; align-items: center !important; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px solid {primary}; position: relative; }}
    .hero-logo-container {{ flex: 0 0 130px !important; height: 130px !important; background: white; border-radius: 20px; display: flex !important; align-items: center !important; justify-content: center !important; margin-right: 35px !important; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }}
    .hero-logo-container img {{ width: 90px !important; }}
    .welcome-text {{ font-size: 34px !important; font-weight: 800 !important; margin: 0 0 15px 0 !important; color: {primary}; line-height: 1.1; }}
    .details-row {{ display: flex !important; flex-wrap: wrap !important; gap: 12px !important; margin-top: 5px !important; }}
    .detail-item {{ background: white; padding: 8px 16px; border-radius: 12px; border: 1px solid {primary}33; }}
    .detail-item b {{ display: block; font-size: 10px; text-transform: uppercase; margin-bottom: 2px; color: {primary}; opacity: 0.8; }}
    .detail-item span {{ font-size: 14px !important; font-weight: 600 !important; color: {accent}; }}
    .stTabs [data-baseweb="tab-list"] {{ gap: 15px !important; justify-content: center !important; display: flex !important; width: 100% !important; background-color: transparent !important; margin: 20px 0 30px 0 !important; }}
    .stTabs [data-baseweb="tab"] {{ height: 50px; background-color: {secondary}; border-radius: 12px; padding: 10px 25px; font-weight: 600; border: 1px solid {primary}33; transition: all 0.3s; }}
    .stTabs [aria-selected="true"] {{ background-color: {primary} !important; color: white !important; border-bottom: none !important; }}
    .stButton>button {{ background-color: {btn_color} !important; color: {"#000000" if role == "Subject Teacher" else "white"} !important; font-weight: 800 !important; border-radius: 12px !important; border: none !important; padding: 15px 30px !important; text-transform: uppercase !important; width: 100%; }}
    .stat-card {{ background: white; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }}
    .stat-val {{ font-size: 28px; font-weight: 800; color: {primary}; }}
    .stat-lbl {{ font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase; }}
</style>
''', unsafe_allow_html=True)

def show_dashboard():
    role = st.session_state.role
    u = st.session_state.user_info
    if role == "Student":
        tag, tag_col = "üéì STUDENT PORTAL", "#B22222"
        extra = f'''<div class="detail-item"><b>üë®‚Äçüë¶ Father</b><span>{u.get("father_name")}</span></div><div class="detail-item"><b>üÜî CNIC</b><span>{u.get("cnic")}</span></div><div class="detail-item"><b>üìÖ DOB</b><span>{u.get("dob")}</span></div><div class="detail-item"><b>‚ò™Ô∏è Religion</b><span>{u.get("religion")}</span></div><div class="detail-item"><b>üìû Contact</b><span>{u.get("contact")}</span></div><div class="detail-item"><b>üè† Address</b><span>{u.get("address")}</span></div><div class="detail-item"><b>üè´ Assigned</b><span>{u.get("class")}-{u.get("sec")} ({u.get("wing")})</span></div>'''
    elif role == "Class Teacher":
        tag, tag_col = "üë®‚Äçüè´ CLASS INCHARGE", "#1A237E"
        extra = f'''<div class="detail-item"><b>üë®‚Äçüë¶ Father</b><span>{u.get("father_name")}</span></div><div class="detail-item"><b>üÜî CNIC</b><span>{u.get("cnic")}</span></div><div class="detail-item"><b>üìÖ DOB</b><span>{u.get("dob")}</span></div><div class="detail-item"><b>‚ò™Ô∏è Religion</b><span>{u.get("religion")}</span></div><div class="detail-item"><b>üìû Contact</b><span>{u.get("contact")}</span></div><div class="detail-item"><b>üè† Address</b><span>{u.get("address")}</span></div><div class="detail-item"><b>üè´ Assigned</b><span>{u.get("class")}-{u.get("sec")} ({u.get("wing")})</span></div>'''
    else:
        tag, tag_col = "üìñ SUBJECT TEACHER", "#DC143C"
        extra = f'''<div class="detail-item"><b>üë®‚Äçüë¶ Father</b><span>{u.get("father_name")}</span></div><div class="detail-item"><b>üÜî CNIC</b><span>{u.get("cnic")}</span></div><div class="detail-item"><b>üìÖ DOB</b><span>{u.get("dob")}</span></div><div class="detail-item"><b>‚ò™Ô∏è Religion</b><span>{u.get("religion")}</span></div><div class="detail-item"><b>üìû Contact</b><span>{u.get("contact")}</span></div><div class="detail-item"><b>üè† Address</b><span>{u.get("address")}</span></div><div class="detail-item"><b>üè´ Assigned</b><span>{u.get("class")}-{u.get("sec")} ({u.get("wing")})</span></div>'''

    st.markdown(f'''
    <div class="hero-card">
        <div style="position: absolute; top: 15px; right: 15px; z-index: 1000;"><a href="/" target="_self" style="text-decoration: none;"><button style="background: {primary}; border: none; color: white; padding: 10px 18px; border-radius: 12px; cursor: pointer; font-size: 13px; font-weight: 700;">üö™ LOGOUT</button></a></div>
        <div class="hero-logo-container"><img src="data:image/png;base64,{img_base64}"></div>
        <div class="hero-info">
            <div style="font-size:11px; font-weight:800; letter-spacing:2px; color:{tag_col}; margin-bottom:5px;">{tag}</div>
            <div class="welcome-text">Welcome Back, {u.get('full_name', u.get('full_name', 'User'))}! ‚ú®</div>
            <div class="details-row">
                <div class="detail-item"><b>üë§ Full Name</b><span>{u.get('full_name', u.get('full_name', 'User'))}</span></div>
                <div class="detail-item"><b>üè¢ Wing</b><span>{u.get('wing')} Wing</span></div>
                {extra}
            </div>
        </div>
    </div>
    ''', unsafe_allow_html=True)

    if role == "Student": tabs_list = ["üè† HOME", "üìÖ DAILY DIARY", "üìú ATTENDANCE HISTORY", "üìù APPLY LEAVE", "üèÜ MY RESULT"]
    elif role == "Class Teacher": tabs_list = ["üè† DASHBOARD", "üìì POST DIARY", "üìù ATTENDANCE SYSTEM", f"üì• LEAVE APPROVALS{get_pending_count(u)}", "üéØ MARKS ENTRY", "üì§ FINAL UPLOAD"]
    else: tabs_list = ["üè† DASHBOARD", "üìì POST DIARY", "üìö TEACHING SCHEDULE", "üéØ MARKS ENTRY", "üìù ATTENDANCE"]
    
    active_tabs = st.tabs(tabs_list)
    for i, tab in enumerate(active_tabs):
        with tab:
            t_full_name = tabs_list[i].upper()
            if 'MY RESULT' in t_full_name or 'RESULT' in t_full_name:
                from apsokara.logic.student_modules import render_my_result
                render_my_result(st.session_state.user_info)
            elif "ATTENDANCE HISTORY" in t_full_name:
                from attendance_logic import render_student_attendance
                render_student_attendance(u)
            elif 'MARKS ENTRY' in t_full_name:
                from apsokara.logic.teacher_modules import render_marks_entry
                render_marks_entry(st.session_state.user_info)
            elif 'FINAL UPLOAD' in t_full_name:
                from apsokara.logic.class_teacher_modules import render_final_upload
                render_final_upload(st.session_state.user_info)
            elif t_full_name == "üìù ATTENDANCE SYSTEM" or t_full_name == "üìù ATTENDANCE":
                from attendance_system import render_attendance_system
                render_attendance_system(st.session_state.user_info)
            elif "LEAVE" in t_full_name:
                from leave_engine import render_leave_system
                render_leave_system(st.session_state.user_info)
            elif "DIARY" in t_full_name:
                from diary_engine import render_diary
                render_diary(st.session_state.user_info)
            elif 'HOME' in t_full_name or 'DASHBOARD' in t_full_name:
                st.markdown(f"## üèõÔ∏è Welcome, {st.session_state.user_info.get('full_name', st.session_state.user_info.get('full_name', 'User'))}!")
                c1, c2, c3 = st.columns(3)
                with c1: st.info("üìÖ Today: " + str(datetime.date.today()))
                with c2: st.success("‚úÖ System Status: Active")
                with c3: st.warning("üîî New Notices: Check Notifications")
                st.divider()
                st.image("https://img.freepik.com/free-vector/education-background-with-books-lamp_23-2147501981.jpg", use_container_width=True)
                st.write(f'## Welcome, {st.session_state.user_info.get('full_name', st.session_state.user_info.get('full_name', 'User'))}!')
def show_login():
    st.markdown(f'''<div style="text-align:center; padding-top:0px;"><img src="data:image/png;base64,{img_base64}" width="100"><h1 style="color:#000000; font-weight:800;">ARMY PUBLIC SCHOOL & COLLAGE SYSTEM PORTAL</h1></div>''', unsafe_allow_html=True)
    t1, t2= st.tabs(["üéì STUDENT LOGIN", "üë®‚Äçüè´ STAFF LOGIN"])
    with t1:
        id_s = st.text_input("B-Form Number", key="s_login")
        dob_s = st.date_input("Birth Date", value=datetime.date(2010,1,1), key="s_dob")
        if st.button("ENTER STUDENT PORTAL", key="s_btn"):
            d = fetch_user_data(id_s, str(dob_s), "Student")
            if d:
                st.session_state.user_info, st.session_state.role, st.session_state.logged_in = d, "Student", True
                st.rerun()
    with t2:
        id_t = st.text_input("CNIC Number", key="t_login")
        dob_t = st.date_input("Birth Date ", value=datetime.date(1990,1,1), key="t_dob")
        if st.button("ENTER STAFF PORTAL", key="t_btn"):
            d = fetch_user_data(id_t, str(dob_t), "Teacher")
            if d:
                st.session_state.user_info, st.session_state.role, st.session_state.logged_in = d, d['role_db'], True
                st.rerun()

if not st.session_state.logged_in: show_login()
else: show_dashboard()


def logout():
    for key in list(st.session_state.keys()):
        del st.session_state[key]
    st.rerun()
--- FILE: /home/sami/sumyaman/db_bridge.py ---

import sqlite3
import pandas as pd

DB_PATH = "db.sqlite3"

def get_connection():
    return sqlite3.connect(DB_PATH, check_same_thread=False)

def fetch_df(query, params=()):
    with get_connection() as conn:
        try:
            # Query ko clean karke chalana
            return pd.read_sql_query(query, conn, params=params)
        except Exception as e:
            print(f"DB Error: {e}")
            return pd.DataFrame()

def execute(query, params=()):
    with get_connection() as conn:
        cur = conn.cursor()
        cur.execute(query, params)
        conn.commit()

def get_active_exam_for_class(class_name):
    # Sirf title uthao jo active ho
    df = fetch_df("SELECT id, title FROM apsokara_examwindow WHERE is_active = 1 LIMIT 1")
    if df.empty:
        return None
    return {"id": df.iloc[0]['id'], "title": df.iloc[0]['title']}

--- FILE: /home/sami/sumyaman/diary_engine.py ---

import streamlit as st
import sqlite3
import pandas as pd
from datetime import date

def render_diary(u):
    st.subheader("üìì Digital School Diary")
    conn = sqlite3.connect('db.sqlite3')
    
    # Safe data fetching from session
    is_student = "student_class" in u
    c_name = u.get('student_class') or u.get('incharge_class') or "N/A"
    sec = u.get('student_section') or u.get('incharge_section') or "N/A"
    wing = u.get('wing') or "Boys"

    if not is_student:
        st.markdown("### üñãÔ∏è Post New Entry")
        with st.form("diary_form"):
            subj_val = st.text_input("Subject Name")
            content = st.text_area("Diary Message")
            if st.form_submit_button("Post to Class"):
                cur = conn.cursor()
                query = "INSERT INTO apsokara_diary (class_name, section, wing, subject_name, diary_content, date_posted, teacher_name) VALUES (?,?,?,?,?,?,?)"
                cur.execute(query, (c_name, sec, wing, subj_val, content, date.today().isoformat(), u.get('full_name', 'Teacher')))
                conn.commit()
                st.success("Diary posted successfully!")

    st.markdown("---")
    st.markdown("### üìÖ Recent Diary Entries")
    query = "SELECT date_posted, subject_name, diary_content FROM apsokara_diary WHERE class_name=? AND section=? AND wing=? ORDER BY id DESC LIMIT 10"
    try:
        df = pd.read_sql(query, conn, params=(c_name, sec, wing))
        if df.empty:
            st.info("No diary entries found for your class.")
        else:
            for _, row in df.iterrows():
                with st.expander(f"üìå {row['date_posted']} - {row['subject_name']}"):
                    st.write(row['diary_content'])
    except Exception as e:
        st.error(f"Error: {e}")
    
    conn.close()

--- FILE: /home/sami/sumyaman/name_fixer.py ---

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

with open(file_path, 'w') as f:
    for line in lines:
        # Purane 'name' references ko smart references se replace karna
        line = line.replace("{u.get('name')}", "{u.get('full_name', u.get('name'))}")
        line = line.replace("{st.session_state.user_info.get('name', 'User')}", "{st.session_state.user_info.get('full_name', st.session_state.user_info.get('name', 'User'))}")
        f.write(line)

--- FILE: /home/sami/sumyaman/main_app_backup.py ---

from leave_utils import check_on_leave
import sys, os; sys.path.append(os.getcwd()); sys.path.append(os.path.join(os.getcwd(), "apsokara/logic"))
from apsokara.logic.teacher_modules import render_marks_entry
from apsokara.logic.student_modules import render_my_result
from apsokara.logic.class_teacher_modules import render_final_upload
from apsokara.logic.teacher_modules import render_marks_entry
from apsokara.logic.student_modules import render_my_result
from news_utility import render_news_ticker
import streamlit as st
import base64
import datetime
import base64
import sqlite3
import pandas as pd
import plotly.graph_objects as go # Donut chart ke liye

# 1. Page Config
st.set_page_config(page_title="ARMY PUBLIC SCHOOL & COLLAGE SYSTEM Portal", layout="wide", initial_sidebar_state="collapsed")

# --- LEAVE SYSTEM HELPER FUNCTIONS ---
def check_on_leave(student_id):
    try:
        import sqlite3
        import datetime
        conn = sqlite3.connect('db.sqlite3')
        today = datetime.date.today().isoformat()
        cur = conn.cursor()
        # Naye table 'apsokara_studentleave' se check karna
        query = "SELECT id FROM apsokara_studentleave WHERE student_id=? AND status='Approved' AND ? BETWEEN from_date AND to_date"
        cur.execute(query, (student_id, today))
        res = cur.fetchone()
        conn.close()
        return True if res else False
    except Exception as e:
        return False

def get_pending_count(u):
    try:
        conn = sqlite3.connect('db.sqlite3')
        cur = conn.cursor()
        cur.execute("SELECT COUNT(*) FROM apsokara_leaverequests WHERE class=? AND student_section=? AND wing=? AND status='Pending'", (u.get('class'), u.get('sec'), u.get('wing')))
        count = cur.fetchone()[0]
        conn.close()
        return f" ({count})" if count > 0 else ""
    except: return ""

# --- PROFESSIONAL NOTIFICATION SYSTEM (INJECTED) ---
def display_notifications():
    try:
        conn = sqlite3.connect("db.sqlite3", timeout=30)
        cur = conn.cursor()
        cur.execute("SELECT title, content, date_posted FROM apsokara_schoolnotice WHERE is_active=1 ORDER BY date_posted DESC LIMIT 8")
        notices = cur.fetchall()
        conn.close()
        count = len(notices)
        badge_val = f"{count}" if count <= 9 else "9+"
        notices_html = ""
        for n in notices:
            notices_html += f"""
            <div style="padding:12px; border-bottom:1px solid #f0f0f0; transition: background 0.3s;">
                <div style="font-weight:700; color:#1A237E; font-size:14px; margin-bottom:3px;">{n[0]}</div>
                <div style="color:#444; font-size:13px; line-height:1.4;">{n[1]}</div>
                <div style="color:#999; font-size:10px; margin-top:5px; text-align:right;">{n[2]}</div>
            </div>
            """
        if not notices:
            notices_html = "<div style='padding:30px; text-align:center; color:#999;'>No new notifications</div>"

        st.markdown(f"""
        <style>
            .notif-wrapper {{ position: fixed; bottom: 30px; right: 30px; z-index: 999999; }}
            .notif-bell {{ background: #FF0000; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.3); border: 2px solid white; font-size: 28px; position: relative; }}
            .notif-badge {{ position: absolute; top: -5px; right: -5px; background: #1A237E; color: white; border-radius: 50%; width: 26px; height: 26px; font-size: 11px; font-weight: 800; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }}
            .notif-window {{ position: absolute; bottom: 80px; right: 0; width: 330px; max-height: 450px; background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); display: none; flex-direction: column; overflow: hidden; border: 1px solid #ddd; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }}
            @keyframes popUp {{ from {{ transform: scale(0.8) translateY(20px); opacity: 0; }} to {{ transform: scale(1) translateY(0); opacity: 1; }} }}
            .notif-wrapper:focus-within .notif-window {{ display: flex; }}
            .notif-header {{ background: #1A237E; color: white; padding: 15px; font-weight: 800; font-size: 16px; border-bottom: 2px solid #FFD700; }}
            .notif-content {{ overflow-y: auto; background: #fff; }}
        </style>
        <div class="notif-wrapper" tabindex="0">
            <div class="notif-window">
                <div class="notif-header">üîî Recent Notifications</div>
                <div class="notif-content">{notices_html}</div>
            </div>
            <div class="notif-bell">
                <span>üîî</span>
                <div class="notif-badge">{badge_val}</div>
            </div>
        </div>
        """, unsafe_allow_html=True)
    except: pass

def display_ticker():
    try:
        conn = sqlite3.connect("db.sqlite3", timeout=30)
        cur = conn.cursor()
        cur.execute("SELECT title, content, scheme FROM apsokara_schoolnotice WHERE is_active=1 ORDER BY date_posted DESC LIMIT 5")
        notices = cur.fetchall()
        conn.close()
        if notices:
            items = "".join([f"<span style='background:{n[2]};padding:2px 8px;border-radius:4px;font-size:11px;margin-right:8px;color:white;font-weight:bold;'>NEWS</span><b style='color:#FFD700;font-size:16px;'> {n[0]}: </b><span style='color:white;font-size:15px;'>{n[1]}</span> &nbsp;&nbsp;&nbsp; ‚ö° &nbsp;&nbsp;&nbsp; " for n in notices])
            st.markdown(f"""
            <style>
                .ticker-wrapper {{ display: flex; background: #1a1a1a; border-radius: 10px; overflow: hidden; border: 1px solid #333; height: 50px; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); position: relative; margin-bottom: 20px; }}
                .live-label {{ background: #ff0000; color: white; padding: 0 25px; height: 100%; display: flex; align-items: center; font-weight: 900; font-size: 14px; z-index: 10; box-shadow: 10px 0 20px rgba(0,0,0,0.5); text-transform: uppercase; }}
                .ticker-scroll-container {{ flex-grow: 1; overflow: hidden; white-space: nowrap; position: relative; display: flex; align-items: center; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }}
                .ticker-text {{ display: inline-block; padding-left: 100%; animation: tv-marquee 40s linear infinite; color: white; }}
                @keyframes tv-marquee {{ 0% {{ transform: translate3d(0, 0, 0); }} 100% {{ transform: translate3d(-100%, 0, 0); }} }}
                .live-label::after {{ content: ""; width: 10px; height: 10px; background: white; border-radius: 50%; margin-left: 10px; animation: pulse-dot 1s infinite; }}
                @keyframes pulse-dot {{ 0% {{ opacity: 1; }} 50% {{ opacity: 0.2; }} 100% {{ opacity: 1; }} }}
            </style>
            <div class="ticker-wrapper">
                <div class="live-label">Live Updates</div>
                <div class="ticker-scroll-container">
                    <div class="ticker-text">{items} {items}</div>
                </div>
            </div>
            """, unsafe_allow_html=True)
    except: pass

display_ticker()
display_notifications()

if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
    st.session_state.role = None
    st.session_state.user_info = {}

def get_base64(file_path):
    try:
        with open(file_path, "rb") as f: data = f.read()
        return base64.b64encode(data).decode()
    except: return ""

LOGO_PATH = '/home/sami/Downloads/sami.png'
img_base64 = get_base64(LOGO_PATH)

def get_history_df(student_id):
    conn = sqlite3.connect('db.sqlite3')
    q = "SELECT date, status FROM apsokara_attendance WHERE student_id=? AND session_year = (SELECT session_year FROM apsokara_student WHERE id=?) GROUP BY date ORDER BY date DESC"
    df = pd.read_sql_query(q, conn, params=(u['id'], u['id']))
    conn.close()
    if not df.empty:
        df['date'] = pd.to_datetime(df['date'])
        df['Day'] = df['date'].dt.strftime('%A')
        df['Date'] = df['date'].dt.strftime('%d-%m-%Y')
        df.refull_name(columns={'status': 'Status'}, inplace=True)
        return df[['Date', 'Day', 'Status']]
    return pd.DataFrame()

def get_student_overall_stats(student_id):
    conn = sqlite3.connect('db.sqlite3')
    # Count only unique dates for this student
    q = "SELECT status, COUNT(*) as count FROM apsokara_attendance WHERE student_id=? AND session_year = (SELECT session_year FROM apsokara_student WHERE id=?) GROUP BY status"
    df = pd.read_sql_query(q, conn, params=(u['id'], u['id']))
    conn.close()
    stats = {"P": 0, "A": 0, "L": 0, "Total": 0}
    for _, row in df.iterrows():
        stats[row['status']] = row['count']
    stats['Total'] = sum([stats['P'], stats['A'], stats['L']])
    return stats

def check_attendance_state(t_class, t_sec, t_wing):
    conn = sqlite3.connect('db.sqlite3')
    cursor = conn.cursor()
    today = datetime.date.today().isoformat()
    cursor.execute("""SELECT MAX(edit_count) FROM apsokara_attendance 
                      WHERE class=? AND student_section=? AND date=? 
                      AND student_id IN (SELECT cnic FROM apsokara_student WHERE wing=?)""", 
                   (t_class, t_sec, today, t_wing))
    res = cursor.fetchone()
    conn.close()
    return res[0] if res[0] is not None else 0

def save_attendance(attendance_data, t_class, t_sec, is_edit=False):
    conn = sqlite3.connect('db.sqlite3')
    cursor = conn.cursor()
    today = datetime.date.today().isoformat()
    new_count = 2 if is_edit else 1
    try:
        for s_id, status in attendance_data.items():
            cursor.execute("DELETE FROM apsokara_attendance WHERE student_id=? AND session_year = (SELECT session_year FROM apsokara_student WHERE id=?) AND date=?", (s_id, today))
            cursor.execute('''INSERT INTO apsokara_attendance 
                            (student_id, date, status, class, student_section, edit_count) 
                            VALUES (?, ?, ?, ?, ?, ?)''', (s_id, today, status, t_class, t_sec, new_count))
        conn.commit()
        return True
    except: return False
    finally: conn.close()



def fetch_user_data(user_id, dob_val, user_type):
    conn = sqlite3.connect('db.sqlite3')
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    try:
        if user_type == "Teacher":
            q = "SELECT id, full_name, assigned_wing as wing, assigned_class as class, assigned_section, is_class_teacher as section, is_class_teacher FROM apsokara_teacher WHERE cnic = ? AND dob = ?"
        else:
            q = "SELECT id, full_name, wing, student_class as class, student_section as section FROM apsokara_student WHERE b_form = ? AND dob = ?"
        
        cursor.execute(q, (user_id, dob_val))
        row = cursor.fetchone()
        if row:
            data = dict(row)
            data['role_db'] = user_type
            data['is_class_teacher'] = row['is_class_teacher']  # Ye line KeyError: 'role_db' ko theek karegi
            return data
        return None
    except Exception as e:
        st.error(f"Database Error: {e}")
        return None
    finally:
        conn.close()



def get_daily_analytics(t_class, t_sec, t_wing):
    conn = sqlite3.connect('db.sqlite3')
    today = datetime.date.today().isoformat()
    q_total = "SELECT COUNT(*) FROM apsokara_student WHERE class=? AND student_section=? AND wing=?"
    total = pd.read_sql_query(q_total, conn, params=(t_class, t_sec, t_wing)).iloc[0,0]
    q_stats = """SELECT status, COUNT(*) as count FROM apsokara_attendance 
                 WHERE class=? AND student_section=? AND date=?
                 AND student_id IN (SELECT cnic FROM apsokara_student WHERE wing=?)
                 GROUP BY status"""
    df_stats = pd.read_sql_query(q_stats, conn, params=(t_class, t_sec, today, t_wing))
    conn.close()
    stats = {"Present": 0, "Absent": 0, "Leave": 0, "Total": total}
    for _, row in df_stats.iterrows():
        key = "Present" if row['status'] == 'P' else ("Absent" if row['status'] == 'A' else "Leave")
        stats[key] = row['count']
    return stats

# --- CUSTOM CSS ---
role = st.session_state.role
if role == "Student": primary, secondary, accent, btn_color = "#B22222", "#FFFFFF", "#333333", "#FF0000"
elif role == "Class Teacher": primary, secondary, accent, btn_color = "#1A237E", "#DCDCDC", "#000000", "#2196F3"
elif role == "Subject Teacher": primary, secondary, accent, btn_color = "#DC143C", "#FFFFF0", "#212121", "#FFD700"
else: primary, secondary, accent, btn_color = "#1A237E", "#F4F7F6", "#333333", "#2196F3"

st.markdown(f'''
<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
    * {{ font-family: 'Poppins', sans-serif; color: {accent}; }}
    .stApp {{ background-color: {secondary}; }}
    .hero-card {{ background: #F0F0F0; border-radius: 25px; padding: 30px 40px; margin-bottom: 30px; display: flex !important; flex-direction: row !important; align-items: center !important; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px solid {primary}; position: relative; }}
    .hero-logo-container {{ flex: 0 0 130px !important; height: 130px !important; background: white; border-radius: 20px; display: flex !important; align-items: center !important; justify-content: center !important; margin-right: 35px !important; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }}
    .hero-logo-container img {{ width: 90px !important; }}
    .welcome-text {{ font-size: 34px !important; font-weight: 800 !important; margin: 0 0 15px 0 !important; color: {primary}; line-height: 1.1; }}
    .details-row {{ display: flex !important; flex-wrap: wrap !important; gap: 12px !important; margin-top: 5px !important; }}
    .detail-item {{ background: white; padding: 8px 16px; border-radius: 12px; border: 1px solid {primary}33; }}
    .detail-item b {{ display: block; font-size: 10px; text-transform: uppercase; margin-bottom: 2px; color: {primary}; opacity: 0.8; }}
    .detail-item span {{ font-size: 14px !important; font-weight: 600 !important; color: {accent}; }}
    .stTabs [data-baseweb="tab-list"] {{ gap: 15px !important; justify-content: center !important; display: flex !important; width: 100% !important; background-color: transparent !important; margin: 20px 0 30px 0 !important; }}
    .stTabs [data-baseweb="tab"] {{ height: 50px; background-color: {secondary}; border-radius: 12px; padding: 10px 25px; font-weight: 600; border: 1px solid {primary}33; transition: all 0.3s; }}
    .stTabs [aria-selected="true"] {{ background-color: {primary} !important; color: white !important; border-bottom: none !important; }}
    .stButton>button {{ background-color: {btn_color} !important; color: {"#000000" if role == "Subject Teacher" else "white"} !important; font-weight: 800 !important; border-radius: 12px !important; border: none !important; padding: 15px 30px !important; text-transform: uppercase !important; width: 100%; }}
    .stat-card {{ background: white; padding: 20px; border-radius: 20px; text-align: center; border: 1px solid #ddd; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }}
    .stat-val {{ font-size: 28px; font-weight: 800; color: {primary}; }}
    .stat-lbl {{ font-size: 12px; font-weight: 600; color: #666; text-transform: uppercase; }}
</style>
''', unsafe_allow_html=True)

def show_dashboard():
    render_news_ticker()
    role = st.session_state.role
    u = st.session_state.user_info
    if role == "Student":
        tag, tag_col = "üéì STUDENT PORTAL", "#B22222"
        extra = f'''<div class="detail-item"><b>üë®‚Äçüë¶ Father Name</b><span>{u.get('father')}</span></div><div class="detail-item"><b>üìÖ Birth Date</b><span>{u.get('dob')}</span></div><div class="detail-item"><b>üìö Grade</b><span>{u.get("class")}-{u.get("sec")}</span></div><div class="detail-item"><b>üî¢ Roll No</b><span>{u.get("roll")}</span></div>'''
    elif role == "Class Teacher":
        tag, tag_col = "üë®‚Äçüè´ CLASS INCHARGE", "#1A237E"
        extra = f'''<div class="detail-item"><b>üë®‚Äçüë¶ Father Name</b><span>{u.get('father')}</span></div><div class="detail-item"><b>üìÖ DOB</b><span>{u.get('dob')}</span></div><div class="detail-item"><b>üè´ Class</b><span>{u.get("class")} {u.get("sec")}</span></div>'''
    else:
        tag, tag_col = "üìñ SUBJECT TEACHER", "#DC143C"
        extra = f'''<div class="detail-item"><b>üë®‚Äçüë¶ Father Name</b><span>{u.get('father')}</span></div><div class="detail-item"><b>üìÖ DOB</b><span>{u.get('dob')}</span></div><div class="detail-item"><b>üèõ Staff Type</b><span>Academic Staff</span></div>'''                                              

    st.markdown(f'''
    <div class="hero-card">
        <div style="position: absolute; top: 15px; right: 15px; z-index: 1000;"><a href="/" target="_self" style="text-decoration: none;"><button style="background: {primary}; border: none; color: white; padding: 10px 18px; border-radius: 12px; cursor: pointer; font-size: 13px; font-weight: 700;">üö™ LOGOUT</button></a></div>
        <div class="hero-logo-container"><img src="data:image/png;base64,{img_base64}"></div>
        <div class="hero-info">
            <div style="font-size:11px; font-weight:800; letter-spacing:2px; color:{tag_col}; margin-bottom:5px;">{tag}</div>
            <div class="welcome-text">Welcome Back, {u.get('full_name', u.get('full_name', 'User'))}! ‚ú®</div>
            <div class="details-row">
                <div class="detail-item"><b>üë§ Full Name</b><span>{u.get('full_name', u.get('full_name', 'User'))}</span></div>
                <div class="detail-item"><b>üÜî Identity No</b><span>{u.get('id_num')}</span></div>
                <div class="detail-item"><b>üè¢ Wing</b><span>{u.get('wing')} Wing</span></div>
                {extra}
            </div>
        </div>
    </div>
    ''', unsafe_allow_html=True)

    if role == "Student": tabs_list = ["üè† HOME", "üìÖ DAILY DIARY", "üìú ATTENDANCE HISTORY", "üìù APPLY LEAVE", "üèÜ MY RESULT"]
    elif role == "Class Teacher": tabs_list = ["üè† DASHBOARD", "üìì POST DIARY", "üìù ATTENDANCE SYSTEM", f"üì• LEAVE APPROVALS{get_pending_count(u)}", "üéØ MARKS ENTRY", "üì§ FINAL UPLOAD"]
    else: tabs_list = ["üè† DASHBOARD", "üìì POST DIARY", "üìö TEACHING SCHEDULE", "üéØ MARKS ENTRY"]
    
    active_tabs = st.tabs(tabs_list)
    for i, tab in enumerate(active_tabs):
        with tab:
            t_full_name = tabs_list[i].upper()
            if 'MY RESULT' in t_full_name or 'RESULT' in t_full_name:
                from apsokara.logic.student_modules import render_my_result
                render_my_result(st.session_state.user_info)
            elif "ATTENDANCE HISTORY" in t_full_name:
                from attendance_logic import render_student_attendance
                render_student_attendance(u)
            elif 'MARKS ENTRY' in t_full_name:
                from apsokara.logic.teacher_modules import render_marks_entry
                render_marks_entry(st.session_state.user_info)
            elif 'FINAL UPLOAD' in t_full_name:
                from apsokara.logic.class_teacher_modules import render_final_upload
                render_final_upload(st.session_state.user_info)
            elif "ATTENDANCE" in t_full_name:
                from attendance_system import render_attendance_system
                render_attendance_system(st.session_state.user_info)
            elif "LEAVE" in t_full_name:
                from leave_engine import render_leave_system
                render_leave_system(st.session_state.user_info)
            elif "DIARY" in t_full_name:
                from diary_engine import render_diary
                render_diary(st.session_state.user_info)
            elif 'HOME' in t_full_name or 'DASHBOARD' in t_full_name:
                st.markdown(f"## üèõÔ∏è Welcome, {st.session_state.user_info.get('full_name', st.session_state.user_info.get('full_name', 'User'))}!")
                c1, c2, c3 = st.columns(3)
                with c1: st.info("üìÖ Today: " + str(datetime.date.today()))
                with c2: st.success("‚úÖ System Status: Active")
                with c3: st.warning("üîî New Notices: Check Notifications")
                st.divider()
                st.image("https://img.freepik.com/free-vector/education-background-with-books-lamp_23-2147501981.jpg", use_container_width=True)
                st.write(f'## Welcome, {st.session_state.user_info.get('full_name', st.session_state.user_info.get('full_name', 'User'))}!')
def show_login():
    st.markdown(f'''<div style="text-align:center; padding-top:0px;"><img src="data:image/png;base64,{img_base64}" width="100"><h1 style="color:#000000; font-weight:800;">ARMY PUBLIC SCHOOL & COLLAGE SYSTEM PORTAL</h1></div>''', unsafe_allow_html=True)
    t1, t2= st.tabs(["üéì STUDENT LOGIN", "üë®‚Äçüè´ STAFF LOGIN"])
    with t1:
        id_s = st.text_input("B-Form Number", key="s_login")
        dob_s = st.date_input("Birth Date", value=datetime.date(2010,1,1), key="s_dob")
        if st.button("ENTER STUDENT PORTAL", key="s_btn"):
            d = fetch_user_data(id_s, str(dob_s), "Student")
            if d:
                st.session_state.user_info, st.session_state.role, st.session_state.logged_in = d, "Student", True
                st.rerun()
    with t2:
        id_t = st.text_input("CNIC Number", key="t_login")
        dob_t = st.date_input("Birth Date ", value=datetime.date(1990,1,1), key="t_dob")
        if st.button("ENTER STAFF PORTAL", key="t_btn"):
            d = fetch_user_data(id_t, str(dob_t), "Teacher")
            if d:
                st.session_state.user_info, st.session_state.role, st.session_state.logged_in = d, d['role_db'], True
                st.rerun()

if not st.session_state.logged_in: show_login()
else: show_dashboard()


def logout():
    for key in list(st.session_state.keys()):
        del st.session_state[key]
    st.rerun()

--- FILE: /home/sami/sumyaman/news_utility.py ---

import streamlit as st
import sqlite3
from contextlib import contextmanager

@contextmanager
def get_news_db():
    conn = sqlite3.connect('/home/sami/sumyaman/db.sqlite3', check_same_thread=False)
    try:
        yield conn
    finally:
        conn.close()

def render_news_ticker():
    if 'user_info' not in st.session_state or st.session_state.user_info is None:
        return

    try:
        with get_news_db() as conn:
            res = conn.execute("SELECT content FROM apsokara_schoolnews ORDER BY id DESC LIMIT 5").fetchall()
        
        if res:
            ticker_text = " &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style='color:#800000;'>‚òÖ</span> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ".join([item[0] for item in res])
            
            st.markdown(f"""
            <style>
            @import url('https://fonts.googleapis.com/css2?family=League+Spartan:wght@600;800&display=swap');

            .aps-vibrant-ticker {{
                background: #f8fafc;
                border-top: 1px solid #e2e8f0;
                border-bottom: 3px solid #800000;
                padding: 14px 0;
                margin-bottom: 30px;
                display: flex;
                align-items: center;
                box-shadow: 0 4px 15px rgba(0,0,0,0.06);
                overflow: hidden;
                border-radius: 8px;
            }}

            .vibrant-alert {{
                background: #800000;
                color: #ffffff;
                padding: 6px 18px;
                margin-left: 12px;
                font-family: 'League Spartan', sans-serif;
                font-size: 13px;
                font-weight: 800;
                letter-spacing: 1.5px;
                display: flex;
                align-items: center;
                gap: 10px;
                border-radius: 6px;
                z-index: 10;
                white-space: nowrap;
            }}

            .alert-blink {{
                height: 10px;
                width: 10px;
                background-color: #ffd700;
                border-radius: 50%;
                animation: pulse-gold 1.2s infinite;
            }}

            @keyframes pulse-gold {{
                0% {{ transform: scale(0.8); opacity: 0.5; }}
                50% {{ transform: scale(1.1); opacity: 1; }}
                100% {{ transform: scale(0.8); opacity: 0.5; }}
            }}

            .scroller-window {{
                flex: 1;
                overflow: hidden;
                white-space: nowrap;
                padding: 0 25px;
            }}

            .scroller-text {{
                display: inline-block;
                padding-left: 100%;
                /* Speed slowed down to 50s for better readability */
                animation: marquee-vibrant 50s linear infinite;
                color: #1e293b;
                font-family: 'League Spartan', sans-serif;
                font-size: 20px;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }}

            @keyframes marquee-vibrant {{
                0% {{ transform: translateX(0); }}
                100% {{ transform: translateX(-100%); }}
            }}

            .scroller-text:hover {{
                animation-play-state: paused;
                color: #800000;
            }}
            </style>

            <div class="aps-vibrant-ticker">
                <div class="vibrant-alert">
                    <div class="alert-blink"></div> LATEST UPDATES
                </div>
                <div class="scroller-window">
                    <div class="scroller-text">
                        {ticker_text} &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ‚òÖ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {ticker_text}
                    </div>
                </div>
            </div>
            """, unsafe_allow_html=True)
    except Exception:
        pass

--- FILE: /home/sami/sumyaman/apsokara/logic/class_teacher_modules.py ---

import streamlit as st
import pandas as pd
import sqlite3

def render_leave_approvals(u):
    u_class, u_wing = u.get('class'), u.get('wing')
    
    st.markdown("""
        <style>
        .request-card {
            background: white !important;
            border-radius: 18px !important;
            padding: 20px !important;
            border: 1px solid #DDD6FE !important;
            border-left: 10px solid #7C3AED !important;
            margin-bottom: 20px !important;
        }
        .search-box {
            background: #F5F3FF !important;
            padding: 20px !important;
            border-radius: 20px !important;
            border: 1px solid #C4B5FD !important;
        }
        </style>
    """, unsafe_allow_html=True)

    # SECTION 1: NEW REQUESTS
    st.markdown("<h2 style='color:#1E1B4B;'>üì• New Leave Requests</h2>", unsafe_allow_html=True)
    with sqlite3.connect("db.sqlite3", timeout=30) as conn:
        pending = pd.read_sql("SELECT * FROM apsokara_studentleave WHERE class=? AND wing=? AND status='Pending'", conn, params=(u_class, u_wing))
    
    if pending.empty:
        st.success("No pending requests today!")
    else:
        for _, r in pending.iterrows():
            st.markdown(f"""<div class="request-card">
                <b style="font-size:18px;">{r['name']}</b> (Roll: {r['student_id']})<br>
                <span style="color:#7C3AED; font-weight:bold;">{r['from_date']} to {r['to_date']}</span>
                <p style="background:#F8FAFC; padding:10px; border-radius:10px; margin-top:10px;">Reason: {r['reason']}</p>
            </div>""", unsafe_allow_html=True)
            c1, c2, _ = st.columns([1,1,2])
            if c1.button("Approve ‚úÖ", key=f"ap_{r['id']}", use_container_width=True):
                with sqlite3.connect("db.sqlite3", timeout=30) as conn: conn.execute("UPDATE apsokara_studentleave SET status='Approved' WHERE id=?", (r['id'],))
                st.rerun()
            if c2.button("Reject ‚ùå", key=f"rj_{r['id']}", use_container_width=True):
                with sqlite3.connect("db.sqlite3", timeout=30) as conn: conn.execute("UPDATE apsokara_studentleave SET status='Rejected' WHERE id=?", (r['id'],))
                st.rerun()

    st.divider()

    # SECTION 2: CLASS HISTORY & INTEL
    st.markdown("<h2 style='color:#1E1B4B;'>üèõÔ∏è Class Leave History & Search</h2>", unsafe_allow_html=True)
    st.markdown('<div class="search-box">', unsafe_allow_html=True)
    c1, c2 = st.columns(2)
    s_name = c1.text_input("Search Student Name")
    s_date = c2.date_input("Search by Date", value=None)
    st.markdown('</div>', unsafe_allow_html=True)

    query = "SELECT name, from_date, to_date, status, reason FROM apsokara_studentleave WHERE class=? AND wing=?"
    params = [u_class, u_wing]
    if s_name: query += " AND name LIKE ?"; params.append(f"%{s_name}%")
    if s_date: query += " AND ? BETWEEN from_date AND to_date"; params.append(s_date.isoformat())

    with sqlite3.connect("db.sqlite3", timeout=30) as conn:
        hist = pd.read_sql(query + " ORDER BY id DESC", conn, params=params)
    
    if not hist.empty:
        st.markdown("<br>", unsafe_allow_html=True)
        st.dataframe(hist, use_container_width=True, hide_index=True)
    else:
        st.info("No records found in history.")

def render_final_upload(u):
    st.title("Final Uploads")

--- FILE: /home/sami/sumyaman/apsokara/logic/teacher_modules.py ---

import streamlit as st
import pandas as pd
from db_bridge import fetch_df, execute, get_active_exam_for_class

def render_marks_entry(u):
    st.title("üéØ Mark Entry Portal")
    user_id = u.get('id', 1)
    
    # 1. Assignment Selection
    query = """
        SELECT sa.id, s.name, sa.class_name, sa.section, sa.wing, sa.total_marks, sa.submission_status 
        FROM apsokara_subjectassignment sa 
        JOIN apsokara_subject s ON sa.subject_id = s.id 
        WHERE sa.teacher_id = ?
    """
    assignments = fetch_df(query, (user_id,))
    
    if assignments.empty:
        st.warning("No assignments found.")
        return

    options = [f"{r['class_name']}-{r['section']} ({r['name']}) - {r['wing']}" for _, r in assignments.iterrows()]
    selected_label = st.selectbox("Select Class-Subject", options)
    
    # Finding matching assignment
    asg = assignments.iloc[options.index(selected_label)]

    exam = get_active_exam_for_class(asg['class_name'])
    if not exam: return st.error("No active exam found.")

    # Check Lock Status
    lock_check = fetch_df("SELECT is_locked FROM apsokara_classresultstatus WHERE class_name=? AND section=? AND wing=? AND exam_window_id=?", 
                          (asg['class_name'], asg['section'], asg['wing'], exam['id']))
    is_locked = not lock_check.empty and lock_check.iloc[0]['is_locked'] == 1

    # Header UI
    st.info(f"Exam: {exam['title']} | Status: {asg['submission_status']}")

    if is_locked:
        st.warning("üîí This result has been published and locked. You can only view it.")
    
    # 2. Total Marks Setting
    t_marks = st.number_input("Set Total Marks", value=asg['total_marks'], disabled=is_locked)

    # 3. Marks Table
    students = fetch_df("""
        SELECT s.id, s.roll_no, s.full_name, IFNULL(m.obtained_marks, 0) as marks
        FROM apsokara_student s
        LEFT JOIN apsokara_mark m ON s.id = m.student_id AND m.subject_assignment_id = ?
        WHERE s.student_class=? AND s.student_section=? AND s.wing=?
    """, (asg['id'], asg['class_name'], asg['section'], asg['wing']))

    # --- FIX START ---
    # Agar is_locked True hai, to hum poore columns ki list ko 'disabled' parameter mein bhejenge
    disabled_cols = ["id", "roll_no", "full_name", "marks"] if is_locked else ["id", "roll_no", "full_name"]
    # --- FIX END ---

    edited_df = st.data_editor(
        students, 
        column_config={"id": None}, 
        disabled=disabled_cols, # Ab list ja rahi hai, error nahi aayega
        use_container_width=True, 
        hide_index=True
    )

    if not is_locked:
        c1, c2 = st.columns(2)
        if c1.button("üíæ Save Progress"):
            for _, row in edited_df.iterrows():
                execute("""
                    INSERT INTO apsokara_mark (student_id, subject_assignment_id, obtained_marks, total_marks, exam_type, date_uploaded) 
                    VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP) 
                    ON CONFLICT(student_id, subject_assignment_id) DO UPDATE SET obtained_marks=excluded.obtained_marks
                """, (row['id'], asg['id'], row['marks'], t_marks, exam['title']))
            st.toast("Saved!")

        if c2.button("üöÄ SUBMIT SHEET", type="primary"):
            execute("UPDATE apsokara_subjectassignment SET submission_status='Submitted', total_marks=? WHERE id=?", (t_marks, asg['id']))
            st.success("Submitted to Class Teacher!")
            st.rerun()

--- FILE: /home/sami/sumyaman/apsokara/logic/student_modules.py ---

import streamlit as st
import sqlite3
import pandas as pd
from datetime import date

def render_apply_leave(u):
    st.markdown("""
        <style>
        .premium-card {
            background: rgba(255, 255, 255, 0.9) !important;
            border-radius: 20px !important;
            padding: 25px !important;
            border: 1px solid #E9D5FF !important;
            box-shadow: 0 10px 30px rgba(124, 58, 237, 0.1) !important;
            margin-bottom: 25px !important;
        }
        .history-item {
            background: white !important;
            border-radius: 15px !important;
            padding: 15px !important;
            margin-bottom: 10px !important;
            border-left: 5px solid #7C3AED !important;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02) !important;
        }
        .status-badge {
            float: right;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        </style>
    """, unsafe_allow_html=True)

    # 1. APPLICATION FORM
    st.markdown('<div class="premium-card">', unsafe_allow_html=True)
    st.markdown("<h2 style='color:#1E1B4B; margin:0;'>üìù Apply for Leave</h2>", unsafe_allow_html=True)
    with st.form("new_leave_form", border=False):
        c1, c2 = st.columns(2)
        start = c1.date_input("From Date", date.today())
        end = c2.date_input("To Date", date.today())
        reason = st.text_area("Reason for Leave")
        if st.form_submit_button("üöÄ Submit Request", use_container_width=True):
            if reason.strip():
                with sqlite3.connect("db.sqlite3", timeout=30) as conn:
                    conn.execute("INSERT INTO apsokara_studentleave (student_id, name, class, section, wing, reason, from_date, to_date, status) VALUES (?,?,?,?,?,?,?,?,?)", 
                                 (u['id_num'], u.get('full_name', u.get('name')), u['class'], u.get('sec', u.get('section', '')), u.get('wing',''), reason, str(start), str(end), 'Pending'))
                st.success("Application Sent!")
                st.rerun()
    st.markdown('</div>', unsafe_allow_html=True)

    # 2. PERSONAL HISTORY (Always Visible)
    st.markdown("<h3 style='color:#4C1D95;'>üìú My Leave History</h3>", unsafe_allow_html=True)
    with sqlite3.connect("db.sqlite3", timeout=30) as conn:
        df = pd.read_sql("SELECT * FROM apsokara_studentleave WHERE student_id=? ORDER BY id DESC", conn, params=(u['id_num'],))
    
    if df.empty:
        st.info("No previous leaves found.")
    else:
        for _, r in df.iterrows():
            color = "#D97706" if r['status'] == "Pending" else ("#16A34A" if r['status'] == "Approved" else "#DC2626")
            st.markdown(f"""
                <div class="history-item">
                    <span class="status-badge" style="background:{color}22; color:{color};">{r['status']}</span>
                    <b style="color:#1E1B4B;">{r['reason']}</b><br>
                    <small style="color:#64748B;">Duration: {r['from_date']} to {r['to_date']}</small>
                </div>
            """, unsafe_allow_html=True)

def render_my_result(u):
    st.title("My Results")

--- FILE: /home/sami/sumyaman/apsokara/logic/attendance_logic.py ---

from leave_utils import check_on_leave
import sqlite3
import pandas as pd
import streamlit as st
from datetime import datetime
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
import io

def generate_pdf(name, std_id, df):
    buffer = io.BytesIO()
    p = canvas.Canvas(buffer, pagesize=letter)
    p.setFont("Helvetica-Bold", 20)
    p.setFillColorRGB(0.8, 0, 0)
    p.drawString(100, 750, "STUDENT ATTENDANCE REPORT")
    p.setFont("Helvetica-Bold", 12)
    p.setFillColorRGB(0, 0, 0)
    p.drawString(100, 725, f"Name: {name}")
    p.drawString(100, 710, f"Student ID: {std_id}")
    p.drawString(400, 710, f"Generated: {datetime.now().strftime('%Y-%m-%d')}")
    p.line(100, 700, 500, 700)
    y = 670
    p.setFont("Helvetica-Bold", 12)
    p.drawString(100, y, "DATE")
    p.drawString(300, y, "STATUS")
    p.setFont("Helvetica", 11)
    for index, row in df.iterrows():
        y -= 20
        p.drawString(100, y, str(row['date']))
        p.drawString(300, y, str(row['status']))
        if y < 100:
            p.showPage()
            y = 750
    p.showPage()
    p.save()
    buffer.seek(0)
    return buffer

def render_student_attendance(u):
    conn = sqlite3.connect("db.sqlite3", timeout=30)
    # Using 'id' because database has 1, 5, 7, 8
    std_id = u.get('b_form', u.get('id', u.get('id_num')))
    std_name = u.get("name", "Student")

    # Correct Query for your DB format
    query = """
        SELECT a.date, a.status 
        FROM apsokara_attendance a 
        WHERE a.student_id = (SELECT id FROM apsokara_student WHERE id=? OR b_form=?) 
        AND a.edit_count = (SELECT MAX(edit_count) FROM apsokara_attendance WHERE student_id=a.student_id AND date=a.date) 
        ORDER BY a.date DESC
    """
    df = pd.read_sql(query, conn, params=(str(std_id), str(std_id)))

    if df.empty:
        st.error(f"No Records Found for ID: {std_id}"); conn.close(); return

    total = len(df)
    p_count = len(df[df['status'].str.contains('Present|^P$', case=False, na=False)])
    a_count = len(df[df['status'].str.contains('Absent|^A$', case=False, na=False)])
    l_count = len(df[df['status'].str.contains('Leave|^L$', case=False, na=False)])
    rate = round((p_count/total)*100, 1) if total > 0 else 0

    st.markdown("""
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        .main { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #fcfcfc; }
        .aesthetic-card {
            background: #ffffff; padding: 22px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.03); 
            border-left: 5px solid #FF3B30; border-bottom: 5px solid #FF3B30;
            transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .aesthetic-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(255, 59, 48, 0.15); }
        .custom-card {
            background: #ffffff; border: 1px solid #f1f5f9; border-radius: 28px;
            padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.02); height: 100%;
        }
        div.stDownloadButton > button {
            background: linear-gradient(135deg, #FF3B30 0%, #B81D13 100%) !important;
            color: white !important; border: none !important; padding: 20px 24px !important;
            border-radius: 18px !important; font-weight: 800 !important; width: 100% !important;
            transition: all 0.3s ease !important; box-shadow: 0 10px 20px rgba(255, 59, 48, 0.3) !important;
            text-transform: uppercase; letter-spacing: 1px;
        }
    </style>
    """, unsafe_allow_html=True)

    st.markdown(f"""
    <div style="background: linear-gradient(135deg, #FF3B30 0%, #B81D13 100%); padding: 40px; border-radius: 30px; color: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(255, 59, 48, 0.2);">
        <div><h1 style="margin:0; font-size:36px; letter-spacing:-1px;">{std_name}</h1><p style="opacity:0.8; font-weight:600;">PORTAL ID: {std_id} ‚Ä¢ STATUS: ACTIVE</p></div>
        <div style="text-align:right;"><small style="font-weight:800; opacity:0.7;">ATTENDANCE</small><div style="font-size: 60px; font-weight: 900; line-height:1;">{rate}%</div></div>
    </div>
    """, unsafe_allow_html=True)

    c1, c2, c3, c4 = st.columns(4)
    stats = [("TOTAL", total, "#1E293B"), ("PRESENT", p_count, "#28a745"), ("ABSENT", a_count, "#FF3B30"), ("LEAVE", l_count, "#FF9500")]
    for col, (label, val, color) in zip([c1, c2, c3, c4], stats):
        col.markdown(f'<div class="aesthetic-card" style="border-left-color:{color}; border-bottom-color:{color};"><small style="color:#94A3B8; font-weight:800;">{label}</small><h2 style="color:{color}; margin:5px 0 0 0; font-size:34px;">{val}</h2></div>', unsafe_allow_html=True)

    col_l, col_r = st.columns([1.6, 1], gap="large")
    with col_l:
        st.markdown('<div class="custom-card"><h3 style="margin:0 0 20px 0; font-weight:800; font-size:22px;">Recent History</h3>', unsafe_allow_html=True)
        for _, row in df.head(5).iterrows():
            st.markdown(f'<div style="display:flex;justify-content:space-between;padding:15px 0;border-bottom:1px solid #f8fafc;"><span style="font-weight:600; color:#444;">{row["date"]}</span><span style="color:#FF3B30;font-weight:900;">{row["status"]}</span></div>', unsafe_allow_html=True)
        st.write("")
        pdf_file = generate_pdf(std_name, std_id, df)
        st.download_button(label="üì• Download Full Report", data=pdf_file, file_name=f"{std_name}_Attendance.pdf", mime="application/pdf")
        st.markdown('</div>', unsafe_allow_html=True)

    with col_r:
        st.markdown('<div class="custom-card"><h3 style="margin:0; font-weight:800; font-size:22px;">Date Search</h3><p style="color:#94A3B8; font-size:13px; margin-bottom:20px;">Check past records</p>', unsafe_allow_html=True)
        s_date = st.date_input("Search", label_visibility="collapsed")
        match = df[df['date'] == s_date.isoformat()]
        if not match.empty:
            st.markdown(f"""
            <div style="background:rgba(255,59,48,0.05); border:2px dashed #FF3B30; border-radius:20px; padding:25px; text-align:center; margin-top:15px;">
                <small style="color:#666; font-weight:800;">VERIFIED STATUS</small>
                <h1 style="color:#FF3B30; margin:10px 0 0 0; font-size:42px; font-weight:900;">{match.iloc[0]['status']}</h1>
            </div>""", unsafe_allow_html=True)
        else:
            st.markdown('<div style="background:#f8fafc; border-radius:20px; padding:25px; text-align:center; margin-top:15px; color:#999;">No Record Found</div>', unsafe_allow_html=True)
        st.markdown('</div>', unsafe_allow_html=True)
    conn.close()

--- FILE: /home/sami/sumyaman/apsokara/__init__.py ---


--- FILE: /home/sami/sumyaman/apsokara/migrations/0006_remove_schoolnews_target_role.py ---

# Generated by Django 6.0.1 on 2026-01-31 08:50

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('apsokara', '0005_alter_schoolnews_target_role'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='schoolnews',
            name='target_role',
        ),
    ]

--- FILE: /home/sami/sumyaman/apsokara/migrations/__init__.py ---


--- FILE: /home/sami/sumyaman/apsokara/migrations/0001_initial.py ---

# Generated by Django 6.0.1 on 2026-01-30 13:24

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Student',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('full_name', models.CharField(max_length=100)),
                ('father_name', models.CharField(max_length=100)),
                ('b_form', models.CharField(max_length=20, unique=True, verbose_name='B-Form Number')),
                ('dob', models.DateField(verbose_name='Date of Birth')),
                ('student_class', models.CharField(max_length=10)),
                ('student_section', models.CharField(max_length=10)),
                ('wing', models.CharField(choices=[('Boys', 'Boys'), ('Girls', 'Girls')], max_length=10)),
                ('roll_number', models.CharField(max_length=20, unique=True)),
                ('nationality', models.CharField(default='Pakistani', max_length=50)),
                ('province', models.CharField(choices=[('Punjab', 'Punjab'), ('Sindh', 'Sindh'), ('KPK', 'KPK'), ('Balochistan', 'Balochistan'), ('Gilgit', 'Gilgit'), ('AJK', 'AJK')], default='Punjab', max_length=20)),
                ('religion', models.CharField(choices=[('Islam', 'Islam'), ('Christianity', 'Christianity'), ('Other', 'Other')], default='Islam', max_length=20)),
                ('parents_phone', models.CharField(max_length=15)),
                ('address', models.TextField()),
            ],
        ),
        migrations.CreateModel(
            name='Subject',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True, verbose_name='Subject Name')),
            ],
        ),
        migrations.CreateModel(
            name='Teacher',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('full_name', models.CharField(max_length=100)),
                ('father_name', models.CharField(max_length=100)),
                ('cnic', models.CharField(max_length=15, unique=True)),
                ('dob', models.DateField(verbose_name='Date of Birth')),
                ('religion', models.CharField(choices=[('Islam', 'Islam'), ('Christianity', 'Christianity'), ('Other', 'Other')], default='Islam', max_length=20)),
                ('contact', models.CharField(max_length=15)),
                ('address', models.TextField()),
                ('is_class_teacher', models.BooleanField(default=False)),
                ('assigned_class', models.CharField(blank=True, max_length=10, null=True)),
                ('assigned_section', models.CharField(blank=True, max_length=10, null=True)),
                ('assigned_wing', models.CharField(choices=[('None', 'None'), ('Boys', 'Boys'), ('Girls', 'Girls')], default='None', max_length=10)),
            ],
        ),
        migrations.CreateModel(
            name='Attendance',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('date', models.DateField(default=django.utils.timezone.now)),
                ('status', models.CharField(max_length=10)),
                ('student', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='apsokara.student')),
            ],
        ),
        migrations.CreateModel(
            name='StudentLeave',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('from_date', models.DateField()),
                ('to_date', models.DateField()),
                ('student', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='apsokara.student')),
            ],
        ),
        migrations.CreateModel(
            name='SubjectAssignment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('student_class', models.CharField(max_length=10)),
                ('section', models.CharField(max_length=10)),
                ('wing', models.CharField(choices=[('Boys', 'Boys'), ('Girls', 'Girls')], max_length=10)),
                ('subject', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='apsokara.subject')),
                ('teacher', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='assignments', to='apsokara.teacher')),
            ],
            options={
                'unique_together': {('subject', 'student_class', 'section', 'wing')},
            },
        ),
    ]

--- FILE: /home/sami/sumyaman/apsokara/migrations/0005_alter_schoolnews_target_role.py ---

# Generated by Django 6.0.1 on 2026-01-31 08:23

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('apsokara', '0004_schoolnews_target_role'),
    ]

    operations = [
        migrations.AlterField(
            model_name='schoolnews',
            name='target_role',
            field=models.CharField(default='All', max_length=50),
        ),
    ]

--- FILE: /home/sami/sumyaman/apsokara/migrations/0004_schoolnews_target_role.py ---

# Generated by Django 6.0.1 on 2026-01-31 08:17

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('apsokara', '0003_alter_schoolnews_content'),
    ]

    operations = [
        migrations.AddField(
            model_name='schoolnews',
            name='target_role',
            field=models.CharField(choices=[('All', 'All'), ('Student', 'Student'), ('Class Teacher', 'Class Teacher'), ('Subject Teacher', 'Subject Teacher')], default='All', max_length=50),
        ),
    ]

--- FILE: /home/sami/sumyaman/apsokara/migrations/0007_schoolnews_target_role.py ---

# Generated by Django 6.0.1 on 2026-01-31 09:00

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('apsokara', '0006_remove_schoolnews_target_role'),
    ]

    operations = [
        migrations.AddField(
            model_name='schoolnews',
            name='target_role',
            field=models.CharField(default='All', max_length=50),
        ),
    ]

--- FILE: /home/sami/sumyaman/apsokara/migrations/0002_schoolnews_attendance_marked_by.py ---

# Generated by Django 6.0.1 on 2026-01-30 15:41

import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('apsokara', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='SchoolNews',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('content', models.TextField(verbose_name='News Content')),
                ('start_date', models.DateField(default=django.utils.timezone.now)),
                ('end_date', models.DateField()),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
        ),
        migrations.AddField(
            model_name='attendance',
            name='marked_by',
            field=models.TextField(default='Unknown'),
        ),
    ]

--- FILE: /home/sami/sumyaman/apsokara/migrations/0003_alter_schoolnews_content.py ---

# Generated by Django 6.0.1 on 2026-01-30 15:52

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('apsokara', '0002_schoolnews_attendance_marked_by'),
    ]

    operations = [
        migrations.AlterField(
            model_name='schoolnews',
            name='content',
            field=models.TextField(),
        ),
    ]

--- FILE: /home/sami/sumyaman/apsokara/student_views.py ---

from django.shortcuts import render, get_object_or_404
from .models import Student, Attendance

def student_profile_view(request, student_id):
    student = get_object_or_404(Student, id=student_id)
    attendance_history = Attendance.objects.filter(student=student).order_by('-date')
    
    
    from .models import SchoolNews
    from django.utils import timezone
    from django.db.models import Q
    today = timezone.now().date()
    # Strict Audience Filter: Role matching + Date Validity
    news = SchoolNews.objects.filter(
        Q(target_role='All') | Q(target_role='Student'),
        start_date__lte=today,
        end_date__gte=today
    ).order_by('-created_at')
    
    context = { 'news': news, 
        'student': student,
        'attendance_history': attendance_history,
        'c_name': student.student_class,
        's_name': student.student_section,
        'w_name': student.wing,
        'p_phone': student.parents_phone,
        'dob': student.dob,
    }
    
    today = timezone.now().date()
    from .models import SchoolNews
    from django.db.models import Q
    news = SchoolNews.objects.filter(
        Q(target_role='All') | Q(target_role='Student'),
        start_date__lte=today,
        end_date__gte=today
    ).order_by('-created_at')
    
    return render(request, 'hq_admin_custom/student_profile.html', context)

--- FILE: /home/sami/sumyaman/apsokara/views_new.py ---

from django.shortcuts import render, get_object_or_404
from django.contrib.auth.decorators import login_required
from .models import Student, Teacher, Attendance
from django.utils import timezone

# ... (baaki views wahi rahengle, hum sirf profile view update kar rahe hain)

--- FILE: /home/sami/sumyaman/apsokara/views.py ---

from django.core.paginator import Paginator
from django.shortcuts import render, redirect, get_object_or_404
from django.contrib.auth.decorators import login_required
from django.utils import timezone
from .models import Student, Teacher, Attendance, SchoolNews
from django.db.models import Count, Q

@login_required
def hq_dashboard(request):
    return render(request, 'hq_admin_custom/dashboard.html', {
        'total_students': Student.objects.count(),
        'boys': Student.objects.filter(wing__iexact='Boys').count(),
        'girls': Student.objects.filter(wing__iexact='Girls').count(),
        'faculty_count': Teacher.objects.count(),
    })

@login_required
def attendance_view(request):
    date_str = request.GET.get('date', timezone.now().date().strftime('%Y-%m-%d'))
    try:
        target_date = timezone.datetime.strptime(date_str, '%Y-%m-%d').date()
    except:
        target_date = timezone.now().date()
    p = Attendance.objects.filter(date=target_date, status__iexact='Present').count()
    a = Attendance.objects.filter(date=target_date, status__iexact='Absent').count()
    l = Attendance.objects.filter(date=target_date, status__iexact='Leave').count()
    classes_data = Student.objects.values('student_class', 'student_section', 'wing').annotate(total=Count('id')).order_by('student_class', 'student_section')
    return render(request, 'hq_admin_custom/attendance.html', {
        'classes': classes_data, 'today_date': target_date, 
        'present': p, 'absent': a, 'leave': l, 'total_students': Student.objects.count()
    })

@login_required
def mark_attendance_view(request, class_name, section_name, wing_name):
    if not request.user.is_superuser:
        try:
            teacher = request.user.teacher
            if teacher.assigned_class != class_name or teacher.assigned_section != section_name:
                from django.core.exceptions import PermissionDenied; raise PermissionDenied()
        except:
            from django.core.exceptions import PermissionDenied; raise PermissionDenied()
    today = timezone.now().date()
    students = Student.objects.filter(student_class=class_name, student_section=section_name, wing__iexact=wing_name)
    attendance_data = []
    for s in students:
        record = Attendance.objects.filter(student=s, date=today).first()
        if record: attendance_data.append(record)
        else: attendance_data.append({'student': s, 'status': 'Not Marked'})
    return render(request, 'hq_admin_custom/classroom_detail.html', {
        'attendance_data': attendance_data, 'class_name': class_name, 'section_name': section_name,
        'present': Attendance.objects.filter(student__in=students, date=today, status__iexact='Present').count(),
        'absent': Attendance.objects.filter(student__in=students, date=today, status__iexact='Absent').count(),
        'leave': Attendance.objects.filter(student__in=students, date=today, status__iexact='Leave').count(),
        'total_count': students.count(), 'today_date': today
    })

@login_required
def boys_wing_view(request):
    today = timezone.now().date()
    students = Student.objects.filter(wing__iexact='Boys')
    return render(request, 'hq_admin_custom/wing_detail.html', {
        'wing_title': 'BOYS WING HQ', 'wing_slug': 'Boys', 'theme_color': '#1e3a8a',
        'class_sections': students.values('student_class', 'student_section').annotate(total=Count('id')).order_by('student_class'),
        'present': Attendance.objects.filter(date=today, student__wing__iexact='Boys', status__iexact='Present').count(),
        'absent': Attendance.objects.filter(date=today, student__wing__iexact='Boys', status__iexact='Absent').count(),
        'leave': Attendance.objects.filter(date=today, student__wing__iexact='Boys', status__iexact='Leave').count(),
        'total_students': students.count()
    })

@login_required
def girls_wing_view(request):
    today = timezone.now().date()
    students = Student.objects.filter(wing__iexact='Girls')
    return render(request, 'hq_admin_custom/wing_detail.html', {
        'wing_title': 'GIRLS WING HQ', 'wing_slug': 'Girls', 'theme_color': '#701a75',
        'class_sections': students.values('student_class', 'student_section').annotate(total=Count('id')).order_by('student_class'),
        'present': Attendance.objects.filter(date=today, student__wing__iexact='Girls', status__iexact='Present').count(),
        'absent': Attendance.objects.filter(date=today, student__wing__iexact='Girls', status__iexact='Absent').count(),
        'leave': Attendance.objects.filter(date=today, student__wing__iexact='Girls', status__iexact='Leave').count(),
        'total_students': students.count()
    })

@login_required
def student_master_list(request):
    query = request.GET.get('q', '')
    wing_filter = request.GET.get('wing', '')
    class_filter = request.GET.get('class', '')
    students_list = Student.objects.all().order_by('student_class', 'full_name')
    if query: students_list = students_list.filter(Q(full_name__icontains=query) | Q(roll_number__icontains=query))
    if wing_filter: students_list = students_list.filter(wing=wing_filter)
    if class_filter: students_list = students_list.filter(student_class=class_filter)
    paginator = Paginator(students_list, 50)
    page_obj = paginator.get_page(request.GET.get('page'))
    return render(request, 'hq_admin_custom/students_list.html', {
        'page_obj': page_obj, 'wings_list': Student.objects.values_list('wing', flat=True).distinct().order_by('wing'),
        'classes_list': Student.objects.values_list('student_class', flat=True).distinct().order_by('student_class'),
        'selected_wing': wing_filter, 'selected_class': class_filter, 'query': query,
    })

@login_required
def student_profile_view(request, student_id):
    s = get_object_or_404(Student, id=student_id)
    history = Attendance.objects.filter(student=s).order_by('-date')
    t_count = history.count()
    p_count = history.filter(status__iexact='Present').count()
    perc = (p_count / t_count * 100) if t_count > 0 else 0
    return render(request, 'hq_admin_custom/student_profile.html', {
        's': s, 'attendance_history': history, 'present_count': p_count,
        'absent_count': history.filter(status__iexact='Absent').count(),
        'leave_count': history.filter(status__iexact='Leave').count(),
        'total_days': t_count, 'percentage': round(perc, 1),
    })

@login_required
def teacher_profile_view(request, teacher_id):
    t = get_object_or_404(Teacher, id=teacher_id)
    return render(request, 'hq_admin_custom/teacher_profile.html', {'t': t})

@login_required
def teacher_master_list(request):
    return render(request, 'hq_admin_custom/teachers_list.html', {'teachers': Teacher.objects.all()})

@login_required
def global_search(request):
    query = request.GET.get('q', '')
    students = Student.objects.filter(full_name__icontains=query) if query else []
    teachers = Teacher.objects.filter(full_name__icontains=query) if query else []
    return render(request, 'hq_admin_custom/search_results.html', {'students': students, 'teachers': teachers, 'query': query})

# --- NEWS MANAGER START ---
@login_required
@login_required
def news_manager_view(request):
    today = timezone.now().date()
    if request.method == 'POST':
        n_id = request.POST.get('news_id')
        data = {
            'content': request.POST.get('content'),
            'target_role': request.POST.get('target_role'),
            'start_date': request.POST.get('start_date'),
            'end_date': request.POST.get('end_date')
        }
        if n_id: SchoolNews.objects.filter(id=n_id).update(**data)
        else: SchoolNews.objects.create(**data)
        return redirect('news_manager')
    
    # Admin ko sab dikhao taake wo manage kar sake
    active_news = SchoolNews.objects.filter(end_date__gte=today).order_by('-created_at')
    expired_news = SchoolNews.objects.filter(end_date__lt=today).order_by('-end_date')
    return render(request, 'hq_admin_custom/news_manager.html', {'active_news': active_news, 'expired_news': expired_news, 'today': today.strftime('%Y-%m-%d')})
            SchoolNews.objects.create(content=content, target_role=target, start_date=s_date, end_date=e_date)
        return redirect('news_manager')

    # Logic: Sirf wahi jo aaj ke din active hon (Date filter)
    all_n = SchoolNews.objects.all().order_by('-created_at')
    active_news = [n for n in all_n if n.start_date <= today <= n.end_date]
    expired_news = [n for n in all_n if n.end_date < today]

    return render(request, 'hq_admin_custom/news_manager.html', {
        'active_news': active_news,
        'expired_news': expired_news,
        'today': today.strftime('%Y-%m-%d')
    })

    # Date logic: Start date aaj ya purani ho, aur End date aaj ya future ki ho
    active_news = SchoolNews.objects.filter(start_date__lte=today, end_date__gte=today).order_by('-created_at')
    upcoming_news = SchoolNews.objects.filter(start_date__gt=today).order_by('start_date')
    expired_news = SchoolNews.objects.filter(end_date__lt=today).order_by('-end_date')

    return render(request, 'hq_admin_custom/news_manager.html', {
        'active_news': active_news,
        'upcoming_news': upcoming_news,
        'expired_news': expired_news,
        'today': today.strftime('%Y-%m-%d')
    })
def delete_news(request, news_id):
    get_object_or_404(SchoolNews, id=news_id).delete()
    return redirect('news_manager')

--- FILE: /home/sami/sumyaman/apsokara/urls.py ---

from .views import news_manager_view, delete_news
from django.urls import path
from . import views

urlpatterns = [
    path('news-manager/', news_manager_view, name='news_manager'),
    path('news-delete/<int:news_id>/', delete_news, name='delete_news'),
    path('', views.hq_dashboard, name='hq_dashboard'),
    
    # Students
    path('students/', views.student_master_list, name='student_master_list'),
    path('student/profile/<int:student_id>/', views.student_profile_view, name='student_profile'),
    
    # Teachers
    path('teachers/', views.teacher_master_list, name='teacher_master_list'),
    path('teachers/profile/<int:teacher_id>/', views.teacher_profile_view, name='teacher_profile'),
    
    # Attendance & Wings
    path('attendance/', views.attendance_view, name='hq_attendance'),
    path('attendance/boys-wing/', views.boys_wing_view, name='boys_wing'),
    path('attendance/girls-wing/', views.girls_wing_view, name='girls_wing'),
    
    # Ye raha naya rasta jo miss tha:
    path('attendance/mark/<str:class_name>/<str:section_name>/<str:wing_name>/', views.mark_attendance_view, name='mark_attendance'),
    
    # Search
    path('search/', views.global_search, name='global_search'),
]

--- FILE: /home/sami/sumyaman/apsokara/models.py ---

from django.db import models
from django.utils import timezone

class Subject(models.Model):
    name = models.CharField(max_length=100, unique=True, verbose_name="Subject Name")
    def __str__(self):
        return self.name

class Teacher(models.Model):
    WING_CHOICES = [('None', 'None'), ('Boys', 'Boys'), ('Girls', 'Girls')]
    RELIGION_CHOICES = [('Islam', 'Islam'), ('Christianity', 'Christianity'), ('Other', 'Other')]

    full_name = models.CharField(max_length=100)
    father_name = models.CharField(max_length=100)
    cnic = models.CharField(max_length=15, unique=True)
    dob = models.DateField(verbose_name="Date of Birth")
    religion = models.CharField(max_length=20, choices=RELIGION_CHOICES, default='Islam')
    contact = models.CharField(max_length=15)
    address = models.TextField()

    is_class_teacher = models.BooleanField(default=False)
    assigned_class = models.CharField(max_length=10, blank=True, null=True)
    assigned_section = models.CharField(max_length=10, blank=True, null=True)
    assigned_wing = models.CharField(max_length=10, choices=WING_CHOICES, default='None')

    def __str__(self):
        return self.full_name

class Student(models.Model):
    RELIGION_CHOICES = [('Islam', 'Islam'), ('Christianity', 'Christianity'), ('Other', 'Other')]
    PROVINCE_CHOICES = [('Punjab', 'Punjab'), ('Sindh', 'Sindh'), ('KPK', 'KPK'), ('Balochistan', 'Balochistan'), ('Gilgit', 'Gilgit'), ('AJK', 'AJK')]
    WING_CHOICES = [('Boys', 'Boys'), ('Girls', 'Girls')]

    # Basic Info
    full_name = models.CharField(max_length=100)
    father_name = models.CharField(max_length=100)
    b_form = models.CharField(max_length=20, unique=True, verbose_name="B-Form Number")
    dob = models.DateField(verbose_name="Date of Birth")
    
    # Academic Info
    student_class = models.CharField(max_length=10)
    student_section = models.CharField(max_length=10)
    wing = models.CharField(max_length=10, choices=WING_CHOICES)
    roll_number = models.CharField(max_length=20, unique=True)

    # Personal/Address Info
    nationality = models.CharField(max_length=50, default="Pakistani")
    province = models.CharField(max_length=20, choices=PROVINCE_CHOICES, default='Punjab')
    religion = models.CharField(max_length=20, choices=RELIGION_CHOICES, default='Islam')
    parents_phone = models.CharField(max_length=15)
    address = models.TextField()

    def __str__(self):
        return f"{self.full_name} ({self.roll_number})"

class SubjectAssignment(models.Model):
    teacher = models.ForeignKey(Teacher, on_delete=models.CASCADE, related_name='assignments')
    subject = models.ForeignKey(Subject, on_delete=models.CASCADE)
    student_class = models.CharField(max_length=10)
    section = models.CharField(max_length=10)
    wing = models.CharField(max_length=10, choices=[('Boys', 'Boys'), ('Girls', 'Girls')])

    class Meta:
        unique_together = ('subject', 'student_class', 'section', 'wing')

class Attendance(models.Model):
    student = models.ForeignKey(Student, on_delete=models.CASCADE)
    date = models.DateField(default=timezone.now)
    status = models.CharField(max_length=10)
    marked_by = models.TextField(default='Unknown')

class StudentLeave(models.Model):
    student = models.ForeignKey(Student, on_delete=models.CASCADE)
    from_date = models.DateField()
    to_date = models.DateField()

class SchoolNews(models.Model):
    content = models.TextField()
    target_role = models.CharField(max_length=50, default='All')
    target_role = models.CharField(max_length=50, default='All')
    start_date = models.DateField(default=timezone.now)
    end_date = models.DateField()
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self):
        return self.content[:50]

--- FILE: /home/sami/sumyaman/apsokara/admin.py ---

from django.contrib import admin
from .models import Teacher, Subject, SubjectAssignment, Student

@admin.register(Student)
class StudentAdmin(admin.ModelAdmin):
    list_display = ('full_name', 'roll_number', 'student_class', 'student_section', 'wing')
    search_fields = ('full_name', 'roll_number', 'b_form')
    list_filter = ('student_class', 'student_section', 'wing')

    fieldsets = (
        ("Personal Information", {
            'fields': ('full_name', 'father_name', 'b_form', 'dob', 'religion', 'nationality', 'province')
        }),
        ("Academic Details", {
            'fields': ('roll_number', 'student_class', 'student_section', 'wing')
        }),
        ("Contact & Address", {
            'fields': ('parents_phone', 'address')
        }),
    )

@admin.register(Teacher)
class TeacherAdmin(admin.ModelAdmin):
    list_display = ('full_name', 'cnic', 'is_class_teacher')
    inlines = [
        type('SubjectAssignmentInline', (admin.TabularInline,), {'model': SubjectAssignment, 'extra': 1})
    ]
    fieldsets = (
        ("Personal Info", {'fields': ('full_name', 'father_name', 'cnic', 'dob', 'religion', 'contact', 'address')}),
        ("Class Teacher Status", {'fields': ('is_class_teacher', 'assigned_class', 'assigned_section', 'assigned_wing')}),
    )
    class Media:
        js = ('admin/js/teacher_toggle.js',)

@admin.register(Subject)
class SubjectAdmin(admin.ModelAdmin):
    list_display = ('name',)

--- FILE: /home/sami/sumyaman/apsokara/tests.py ---

from django.test import TestCase

# Create your tests here.

--- FILE: /home/sami/sumyaman/apsokara/templates/attendance_dashboard.html ---

<!DOCTYPE html>
<html>
<head><title>Attendance Dashboard</title></head>
<body>
    <h1>Attendance Dashboard</h1>
    <p>Templates restored! Please replace this with your original design if available.</p>
    <ul>
        <li><a href="boys/">Boys Wing</a></li>
        <li><a href="girls/">Girls Wing</a></li>
    </ul>
</body>
</html>

--- FILE: /home/sami/sumyaman/apsokara/apps.py ---

from django.apps import AppConfig


class ApsokaraConfig(AppConfig):
    name = 'apsokara'

--- FILE: /home/sami/sumyaman/apsokara/search_logic.py ---

from django.shortcuts import render
from .models import Student, Teacher
from django.db.models import Q

def global_search(request):
    query = request.GET.get('q', '').strip()
    student_results = []
    teacher_results = []
    module_results = []

    if query:
        # 1. Search Students (Name or CNIC)
        student_results = Student.objects.filter(
            Q(full_name__icontains=query) | Q(cnic__icontains=query)
        )[:10]

        # 2. Search Teachers (Name or CNIC)
        teacher_results = Teacher.objects.filter(
            Q(full_name__icontains=query) | Q(cnic__icontains=query)
        )[:10]

        # 3. Smart Module Search (Static links)
        modules = [
            {'name': 'Attendance HQ Portal', 'url': '/hq-portal/attendance/', 'tags': 'mark attendance record'},
            {'name': 'Boys Wing Section', 'url': '/hq-portal/attendance/boys-wing/', 'tags': 'boys male wing'},
            {'name': 'Girls Wing Section', 'url': '/hq-portal/attendance/girls-wing/', 'tags': 'girls female wing'},
            {'name': 'Main Dashboard', 'url': '/hq-portal/', 'tags': 'home dashboard stats'},
        ]
        module_results = [m for m in modules if query.lower() in m['name'].lower() or query.lower() in m['tags']]

    context = {
        'query': query,
        'students': student_results,
        'teachers': teacher_results,
        'modules': module_results,
        'total_found': len(student_results) + len(teacher_results) + len(module_results)
    }
    return render(request, 'hq_admin_custom/search_results.html', context)

--- FILE: /home/sami/sumyaman/apsokara/dashboard_views.py ---

from django.shortcuts import render
from .models import Student, Attendance
from django.contrib.auth.models import User
from datetime import date

def hq_dashboard(request):
    today = date.today()
    
    # Real data from Database
    total_students = Student.objects.count()
    faculty_count = User.objects.count()
    
    # Today's attendance filter
    today_att = Attendance.objects.filter(date=today)
    present = today_att.filter(status__iexact='PRESENT').count()
    
    # Calculate real percentage
    perc = round((present / total_students * 100), 1) if total_students > 0 else 0
    
    # Get last 5 real attendance entries for the table
    recent_activity = Attendance.objects.select_related('student').order_by('-id')[:5]
    
    # Real Wing counts
    boys_count = Student.objects.filter(wing__iexact='BOYS').count()
    girls_count = Student.objects.filter(wing__iexact='GIRLS').count()

    
    today = timezone.now().date()
    from .models import SchoolNews
    from django.db.models import Q
    user_role = 'All'
    if hasattr(request.user, 'teacher'):
        user_role = request.user.teacher.role # Assuming role field exists
    
    news = SchoolNews.objects.filter(
        Q(target_role='All') | Q(target_role=user_role) | Q(target_role__icontains='Teacher'),
        start_date__lte=today,
        end_date__gte=today
    ).order_by('-created_at')
    
    
    from .models import SchoolNews
    from django.utils import timezone
    from django.db.models import Q
    today = timezone.now().date()
    # Strict Audience Filter: Role matching + Date Validity
    news = SchoolNews.objects.filter(
        Q(target_role='All') | Q(target_role='Class Teacher'),
        start_date__lte=today,
        end_date__gte=today
    ).order_by('-created_at')
    
    context = { 'news': news,  'news': news, 
        'total': total_students,
        'faculty_count': faculty_count,
        'present': present,
        'perc': perc,
        'recent_activity': recent_activity,
        'boys': boys_count,
        'girls': girls_count,
        'today': today,
    }
    return render(request, 'hq_admin_custom/dashboard.html', context)

--- FILE: /home/sami/sumyaman/apsokara/services/__init__.py ---


--- FILE: /home/sami/sumyaman/apsokara/services/exam_metrics.py ---



--- FILE: /home/sami/sumyaman/apsokara/services/analytics.py ---



--- FILE: /home/sami/sumyaman/apsokara/services/integrity_checks.py ---



--- FILE: /home/sami/sumyaman/apsokara/services/lifecycle.py ---


--- FILE: /home/sami/sumyaman/apsokara/services/hierarchy.py ---

from ..models import Student

class HierarchyService:
    @staticmethod
    def build():
        # Dinamic hierarchy based on existing students
        tree = {}
        wings = Student.objects.values_list('wing', flat=True).distinct()
        for wing in wings:
            tree[wing] = {}
            classes = Student.objects.filter(wing=wing).values_list('student_class', flat=True).distinct().order_by('student_class')
            for cls in classes:
                sections = Student.objects.filter(wing=wing, student_class=cls).values_list('student_section', flat=True).distinct()
                tree[wing][cls] = list(sections)
        return tree

--- FILE: /home/sami/sumyaman/apsokara/teacher_views.py ---

from django.shortcuts import render, get_object_or_404
from django.contrib.auth.decorators import login_required
from .models import Teacher
from django.db.models import Q

@login_required
def teacher_master_list(request):
    query = request.GET.get('q', '').strip()
    teachers = Teacher.objects.all().order_by('full_name')
    
    if query:
        teachers = teachers.filter(
            Q(full_name__icontains=query) | 
            Q(employee_id__icontains=query) | 
            Q(phone_number__icontains=query)
        )
    
    return render(request, 'hq_admin_custom/teachers_list.html', {
        'teachers': teachers,
        'query': query,
        'total_count': teachers.count()
    })

@login_required
def teacher_profile_view(request, teacher_id):
    teacher = get_object_or_404(Teacher, id=teacher_id)
    return render(request, 'hq_admin_custom/teacher_profile.html', {'t': teacher})

--- FILE: /home/sami/sumyaman/fixes/fix_queries.py ---

import re

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Galat column names ko sahi karna
content = content.replace('father_full_full_name', 'father_name')
content = content.replace('full_full_name', 'full_name')

# SQL Queries ko update karna taake wo naye models se match karein
content = re.sub(r'SELECT \* FROM apsokara_teacher WHERE .*', 'SELECT * FROM apsokara_teacher WHERE cnic = ? AND dob = ?"', content)
content = re.sub(r'SELECT \* FROM apsokara_student WHERE .*', 'SELECT * FROM apsokara_student WHERE b_form = ? AND dob = ?"', content)

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/bring_attendance_back.py ---

import re

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# 1. Query mein is_class_teacher shamil karna
old_q = 'q = "SELECT id, full_name, assigned_wing as wing, assigned_class as class, assigned_section as section FROM apsokara_teacher WHERE cnic = ? AND dob = ?"'
new_q = 'q = "SELECT id, full_name, assigned_wing as wing, assigned_class as class, assigned_section as section, is_class_teacher FROM apsokara_teacher WHERE cnic = ? AND dob = ?"'
content = content.replace(old_q, new_q)

# 2. Variable mapping: Agar is_class_teacher 1 hai to True set karo
content = content.replace("data['role_db'] = user_type", "data['role_db'] = user_type\n            data['is_class_teacher'] = row['is_class_teacher']")

with open(file_path, 'w') as f:
    f.write(content)

print("‚úÖ Attendance logic restored!")

--- FILE: /home/sami/sumyaman/fixes/fix_attendance_final.py ---

import re

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

new_lines = []
counter = 0
for line in lines:
    if 'st.radio' in line and 'key=f"final_s_' in line:
        # Har radio button ko ek unique counter number de rahe hain
        # Taki duplicate ka koi sawal hi paida na ho
        new_line = re.sub(r'key=f"final_s_.*?_today}"', f'key=f"final_s_{{s[\'id\']}}_{{today}}_{{counter}}"', line)
        new_lines.append(f"        counter += 1\n") # Loop ke andar counter barhayen
        new_lines.append(new_line)
    else:
        new_lines.append(line)

# File ke shuru mein counter initialize karna zaroori hai
final_content = "".join(new_lines)
if "counter = 0" not in final_content:
    final_content = final_content.replace("def render_attendance_system", "def render_attendance_system(user_info):\n    counter = 0")

with open(file_path, 'w') as f:
    f.write(final_content)

print("‚úÖ Logic rewritten with an auto-increment counter for keys!")

--- FILE: /home/sami/sumyaman/fixes/fix_leave_timestamp.py ---

import re

file_path = '/home/sami/sumyaman/leave_apply.py'
with open(file_path, 'r') as f:
    content = f.read()

# Import datetime agar missing hai
if 'from datetime import datetime' not in content:
    content = "from datetime import datetime\n" + content

# Query fix: applied_on column aur ? placeholder add karna
old_query = 'INSERT INTO apsokara_studentleave (student_id, class, section, wing, reason, from_date, to_date, status) VALUES (?,?,?,?,?,?,?,?)'
new_query = 'INSERT INTO apsokara_studentleave (student_id, class, section, wing, reason, from_date, to_date, status, applied_on) VALUES (?,?,?,?,?,?,?,?,?)'

content = content.replace(old_query, new_query)

# Values fix: datetime.now() add karna
old_vals = "(u.get('id'), u.get('class'), u.get('sec'), u.get('wing'), reason, str(start), str(end), 'Pending')"
new_vals = "(u.get('id'), u.get('class'), u.get('sec'), u.get('wing'), reason, str(start), str(end), 'Pending', datetime.now())"

content = content.replace(old_vals, new_vals)

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/inject_attendance_logic.py ---

import re

file_path = '/home/sami/sumyaman/apsokara/logic/attendance_logic.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

# Import statement add karna (top par)
if "from main_app import check_on_leave" not in "".join(lines):
    lines.insert(0, "from main_app import check_on_leave\n")

new_content = "".join(lines)

# Radio button ka logic dhoondna aur replace karna
# Hum assume kar rahe hain ke wahan st.radio use ho raha hai P, A, L ke sath
old_radio = r"st\.radio\(.*?,.*?\['P', 'A', 'L'\].*?\)"
# Yahan hum bache ki ID (sid) use kar ke index set karenge
new_radio = "st.radio('Status', ['P', 'A', 'L'], index=2 if check_on_leave(row['student_id']) else 0, key=f'att_{row[\"student_id\"]}')"

# Agar code mein loop 'row' ya 'r' use kar raha hai, uske mutabiq handle karein
new_content = re.sub(r"st\.radio\(.*?\['P', 'A', 'L'\],.*?index=0.*?\)", new_radio, new_content)

with open(file_path, 'w') as f:
    f.write(new_content)

--- FILE: /home/sami/sumyaman/fixes/final_leave_fix.py ---

import re

file_path = '/home/sami/sumyaman/leave_apply.py'
with open(file_path, 'r') as f:
    content = f.read()

# Query ko update karna taake Name aur Section bhi save hon
old_query = 'INSERT INTO apsokara_studentleave (student_id, class, section, wing, reason, from_date, to_date, status) VALUES (?,?,?,?,?,?,?,?)'
new_query = 'INSERT INTO apsokara_studentleave (student_id, class, section, wing, reason, from_date, to_date, status, name) VALUES (?,?,?,?,?,?,?,?,?)'

# Values mapping ko sahi karna (u.get('full_name') add karna)
old_vals = "(u.get('id'), u.get('class'), u.get('sec'), u.get('wing'), reason, str(start), str(end), 'Pending')"
new_vals = "(u.get('id'), u.get('class'), u.get('sec'), u.get('wing'), reason, str(start), str(end), 'Pending', u.get('full_name', 'Student'))"

content = content.replace(old_query, new_query)
content = content.replace(old_vals, new_vals)

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/fix_duplicate_keys.py ---

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

with open(file_path, 'w') as f:
    for line in lines:
        # Loop ko enumerate ke saath badalna taake 'i' mil jaye
        if "for index, s in students.iterrows():" in line:
            f.write(line.replace("index, s", "i, s"))
        # Key mein 'i' ka izafa
        elif 'key=f"final_s_' in line:
            import re
            new_line = re.sub(r'key=f"final_s_.*?_today}"', 'key=f"final_s_{s[\'id\']}_{i}_{today}"', line)
            f.write(new_line)
        else:
            f.write(line)

--- FILE: /home/sami/sumyaman/fixes/final_leave_check_fix.py ---

import re

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Naya behtar function jo sirf student_id aur date check karega
new_func = """def check_on_leave(student_id):
    try:
        import sqlite3
        import datetime
        conn = sqlite3.connect('db.sqlite3')
        today = datetime.date.today().isoformat()
        cur = conn.cursor()
        # Naye table 'apsokara_studentleave' se check karna
        query = "SELECT id FROM apsokara_studentleave WHERE student_id=? AND status='Approved' AND ? BETWEEN from_date AND to_date"
        cur.execute(query, (student_id, today))
        res = cur.fetchone()
        conn.close()
        return True if res else False
    except Exception as e:
        return False"""

# Purane function (line 20-29) ko dhoond kar replace karna
pattern = r"def check_on_leave\(student_id\):.*?return False"
content = re.sub(pattern, new_func, content, flags=re.DOTALL)

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/ultimate_fix.py ---

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

with open(file_path, 'w') as f:
    for line in lines:
        if 'st.radio' in line and 'key=f"final_s_' in line:
            # Hum saare temporary variables (i, index) nikaal kar 'id' aur 'roll_no' fix kar rahe hain
            import re
            fixed_line = re.sub(r'key=f"final_s_.*?_today}"', 'key=f"final_s_{s[\'id\']}_{s[\'roll_no\']}_{today}"', line)
            f.write(fixed_line)
        else:
            f.write(line)

--- FILE: /home/sami/sumyaman/fixes/fix_pandas_logic.py ---

file_path = '/home/sami/sumyaman/leave_approvals.py'
with open(file_path, 'r') as f:
    content = f.read()

# Masla ye hai ke 'r' loop mein shayad sahi tarah iterrows() nahi ho raha
# Hum logic ko row-by-row iterate karne ke liye fix karte hain
old_logic = "display_name = r['name'] if r['name'] else f\"Student ID: {r['student_id']}\""
new_logic = "display_name = r['name'] if (isinstance(r['name'], str) and r['name'].strip()) else f\"Student ID: {r['student_id']}\""

content = content.replace(old_logic, new_logic)

# Agar loop iterrows use nahi kar raha toh usay bhi target karte hain
content = content.replace("for r in pending:", "for index, r in pending.iterrows():")

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/final_role_fix.py ---

import re

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Naya accurate fetch function jo 'Class Teacher' role bhejega
new_function = """
def fetch_user_data(user_id, dob_val, user_type):
    conn = sqlite3.connect('db.sqlite3')
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    try:
        if user_type == "Teacher":
            q = "SELECT id, full_name, assigned_wing as wing, assigned_class as class, assigned_section as section, is_class_teacher FROM apsokara_teacher WHERE cnic = ? AND dob = ?"
        else:
            q = "SELECT id, full_name, wing, student_class as class, student_section as section FROM apsokara_student WHERE b_form = ? AND dob = ?"
        
        cursor.execute(q, (user_id, dob_val))
        row = cursor.fetchone()
        if row:
            data = dict(row)
            # Yahan asali jaadu hai:
            if user_type == "Teacher" and row['is_class_teacher'] == 1:
                data['role_db'] = "Class Teacher"
            else:
                data['role_db'] = user_type
            return data
        return None
    except Exception as e:
        st.error(f"Database Error: {e}")
        return None
    finally:
        conn.close()
"""

# Purane function ko replace karna
pattern = r'def fetch_user_data\(.*?\):.*?finally:.*?conn\.close\(\)'
content = re.sub(pattern, new_function, content, flags=re.DOTALL)

with open(file_path, 'w') as f:
    f.write(content)

print("‚úÖ Role Mapping Fixed: 'Teacher' is now 'Class Teacher' where applicable!")

--- FILE: /home/sami/sumyaman/fixes/final_fix.py ---

file_path = '/home/sami/sumyaman/main_app.py'

with open(file_path, 'r') as f:
    content = f.read()

# 1. SQL Queries ko correct models ke mutabiq set karein
import re
content = re.sub(r'q = "SELECT \* FROM apsokara_teacher WHERE .*"', 'q = "SELECT * FROM apsokara_teacher WHERE cnic = ? AND dob = ?"', content)
content = re.sub(r'q = "SELECT \* FROM apsokara_student WHERE .*"', 'q = "SELECT * FROM apsokara_student WHERE b_form = ? AND dob = ?"', content)

# 2. Teacher Table ke columns ko Streamlit variables se match karein
# Teacher table mein 'assigned_wing' hai, code mein 'wing' dhoond raha hai
content = content.replace("st.session_state.user_data['wing']", "st.session_state.user_data['assigned_wing'] if 'assigned_wing' in st.session_state.user_data else st.session_state.user_data.get('wing', 'None')")

# 3. Agar data fetch karte waqt direct index use ho raha hai to usay sambhalein
content = content.replace("user_data['wing']", "user_data['assigned_wing'] if 'assigned_wing' in user_data else user_data.get('wing', 'None')")

with open(file_path, 'w') as f:
    f.write(content)

print("‚úÖ main_app.py updated for Teacher (assigned_wing) and Student (wing)!")

--- FILE: /home/sami/sumyaman/fixes/fix_index_final.py ---

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

with open(file_path, 'w') as f:
    for line in lines:
        # Purane loop ko dhoond kar index add karna
        if 'for s in students.iterrows():' in line:
            line = line.replace('for s in students.iterrows():', 'for index, s in students.iterrows():')
        elif 'for _, s in students.iterrows():' in line:
            line = line.replace('for _, s in students.iterrows():', 'for index, s in students.iterrows():')
        f.write(line)

print("‚úÖ Loop fixed! 'index' is now defined.")

--- FILE: /home/sami/sumyaman/fixes/fix_final.py ---

import re

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    content = f.read()

# Ham 'i' ko 'index' se replace kar rahe hain jo pandas iterrows() mein default hota hai
content = content.replace("_{i}_", "_{index}_")

with open(file_path, 'w') as f:
    f.write(content)

print("‚úÖ Indexing fixed!")

--- FILE: /home/sami/sumyaman/fixes/fix_keys_safe.py ---

import re

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    content = f.read()

# Ham segmented_control ki key ko enumerate ke baghair bhi unique kar sakte hain 
# bache ke roll_no ko use karke jo aapke design ka hissa hai
content = re.sub(r'key=f"s_{s\[\'id\'\]}_{today}"', r'key=f"s_{s[\'id\']}_{s[\'roll_no\']}_{today}"', content)

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/fix_leave_history.py ---

file_path = '/home/sami/sumyaman/leave_apply.py'
with open(file_path, 'r') as f:
    content = f.read()

# Query mein is_read shamil karna
old_q = "SELECT from_date, to_date, status, reason FROM apsokara_studentleave"
new_q = "SELECT from_date, to_date, status, reason, is_read FROM apsokara_studentleave"

content = content.replace(old_q, new_q)

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/final_display_fix.py ---

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Sirf Welcome text wali line ko target karna
content = content.replace("Welcome, {u.get('name')}", "Welcome, {u.get('full_name') if st.session_state.role == 'Student' else u.get('name')}")
# Hero card ki welcome heading
content = content.replace('<div class="welcome-text">Welcome, {u["name"]}</div>', 
                          '<div class="welcome-text">Welcome, {u.get("full_name") if st.session_state.role == "Student" else u.get("name")}</div>')

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/rebuild_file.py ---

import re

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

new_lines = []
for line in lines:
    # 1. Jo lines bhatak gayi hain unki indentation fix karna
    if line.strip().startswith('if students.empty:'):
        new_lines.append('    if students.empty:\n')
    elif line.strip().startswith('st.warning("No students found"):'):
        new_lines.append('        st.warning("No students found")\n')
    elif line.strip().startswith('else:'):
        new_lines.append('    else:\n')
    # 2. Duplicate Key ka khatma (id + index + static safe string)
    elif 'st.segmented_control' in line:
        line = re.sub(r'key=f"s_.*?"', r'key=f"s_{s[\'id\']}_{index}_final"', line)
        new_lines.append(line)
    else:
        new_lines.append(line)

with open(file_path, 'w') as f:
    f.writelines(new_lines)
print("‚úÖ Indentation and Keys have been aligned perfectly!")

--- FILE: /home/sami/sumyaman/fixes/fix_student_login.py ---

import re

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Student login mapping ko exact database columns ke mutabiq fix karna
old_pattern = r'"Student":\s*{\s*"query":\s*".*?",\s*"mapping":\s*{.*?}\s*}'
new_replacement = """"Student": {
            "query": "SELECT id, full_name, father_full_name, cnic, student_class, student_section, wing, dob FROM apsokara_student WHERE cnic=? AND dob=?",
            "mapping": {
                "id": 0, "full_name": 1, "father_full_name": 2, "cnic": 3, 
                "student_class": 4, "student_section": 5, "wing": 6, "dob": 7
            }
        }"""

content = re.sub(old_pattern, new_replacement, content, flags=re.DOTALL)

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/fix_app_final.py ---

file_path = '/home/sami/sumyaman/main_app.py'

with open(file_path, 'r') as f:
    lines = f.readlines()

with open(file_path, 'w') as f:
    for line in lines:
        # Teacher Query Fix: Selecting exact columns from apsokara_teacher
        if 'SELECT * FROM apsokara_teacher' in line:
            f.write('        q = "SELECT id, full_name, assigned_wing, assigned_class, assigned_section FROM apsokara_teacher WHERE cnic = ? AND dob = ?"\n')
        
        # Student Query Fix: Selecting exact columns from apsokara_student
        elif 'SELECT * FROM apsokara_student' in line:
            f.write('        q = "SELECT id, full_name, wing, student_class, student_section FROM apsokara_student WHERE b_form = ? AND dob = ?"\n')
        
        else:
            f.write(line)

print("‚úÖ main_app.py fixed: Teacher (cnic/assigned_wing) and Student (b_form/wing) are now synced!")

--- FILE: /home/sami/sumyaman/fixes/fix_leave_func.py ---

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Sahi query: table name aur column names badalna
old_query = "SELECT id FROM apsokara_leaverequests WHERE student_id=? AND session_year = (SELECT session_year FROM apsokara_student WHERE id=?) AND status='Approved' AND ? BETWEEN start_date AND end_date"
new_query = "SELECT id FROM apsokara_studentleave WHERE student_id=? AND status='Approved' AND ? BETWEEN from_date AND to_date"

content = content.replace(old_query, new_query)
with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/force_attendance.py ---

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Agar data['is_class_teacher'] missing hai to usay row se connect karo
if "data['is_class_teacher'] = row['is_class_teacher']" not in content:
    content = content.replace("data['role_db'] = user_type", "data['role_db'] = user_type\n            data['is_class_teacher'] = row['is_class_teacher']")

with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/fix_streamlit.py ---

file_path = '/home/sami/sumyaman/main_app.py'

with open(file_path, 'r') as f:
    lines = f.readlines()

with open(file_path, 'w') as f:
    for line in lines:
        # Teacher query fix (cnic use hoga as ID)
        if "SELECT * FROM apsokara_teacher WHERE" in line:
            f.write('        q = "SELECT * FROM apsokara_teacher WHERE cnic = ? AND dob = ?"\n')
        # Student query fix (b_form use hoga as ID)
        elif "SELECT * FROM apsokara_student WHERE" in line:
            f.write('        q = "SELECT * FROM apsokara_student WHERE b_form = ? AND dob = ?"\n')
        # Baki code wese hi rehne dein
        else:
            f.write(line)

--- FILE: /home/sami/sumyaman/fixes/fix_attendance_tab.py ---

import re

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Naya query jis mein is_class_teacher shamil hai
new_query = 'q = "SELECT id, full_name, assigned_wing as wing, assigned_class as class, assigned_section as section, is_class_teacher FROM apsokara_teacher WHERE cnic = ? AND dob = ?"'

# Purani query ko update karna
content = re.sub(r'q = "SELECT id, full_name, assigned_wing as wing, assigned_class as class, assigned_section as section FROM apsokara_teacher WHERE cnic = \? AND dob = \?"', new_query, content)

with open(file_path, 'w') as f:
    f.write(content)

print("‚úÖ Teacher portal updated to check Class Teacher status!")

--- FILE: /home/sami/sumyaman/fixes/fix_indent_and_keys.py ---

import re

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

with open(file_path, 'w') as f:
    for line in lines:
        # 1. Indentation fix: extra spaces khatam karna
        stripped = line.lstrip()
        if stripped.startswith('if students.empty:'):
            # Is line ko sahi level par set karna
            line = "    if students.empty:\n"
        
        # 2. Duplicate key fix: agar key mein abhi bhi purana panga hai
        if 'st.segmented_control' in line:
            # Har martaba refresh pe unique key ensure karna
            import time
            ts = int(time.time())
            line = re.sub(r'key=f"s_.*?"', f'key=f"s_{{s[\'id\']}}_{{index}}_{ts}"', line)
            
        f.write(line)

print("‚úÖ Indentation fixed and keys secured!")

--- FILE: /home/sami/sumyaman/fixes/ultimate_key_fix.py ---

import re
import time

file_path = '/home/sami/sumyaman/attendance_system.py'
ts = int(time.time()) # Har dafa aik naya number

with open(file_path, 'r') as f:
    content = f.read()

# Hum key ko bilkul unique kar rahe hain index aur timestamp ke sath
new_content = re.sub(r"key=f\"s_\{s\['id'\]\}_\{today\}_\{index\}\"", f'key=f"s_{{s[\'id\']}}_{{index}}_{ts}"', content)

with open(file_path, 'w') as f:
    f.write(new_content)

print("‚úÖ Keys are now globally unique!")

--- FILE: /home/sami/sumyaman/fixes/fix_leave_query.py ---

file_path = '/home/sami/sumyaman/apsokara/logic/student_modules.py'
with open(file_path, 'r') as f:
    content = f.read()

# Query aur values ko correct karna
old_line = 'conn.execute("INSERT INTO apsokara_studentleave (student_id, name, class, section, wing, reason, from_date, to_date, status) VALUES (?,?,?,?,?,?,?,?,?)",'
new_line = 'conn.execute("INSERT INTO apsokara_studentleave (student_id, name, class, section, wing, reason, from_date, to_date, status) VALUES (?,?,?,?,?,?,?,?,?)",'

# Values array ko fix karna (full_name use karna)
old_vals = "(u['id_num'], u['name'], u['class'], u.get('section',''), u.get('wing',''), reason, start, end, 'Pending'))"
new_vals = "(u['id_num'], u.get('full_name', u.get('name')), u['class'], u.get('sec', u.get('section', '')), u.get('wing',''), reason, str(start), str(end), 'Pending'))"

content = content.replace(old_vals, new_vals)
with open(file_path, 'w') as f:
    f.write(content)

--- FILE: /home/sami/sumyaman/fixes/final_sync.py ---

import re

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

new_lines = []
found_loop = False

for line in lines:
    # 1. Loop line ko dhonnd kar 'index' add karna
    if 'iterrows()' in line and 'for' in line and 'index' not in line:
        line = re.sub(r'for (.*?) in', r'for index, \1 in', line)
        found_loop = True
    
    # 2. Key mein 'index' ko safeguard karna
    if 'key=f"s_' in line and 'index' not in line:
        line = line.replace('today}"', 'today}_{index}"')
        
    new_lines.append(line)

with open(file_path, 'w') as f:
    f.writelines(new_lines)

if found_loop:
    print("‚úÖ Loop synchronized with index!")
else:
    print("‚ö†Ô∏è Loop already has index or structure is different, but keys checked.")

--- FILE: /home/sami/sumyaman/fixes/final_touch.py ---

import re

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    content = f.read()

# Ham key ko ID aur Index dono ke sath bind kar rahe hain
# Is se duplicate hone ka chance 0% ho jata hai
content = re.sub(r'key=f"s_.*?_index"', r'key=f"s_{s[\'id\']}_{index}"', content)

with open(file_path, 'w') as f:
    f.write(content)
print("‚úÖ Design restored and loops fixed!")

--- FILE: /home/sami/sumyaman/fixes/fix_role.py ---

import re

file_path = '/home/sami/sumyaman/main_app.py'
with open(file_path, 'r') as f:
    content = f.read()

# Naya accurate fetch function jo 'role_db' bhi provide karega
new_function = """
def fetch_user_data(user_id, dob_val, user_type):
    conn = sqlite3.connect('db.sqlite3')
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    try:
        if user_type == "Teacher":
            q = "SELECT id, full_name, assigned_wing as wing, assigned_class as class, assigned_section as section FROM apsokara_teacher WHERE cnic = ? AND dob = ?"
        else:
            q = "SELECT id, full_name, wing, student_class as class, student_section as section FROM apsokara_student WHERE b_form = ? AND dob = ?"
        
        cursor.execute(q, (user_id, dob_val))
        row = cursor.fetchone()
        if row:
            data = dict(row)
            data['role_db'] = user_type  # Ye line KeyError: 'role_db' ko theek karegi
            return data
        return None
    except Exception as e:
        st.error(f"Database Error: {e}")
        return None
    finally:
        conn.close()
"""

# Purane function ko naye wale se replace karna
pattern = r'def fetch_user_data\(.*?\):.*?finally:.*?conn\.close\(\)'
content = re.sub(pattern, new_function, content, flags=re.DOTALL)

with open(file_path, 'w') as f:
    f.write(content)

print("‚úÖ KeyError: 'role_db' fixed!")

--- FILE: /home/sami/sumyaman/fixes/kill_duplicate.py ---

import re
import uuid

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    content = f.read()

# Hum key ke end mein ek random string add kar rahe hain
# Taki agar loop double bhi chale to keys match na karein
pattern = r'key=f"final_s_.*?_today}"'
# Nayi key: original logic + unique random string
replacement = f'key=f"final_s_{{s[\'id\']}}_{{s[\'roll_no\']}}_{{today}}_{str(uuid.uuid4())[:8]}"'

new_content = re.sub(pattern, replacement, content)

with open(file_path, 'w') as f:
    f.write(new_content)

print("‚úÖ Unique UUID added to keys. Duplicate error should be nuked now!")

--- FILE: /home/sami/sumyaman/fixes/fix_sidebar.py ---

file_path = '/home/sami/sumyaman/main_app.py'

with open(file_path, 'r') as f:
    content = f.read()

# 1. Ensure 'is_class_teacher' is being fetched correctly in fetch_user_data
if 'is_class_teacher' not in content:
    content = content.replace("assigned_section", "assigned_section, is_class_teacher")

# 2. Check sidebar logic and force Attendance tab if user is a class teacher
# Hum 'if st.session_state.user_info.get("is_class_teacher")' wali condition ko pakka karte hain
old_tabs = '["üè† DASHBOARD", "üìì POST DIARY", "üìö TEACHING SCHEDULE", "üéØ MARKS ENTRY"]'
new_tabs = '["üè† DASHBOARD", "üìì POST DIARY", "üìö TEACHING SCHEDULE", "üéØ MARKS ENTRY", "üìù ATTENDANCE"]'

# Forcefully injecting the logic if it's missing
if 'üìù ATTENDANCE' not in content:
    content = content.replace(
        'tabs = ["üè† DASHBOARD", "üìì POST DIARY", "üìö TEACHING SCHEDULE", "üéØ MARKS ENTRY"]',
        'if st.session_state.user_info.get("is_class_teacher") == 1:\n        tabs = ["üè† DASHBOARD", "üìì POST DIARY", "üìù ATTENDANCE", "üìö TEACHING SCHEDULE", "üéØ MARKS ENTRY"]\n    else:\n        tabs = ["üè† DASHBOARD", "üìì POST DIARY", "üìö TEACHING SCHEDULE", "üéØ MARKS ENTRY"]'
    )

with open(file_path, 'w') as f:
    f.write(content)

print("‚úÖ Sidebar logic fixed! Attendance tab should now appear for Class Teachers.")

--- FILE: /home/sami/sumyaman/fixes/fix_my_design.py ---

import re

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    content = f.read()

# Hum key ko itna simple aur unique kar rahe hain ke error ka sawal hi na rahe
# Original design ko chhere baghair
content = re.sub(r'key=f"s_.*?_today}"', r'key=f"s_{s[\'id\']}_{s[\'roll_no\']}_{today}"', content)

with open(file_path, 'w') as f:
    f.write(content)
print("‚úÖ Design keys updated successfully!")

--- FILE: /home/sami/sumyaman/fixes/fix_db_final.py ---

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    content = f.read()

# Sahi function import karna aur usey 'get_db' ka naam dena taake baqi code na badalna paray
content = content.replace('from db_bridge import get_connection as get_db', 'from db_bridge import get_connection as get_db')
content = content.replace('from db_bridge import get_db_connection as get_db', 'from db_bridge import get_connection as get_db')

with open(file_path, 'w') as f:
    f.write(content)
print("‚úÖ Database connection bridge fixed!")

--- FILE: /home/sami/sumyaman/fixes/fix_final_duplicate.py ---

file_path = '/home/sami/sumyaman/attendance_system.py'
with open(file_path, 'r') as f:
    lines = f.readlines()

with open(file_path, 'w') as f:
    counter = 0
    for line in lines:
        if 'key=f"s_{s[\'id\']}_{s[\'roll_no\']}_{today}"' in line:
            # Hum design ki key mein bas aik counter add kar rahe hain
            line = line.replace('key=f"s_{s[\'id\']}_{s[\'roll_no\']}_{today}"', 'key=f"s_{s[\'id\']}_{s[\'roll_no\']}_{today}_{i}"')
        
        # Loop ke shuru mein counter (i) ko handle karna
        if 'for index, s in students.iterrows():' in line:
             line = line.replace('index, s', 'i, s')
        elif 'for i, s in students.iterrows():' in line:
             pass
        elif 'for s in students.iterrows():' in line:
             line = line.replace('s in students.iterrows()', 'i, s in students.iterrows()')
             
        f.write(line)

--- FILE: /home/sami/sumyaman/auth_gate.py ---

import streamlit as st
import base64
import os

def get_base64_image(image_path):
    try:
        if os.path.exists(image_path):
            with open(image_path, "rb") as img_file:
                return base64.b64encode(img_file.read()).decode()
        return None
    except: return None

def login_page():
    # Load Logo
    img_base64 = get_base64_image("/home/sami/Downloads/sami.png")
    logo_url = f"data:image/png;base64,{img_base64}" if img_base64 else ""

    # Full CSS for Login
    st.markdown(f"""
    <style>
    header {{visibility: hidden !important;}}
    [data-testid="stAppViewContainer"] {{
        background-color: #F1F3F2 !important;
    }}
    
    /* Login Box */
    .login-card {{
        background-color: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-top: 6px solid #2F3E46;
        text-align: center;
        margin-bottom: -50px;
    }}

    .login-logo {{
        width: 100px; height: 100px;
        border-radius: 50%;
        border: 3px solid #52796F;
        background-image: url('{logo_url}');
        background-size: cover; background-position: center;
        margin: 0 auto 15px auto;
    }}

    .school-title {{
        color: #2F3E46; font-size: 1.2rem; font-weight: 800;
        margin-bottom: 5px; text-transform: uppercase;
    }}

    .login-footer {{
        position: fixed; bottom: 20px; left: 0; right: 0;
        text-align: center; color: #5F6F73; font-size: 13px;
        font-weight: 500;
    }}

    /* Styling Streamlit Inputs */
    div[data-baseweb="input"] {{
        border-radius: 8px !important;
    }}
    
    div.stButton > button {{
        width: 100%;
        background-color: #52796F !important;
        color: white !important;
        border: none !important;
        padding: 10px !important;
        font-weight: 600 !important;
    }}
    </style>
    """, unsafe_allow_html=True)

    # Centering Layout
    col1, col2, col3 = st.columns([1, 1.5, 1])
    
    with col2:
        st.markdown(f"""
        <div class="login-card">
            <div class="login-logo"></div>
            <div class="school-title">ARMY PUBLIC SCHOOL & COLLEGE SYSTEM</div>
            <p style="color: #52796F; font-weight: 600; margin-bottom: 20px;">OKARA CANTT | HQ PANEL</p>
        </div>
        """, unsafe_allow_html=True)
        
        # Form inside col2
        with st.form("login_form"):
            user = st.text_input("Username", placeholder="Enter username")
            pwd = st.text_input("Password", type="password", placeholder="Enter password")
            submit = st.form_submit_button("LOGIN TO HQ")
            
            if submit:
                if user == "admin" and pwd == "admin123":
                    st.session_state.logged_in = True
                    st.rerun()
                else:
                    st.error("Invalid Credentials!")

    st.markdown('<div class="login-footer">¬© 2026 APSACS OKARA | ACADEMIC MANAGEMENT SYSTEM</div>', unsafe_allow_html=True)

def check_access():
    if 'logged_in' not in st.session_state:
        st.session_state.logged_in = False
    
    if not st.session_state.logged_in:
        login_page()
        return False
    return True

def logout_user():
    st.session_state.logged_in = False
    st.rerun()

--- FILE: /home/sami/sumyaman/check_leaves.py ---

import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'sumyaman_pro.settings')
django.setup()

from apsokara.models import Student, StudentLeave

print('\n--- DATABASE LEAVE CHECK ---')
leaves = StudentLeave.objects.all()
if not leaves.exists():
    print("‚ùå Database mein koi bhi leave record nahi mila!")
else:
    for l in leaves:
        print(f"ID: {l.id} | Student: {l.student.full_name}")
        print(f"Class: {l.student.student_class} | Section: {l.student.student_section}")
        print(f"Status: {l.status} | Dates: {l.from_date} to {l.to_date}")
        print("-" * 30)

print(f'\nTotal Leaves in DB: {leaves.count()}')

--- FILE: /home/sami/sumyaman/leave_engine.py ---

import streamlit as st
from leave_apply import render_leave_apply
from leave_approvals import render_leave_approvals

def render_leave_system(u):
    # Agar data mein 'roll' ki key hai, to iska matlab ye student hai
    # Kyunki aapke debug data mein student ke paas 'roll' hai aur teacher ke paas nahi
    if 'roll' in u:
        render_leave_apply(u)
    else:
        render_leave_approvals(u)

--- FILE: /home/sami/sumyaman/auth_engine.py ---

import sqlite3
import pandas as pd
import streamlit as st

def get_teacher_permissions(u):
    t_id = st.session_state.get('username') or st.session_state.get('user', {}).get('username') or 'admin'
    conn = sqlite3.connect("db.sqlite3", check_same_thread=False)
    
    query = """
        SELECT sa.class_name, sa.section, sub.name as subject_name 
        FROM apsokara_subjectassignment sa
        JOIN apsokara_subject sub ON sa.subject_id = sub.id
        WHERE sa.teacher_id = (SELECT id FROM auth_user WHERE username = ?)
           OR sa.teacher_id = ?
    """
    try:
        assign_df = pd.read_sql_query(query, conn, params=(str(t_id), str(t_id)))
    except:
        assign_df = pd.DataFrame()
    
    conn.close()
    return assign_df, t_id

def filter_permissions(assign_df, sel_cls=None, sel_sec=None):
    if assign_df is None or assign_df.empty:
        return [], [], []
    classes = sorted(assign_df['class_name'].unique())
    sections = sorted(assign_df[assign_df['class_name'] == sel_cls]['section'].unique()) if sel_cls else []
    subjects = sorted(assign_df[(assign_df['class_name'] == sel_cls) & (assign_df['section'] == sel_sec)]['subject_name'].unique()) if sel_cls and sel_sec else []
    return classes, sections, subjects

--- FILE: /home/sami/sumyaman/templates/apsokara/boys_wing_attendance.html ---

<h1>Boys Wing Attendance</h1>
<p>Working...</p>

--- FILE: /home/sami/sumyaman/templates/apsokara/student_profile.html ---

{% extends 'apsokara/base_admin.html' %}
{% block content %}
<style>
    :root { --navy: #0f172a; --aps-red: #be123c; --slate: #64748b; }
    body { background: #f8fafc; font-family: 'Inter', sans-serif; color: #1e293b; }

    /* Navigation Bar */
    .top-nav { background: white; padding: 15px 30px; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 20px; }
    
    /* Global Banner */
    .god-banner { background: var(--navy); color: white; margin: 20px; border-radius: 16px; padding: 40px; position: relative; overflow: hidden; border-bottom: 8px solid var(--aps-red); }
    .god-banner::after { content: 'APS'; position: absolute; right: -20px; bottom: -20px; font-size: 150px; font-weight: 900; opacity: 0.05; }
    
    .info-box { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 30px; }
    .info-card { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); }
    .info-label { font-size: 11px; text-transform: uppercase; color: #94a3b8; font-weight: 700; margin-bottom: 5px; }
    .info-value { font-size: 14px; font-weight: 600; color: white; }

    /* Analytics Bar */
    .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin: 0 20px 25px 20px; }
    .stat-tile { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .stat-tile h2 { font-weight: 800; margin: 0; color: var(--navy); }
    .stat-tile p { font-size: 11px; font-weight: 700; color: var(--slate); text-transform: uppercase; margin: 5px 0 0 0; }

    /* Tabs & Filters */
    .main-card { background: white; margin: 0 20px 40px 20px; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; }
    .nav-tabs-custom { background: #f1f5f9; display: flex; border-bottom: 1px solid #e2e8f0; }
    .nav-tab { padding: 18px 30px; border: none; background: none; font-weight: 700; color: var(--slate); cursor: pointer; }
    .nav-tab.active { background: white; color: var(--aps-red); border-bottom: 3px solid var(--aps-red); }

    /* Filter System */
    .filter-bar { padding: 20px 25px; background: #fff; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
    .active-filters { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
    .filter-chip { background: #fee2e2; color: var(--aps-red); padding: 4px 12px; border-radius: 50px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .filter-chip i { cursor: pointer; }

    .status-badge { padding: 5px 12px; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; }

    @media print {
        .no-print { display: none !important; }
        .main-card { border: none; margin: 0; }
        .print-header { display: block !important; border-bottom: 2px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
    }
</style>

<div class="top-nav no-print">
    <button onclick="history.back()" class="btn btn-sm btn-outline-dark rounded-pill px-4">
        <i class="fas fa-arrow-left me-2"></i> Back to Classroom
    </button>
    <div class="vr"></div>
    <span class="fw-bold text-muted small text-uppercase">Student Information System v3.0</span>
</div>

<div class="god-banner">
    <div class="d-flex justify-content-between align-items-start">
        <div>
            <span class="badge bg-danger mb-2 px-3">APS STUDENT OFFICIAL</span>
            <h1 class="display-5 fw-bold m-0" style="letter-spacing: -1px;">{{ s.full_name|upper }}</h1>
            <p class="text-info fw-semibold mt-1"><i class="fas fa-chalkboard-teacher me-2"></i>Class Teacher: {{ teacher_name }}</p>
        </div>
        <div class="text-end">
            <p class="info-label m-0">Account Status</p>
            <h3 class="text-success fw-bold m-0">‚óè ACTIVE</h3>
        </div>
    </div>

    <div class="info-box">
        <div class="info-card"><div class="info-label">Father Name</div><div class="info-value">{{ s.father_name }}</div></div>
        <div class="info-card"><div class="info-label">Identity Number</div><div class="info-value text-danger">{{ s.cnic }}</div></div>
        <div class="info-card"><div class="info-label">Wing & Class</div><div class="info-value">{{ s.wing }} - {{ s.student_class }}({{ s.student_section }})</div></div>
        <div class="info-card"><div class="info-label">Parent Contact</div><div class="info-value">{{ s.parent_phone }}</div></div>
        <div class="info-card"><div class="info-label">Date of Birth</div><div class="info-value">{{ s.dob|default:"N/A" }}</div></div>
        <div class="info-card"><div class="info-label">Enrollment Date</div><div class="info-value">{{ s.admission_date|default:"N/A" }}</div></div>
        <div class="info-card"><div class="info-label">Gender</div><div class="info-value">{{ s.gender|default:"N/A" }}</div></div>
        <div class="info-card"><div class="info-label">Portal Date</div><div class="info-value text-info">{{ today }}</div></div>
    </div>
</div>

<div class="stats-row no-print">
    <div class="stat-tile"><h2>{{ stats.total }}</h2><p>Total School Days</p></div>
    <div class="stat-tile text-success"><h2>{{ stats.present }}</h2><p>Days Present</p></div>
    <div class="stat-tile text-danger"><h2>{{ stats.absent }}</h2><p>Days Absent</p></div>
    <div class="stat-tile text-warning"><h2>{{ stats.leave }}</h2><p>Days Leave</p></div>
    <div class="stat-tile" style="border-bottom: 4px solid var(--aps-red);"><h2>{{ stats.percent }}%</h2><p>Attendance Score</p></div>
</div>

<div class="main-card">
    <div class="nav-tabs-custom no-print">
        <button class="nav-tab active" data-target="att-history">ATTENDANCE HISTORY</button>
        <button class="nav-tab" data-target="leave-history">LEAVE APPLICATIONS</button>
    </div>

    <div id="att-history" class="tab-content-area">
        <div class="filter-bar no-print">
            <div class="d-flex gap-3 align-items-center">
                <input type="date" id="attDateInput" class="form-control form-control-sm rounded-pill px-3 shadow-sm">
                <select id="attStatusFilter" class="form-select form-select-sm rounded-pill shadow-sm">
                    <option value="ALL">All Status</option>
                    <option value="PRESENT">Present</option>
                    <option value="ABSENT">Absent</option>
                    <option value="LEAVE">Leave</option>
                </select>
                <div id="attChips" class="active-filters"></div>
            </div>
            <button onclick="window.print()" class="btn btn-dark btn-sm rounded-pill px-4 shadow-sm">
                <i class="fas fa-print me-2"></i>Print History Sheet
            </button>
        </div>

        <div class="p-4">
            <div class="print-header d-none">
                <div class="text-center">
                    <h2 class="fw-bold">ARMY PUBLIC SCHOOL OKARA</h2>
                    <h4>Student Attendance History Report</h4>
                </div>
                <div class="row mt-4">
                    <div class="col-6">
                        <p><strong>Student:</strong> {{ s.full_name }}</p>
                        <p><strong>Father:</strong> {{ s.father_name }}</p>
                    </div>
                    <div class="col-6 text-end">
                        <p><strong>Class:</strong> {{ s.student_class }}-{{ s.student_section }}</p>
                        <p><strong>ID:</strong> {{ s.cnic }}</p>
                    </div>
                </div>
            </div>

            <table class="table table-hover align-middle" id="attTable">
                <thead class="table-light">
                    <tr class="small fw-bold"><th>DATE</th><th>DAY</th><th>LOG STATUS</th><th>ENTRY TIME</th></tr>
                </thead>
                <tbody>
                    {% for h in history %}
                    <tr class="att-row" data-date="{{ h.date }}" data-status="{{ h.status|upper }}">
                        <td class="fw-bold">{{ h.date }}</td>
                        <td class="text-muted">{{ h.date|date:"l" }}</td>
                        <td>
                            <span class="status-badge {% if h.status == 'Present' %}bg-success-subtle text-success border border-success{% elif h.status == 'Absent' %}bg-danger-subtle text-danger border border-danger{% else %}bg-warning-subtle text-warning border border-warning{% endif %}">
                                {{ h.status }}
                            </span>
                        </td>
                        <td class="small text-muted">08:00 AM (Fixed)</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="leave-history" class="tab-content-area d-none">
        <div class="filter-bar no-print">
            <div class="d-flex gap-2">
                <select id="leaveStatusFilter" class="form-select form-select-sm rounded-pill">
                    <option value="ALL">All Requests</option>
                    <option value="Approved">Approved</option>
                    <option value="Pending">Pending</option>
                    <option value="Rejected">Rejected</option>
                </select>
            </div>
            <span class="small fw-bold text-muted">Total Applications: {{ leaves.count }}</span>
        </div>
        <div class="p-4">
            <table class="table border" id="leaveTable">
                <thead class="table-light">
                    <tr class="small fw-bold"><th>PERIOD</th><th>REASON</th><th>STATUS</th><th>APPLIED ON</th></tr>
                </thead>
                <tbody>
                    {% for l in leaves %}
                    <tr class="leave-row" data-status="{{ l.status }}">
                        <td>{{ l.from_date }} to {{ l.to_date }}</td>
                        <td class="small fw-semibold text-muted">{{ l.reason }}</td>
                        <td><span class="badge {% if l.status == 'Approved' %}bg-success{% elif l.status == 'Rejected' %}bg-danger{% else %}bg-dark{% endif %} px-3">{{ l.status }}</span></td>
                        <td class="small">System Entry</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Tab Controller
    document.querySelectorAll('.nav-tab').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content-area').forEach(c => c.classList.add('d-none'));
            this.classList.add('active');
            document.getElementById(this.dataset.target).classList.remove('d-none');
        });
    });

    // Attendance Logic & Filters
    const attDateInput = document.getElementById('attDateInput');
    const attStatusFilter = document.getElementById('attStatusFilter');
    const attChips = document.getElementById('attChips');

    function updateAttFilters() {
        const dateVal = attDateInput.value;
        const statusVal = attStatusFilter.value;
        attChips.innerHTML = '';

        if(dateVal) attChips.innerHTML += `<div class="filter-chip">Date: ${dateVal} <i class="fas fa-times" onclick="clearFilter('date')"></i></div>`;
        if(statusVal !== 'ALL') attChips.innerHTML += `<div class="filter-chip">Status: ${statusVal} <i class="fas fa-times" onclick="clearFilter('status')"></i></div>`;

        document.querySelectorAll('.att-row').forEach(row => {
            const rowDate = row.dataset.date;
            const rowStatus = row.dataset.status;
            const dateMatch = !dateVal || rowDate === dateVal;
            const statusMatch = statusVal === 'ALL' || rowStatus === statusVal;
            row.style.display = (dateMatch && statusMatch) ? '' : 'none';
        });
    }

    function clearFilter(type) {
        if(type === 'date') attDateInput.value = '';
        if(type === 'status') attStatusFilter.value = 'ALL';
        updateAttFilters();
    }

    attDateInput.addEventListener('change', updateAttFilters);
    attStatusFilter.addEventListener('change', updateAttFilters);

    // Leave Filter Logic
    document.getElementById('leaveStatusFilter').addEventListener('change', function() {
        const val = this.value;
        document.querySelectorAll('.leave-row').forEach(row => {
            row.style.display = (val === 'ALL' || row.dataset.status === val) ? '' : 'none';
        });
    });
</script>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/apsokara/wing_attendance_base.html ---

{% extends 'apsokara/base_admin.html' %}

{% block content %}
<style>
    .banner-wing {
        background: linear-gradient(135deg, {% if wing_name == 'Boys' %}#1e3a8a{% else %}#be185d{% endif %} 0%, #1a252f 100%);
        color: white; padding: 30px 40px; border-radius: 15px; margin-bottom: 20px;
    }
    .viewing-status {
        font-size: 13px; color: #d9534f; font-weight: 700; background: #fff;
        padding: 5px 15px; border-radius: 20px; border: 1px solid #eee;
    }
    .class-box {
        background: white; border-radius: 12px; border: 1px solid #eee;
        transition: 0.3s; text-decoration: none; color: inherit; display: block;
        padding: 20px; text-align: center; height: 100%;
    }
    .class-box:hover { border-color: #d9534f; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .class-title { font-size: 18px; font-weight: 800; color: #1a252f; margin-bottom: 5px; }
    .class-strength { font-size: 12px; font-weight: 600; color: #666; background: #f8f9fa; padding: 3px 10px; border-radius: 10px; }
    
    .search-section { max-width: 500px; margin: 30px auto; position: relative; }
    .search-section input { border-radius: 30px; padding: 12px 25px 12px 50px; border: 1px solid #ddd; }
    .search-section i { position: absolute; left: 20px; top: 15px; color: #aaa; }
</style>

<div class="container-fluid">
    <div class="banner-wing d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold m-0"><i class="fas {% if wing_name == 'Boys' %}fa-male{% else %}fa-female{% endif %} me-2"></i>{{ wing_name|upper }} WING</h2>
            <p class="opacity-75 m-0">Class-wise attendance management and analytics.</p>
        </div>
        <a href="/gatekeeper-v3-okara-786/attendance/" class="btn btn-sm btn-light rounded-pill px-3">
            <i class="fas fa-arrow-left me-1"></i> Back to Main
        </a>
    </div>

    <div class="row mb-4">
        {% for label, val, color in stats_items %}
        {% endfor %}
        <div class="col-md-3"><div class="card p-3 border-0 shadow-sm border-start border-info border-5">
            <small class="text-muted fw-bold">TOTAL {{ wing_name|upper }}</small><h3>{{ stats.total }}</h3>
        </div></div>
        <div class="col-md-3"><div class="card p-3 border-0 shadow-sm border-start border-success border-5">
            <small class="text-muted fw-bold">PRESENT</small><h3>{{ stats.present }}</h3>
        </div></div>
        <div class="col-md-3"><div class="card p-3 border-0 shadow-sm border-start border-danger border-5">
            <small class="text-muted fw-bold">ABSENT</small><h3>{{ stats.absent }}</h3>
        </div></div>
        <div class="col-md-3"><div class="card p-3 border-0 shadow-sm border-start border-warning border-5">
            <small class="text-muted fw-bold">LEAVE</small><h3>{{ stats.leave }}</h3>
        </div></div>
    </div>

    <div class="search-section">
        <i class="fas fa-search"></i>
        <form method="GET">
            <input type="text" name="q" class="form-control shadow-sm" placeholder="Search Class or Section (e.g. 10-A)..." value="{{ search_q }}">
            <input type="hidden" name="range" value="{{ range }}">
        </form>
    </div>

    <div class="row g-3">
        {% for item in class_list %}
        <div class="col-md-2 col-sm-4 col-6">
            <a href="/gatekeeper-v3-okara-786/attendance/classroom/{{ item.student_class }}/{{ item.student_section }}/" class="class-box shadow-sm">
                <div class="class-title">{{ item.student_class }}-{{ item.student_section }}</div>
                <span class="class-strength">Strength: {{ item.total }}</span>
            </a>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <p class="text-muted">No classes found for this criteria.</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/apsokara/student_profile_placeholder.html ---

<!DOCTYPE html>
<html>
<head><title>Student Profile</title></head>
<body style="font-family: sans-serif; padding: 50px; text-align: center;">
    <h1>Student Profile View</h1>
    <p>ID: {{ id }}</p>
    <p>Ye page abhi development mein hai. Jald hi yahan student ki mukammal detail hogi.</p>
    <a href="javascript:history.back()">Wapas Jayein</a>
</body>
</html>

--- FILE: /home/sami/sumyaman/templates/apsokara/attendance_dashboard.html ---

<!DOCTYPE html>
<html>
<head><title>Attendance Dashboard</title></head>
<body>
    <h1>Attendance Dashboard</h1>
    <p>Templates restored! Please replace this with your original design if available.</p>
    <ul>
        <li><a href="boys/">Boys Wing</a></li>
        <li><a href="girls/">Girls Wing</a></li>
    </ul>
</body>
</html>

--- FILE: /home/sami/sumyaman/templates/apsokara/classroom_view.html ---

{% extends 'apsokara/base_admin.html' %}
{% block content %}
<style>
    :root { --navy: #1a252f; --aps-red: #d9534f; --light: #f8fafc; }
    body { background: #f1f3f5; font-family: 'Segoe UI', sans-serif; }

    /* Banner & Nav */
    .nav-header { background: white; padding: 12px 25px; border-bottom: 1px solid #dee2e6; }
    .god-banner { background: linear-gradient(135deg, var(--navy) 0%, #2c3e50 100%); color: white; padding: 30px 40px; margin: 20px; border-radius: 15px; border-left: 10px solid var(--aps-red); position: relative; }
    
    /* Analytics Isolation */
    .analytics-section { background: white; margin: 0 20px 25px 20px; border-radius: 12px; padding: 20px; display: grid; grid-template-columns: 1fr 3fr; gap: 20px; border: 1px solid #e2e8f0; }
    .stat-circle { text-align: center; border-right: 1px solid #f0f0f0; }
    .stat-circle:last-child { border-right: none; }
    .stat-val { font-size: 2.2rem; font-weight: 800; color: var(--navy); line-height: 1; }
    .stat-lbl { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-top: 8px; }

    /* Modular Content Tabs */
    .content-box { background: white; margin: 0 20px 40px 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); overflow: hidden; }
    .nav-tabs-custom .nav-link { padding: 20px 30px; border: none; font-weight: 700; color: #94a3b8; }
    .nav-tabs-custom .nav-link.active { color: var(--aps-red); background: white; border-bottom: 4px solid var(--aps-red); }

    /* Toolbars */
    .tool-bar { background: #f8fafc; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #edf2f7; }
    .search-bar { border-radius: 50px; border: 1px solid #cbd5e1; padding: 6px 20px; width: 250px; outline: none; }
    .pill-group { display: flex; background: #e2e8f0; border-radius: 50px; padding: 3px; }
    .pill-btn { border: none; background: none; padding: 5px 15px; border-radius: 50px; font-size: 11px; font-weight: 700; color: #475569; }
    .pill-btn.active { background: white; color: var(--aps-red); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

    /* Student Rows */
    .stu-row:hover { background: #f8fafc !important; cursor: pointer; }

    @media print {
        .no-print { display: none !important; }
        .print-area { display: block !important; }
        .content-box { box-shadow: none; border: none; }
        .table { width: 100%; border: 1px solid #000; }
    }
</style>

<div class="nav-header no-print">
    <a href="/gatekeeper-v3-okara-786/attendance/wing/{{ wing_name }}/" class="btn btn-sm btn-dark rounded-pill px-3">
        <i class="fas fa-chevron-left me-1"></i> Back to {{ wing_name }} Wing
    </a>
</div>

<div class="god-banner no-print">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="fw-bold m-0">Class {{ class_name }} - {{ section }}</h1>
            <p class="mb-0 opacity-75 fw-semibold"><i class="fas fa-university me-2"></i> {{ wing_name }} WING | APS OKARA CAMPUS</p>
        </div>
        <div class="col-md-4 text-md-end">
            <div class="small opacity-75">PORTAL ACCESS DATE</div>
            <h4 class="fw-bold m-0">{{ today }}</h4>
        </div>
    </div>
</div>

<div class="analytics-section no-print shadow-sm">
    <div class="border-end pe-4">
        <label class="stat-lbl mb-2 d-block text-navy">Performance Range</label>
        <div class="btn-group w-100 btn-group-sm mb-3">
            <a href="?range=today&hist_date={{ hist_date }}" class="btn btn-{% if range == 'today' %}dark{% else %}outline-dark{% endif %}">Today</a>
            <a href="?range=weekly&hist_date={{ hist_date }}" class="btn btn-{% if range == 'weekly' %}dark{% else %}outline-dark{% endif %}">Weekly</a>
            <a href="?range=monthly&hist_date={{ hist_date }}" class="btn btn-{% if range == 'monthly' %}dark{% else %}outline-dark{% endif %}">Monthly</a>
        </div>
        <div class="small text-muted"><i class="fas fa-sync-alt me-1"></i> Data sync for <b>{{ range|upper }}</b></div>
    </div>
    <div class="d-flex justify-content-around align-items-center">
        <div class="stat-circle"><div class="stat-val">{{ stats.total }}</div><div class="stat-lbl">Total Students</div></div>
        <div class="stat-circle"><div class="stat-val text-success">{{ stats.present }}</div><div class="stat-lbl">Present</div></div>
        <div class="stat-circle"><div class="stat-val text-danger">{{ stats.absent }}</div><div class="stat-lbl">Absent</div></div>
        <div class="stat-circle"><div class="stat-val text-warning">{{ stats.leave }}</div><div class="stat-lbl">Leaves</div></div>
    </div>
</div>

<div class="content-box">
    <ul class="nav nav-tabs nav-tabs-custom border-0 no-print bg-light" id="godTabs">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#attendance-pane">ATTENDANCE HISTORY</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#leaves-pane">LEAVE MANAGEMENT</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="attendance-pane">
            <div class="tool-bar no-print">
                <div class="d-flex align-items-center gap-3">
                    <input type="text" id="attSearch" class="search-bar" placeholder="Search by name or ID...">
                    <div class="pill-group">
                        <button class="pill-btn active" onclick="filterAtt('all', this)">All</button>
                        <button class="pill-btn" onclick="filterAtt('PRESENT', this)">Present</button>
                        <button class="pill-btn" onclick="filterAtt('ABSENT', this)">Absent</button>
                        <button class="pill-btn" onclick="filterAtt('LEAVE', this)">Leave</button>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <div class="text-end me-2">
                        <span class="small fw-bold text-muted d-block">VIEWING: {{ hist_date }}</span>
                        <form class="m-0"><input type="date" name="hist_date" value="{{ hist_date }}" onchange="this.form.submit()" class="form-control form-control-sm border-danger rounded-pill"><input type="hidden" name="range" value="{{ range }}"></form>
                    </div>
                    <button onclick="window.print()" class="btn btn-dark btn-sm rounded-pill px-4"><i class="fas fa-print me-2"></i>Print Sheet</button>
                </div>
            </div>

            <div class="print-area p-4">
                <div class="d-none d-print-block text-center mb-4">
                    <h2>ARMY PUBLIC SCHOOL OKARA</h2>
                    <h4>Attendance Registry | Class {{ class_name }}-{{ section }} | Date: {{ hist_date }}</h4>
                </div>
                <table class="table table-hover border align-middle" id="attTable">
                    <thead class="table-light">
                        <tr class="small fw-bold"><th>STUDENT / FATHER NAME</th><th>IDENTITY NUMBER</th><th class="text-center">DAILY STATUS</th></tr>
                    </thead>
                    <tbody>
                        {% for r in history %}
                        <tr class="stu-row" ondblclick="location.href='/gatekeeper-v3-okara-786/student/profile/{{ r.student.id }}/'">
                            <td><div class="fw-bold">{{ r.student.full_name }}</div><div class="small text-muted">{{ r.student.father_name }}</div></td>
                            <td><code class="text-danger fw-bold">{{ r.display_id }}</code></td>
                            <td class="text-center"><span class="badge status-badge rounded-pill px-3 py-2 {% if r.status == 'Present' %}bg-success{% elif r.status == 'Absent' %}bg-danger{% else %}bg-warning text-dark{% endif %}">{{ r.status|upper }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade p-4" id="leaves-pane">
            <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                <div class="pill-group">
                    <button class="pill-btn active" onclick="filterLeave('all', this)">All</button>
                    <button class="pill-btn" onclick="filterLeave('Approved', this)">Approved</button>
                    <button class="pill-btn" onclick="filterLeave('Pending', this)">Pending</button>
                    <button class="pill-btn" onclick="filterLeave('Rejected', this)">Rejected</button>
                </div>
                <form class="d-flex align-items-center gap-2">
                    <span class="small fw-bold text-muted">DATE FILTER:</span>
                    <input type="date" name="leave_date" value="{{ leave_date }}" onchange="this.form.submit()" class="form-control form-control-sm rounded-pill">
                </form>
            </div>
            <table class="table border" id="leaveTable">
                <thead class="table-light small"><tr><th>STUDENT</th><th>PERIOD</th><th>REASON</th><th class="text-center">STATUS</th></tr></thead>
                <tbody>
                    {% for l in leaves %}
                    <tr class="stu-row" ondblclick="location.href='/gatekeeper-v3-okara-786/student/profile/{{ l.student.id }}/'">
                        <td class="fw-bold">{{ l.student.full_name }}</td>
                        <td>{{ l.from_date }} to {{ l.to_date }}</td>
                        <td class="small">{{ l.reason }}</td>
                        <td class="text-center"><span class="badge leave-badge {% if l.status == 'Approved' %}bg-success{% elif l.status == 'Rejected' %}bg-danger{% else %}bg-dark{% endif %}">{{ l.status }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Tab Controller
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('show', 'active'));
            document.querySelector(this.dataset.bsTarget).classList.add('show', 'active');
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            this.classList.add('active');
        });
    });

    // Attendance Filter Engine
    let currentAttFilter = 'all';
    const attSearch = document.getElementById('attSearch');

    function applyAtt() {
        const q = attSearch.value.toLowerCase();
        document.querySelectorAll('#attTable tbody tr').forEach(row => {
            const txt = row.innerText.toLowerCase();
            const stat = row.querySelector('.status-badge').innerText.trim().toUpperCase();
            row.style.display = (txt.includes(q) && (currentAttFilter === 'all' || stat === currentAttFilter)) ? '' : 'none';
        });
    }
    function filterAtt(s, b) {
        document.querySelectorAll('#attendance-pane .pill-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
        currentAttFilter = s.toUpperCase();
        applyAtt();
    }
    attSearch.addEventListener('input', applyAtt);

    // Leave Filter Engine
    function filterLeave(s, b) {
        document.querySelectorAll('#leaves-pane .pill-btn').forEach(btn => btn.classList.remove('active'));
        b.classList.add('active');
        document.querySelectorAll('#leaveTable tbody tr').forEach(row => {
            const stat = row.querySelector('.leave-badge').innerText.trim();
            row.style.display = (s === 'all' || stat === s) ? '' : 'none';
        });
    }
</script>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/apsokara/girls_wing_attendance.html ---

<h1>Girls Wing Attendance</h1>
<p>Working...</p>

--- FILE: /home/sami/sumyaman/templates/apsokara/classroom_detail.html ---

<h1>Classroom: {{ class_name }} - {{ section }}</h1>

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/dashboard.html ---

{% extends 'hq_admin_custom/base.html' %}
{% block content %}
<div class="container-fluid p-4">
    
    <div class="row mb-4">
        <div class="col-12">
            <div class="p-5 text-white shadow-lg d-flex align-items-center justify-content-between" 
                 style="background: linear-gradient(135deg, var(--hq-primary) 0%, var(--hq-accent) 100%); border-radius: 20px;">
                <div>
                    <h1 class="display-5 fw-bold mb-2">APS OKARA | HQ</h1>
                    <p class="lead opacity-75 mb-0">System Command Center - Operational Dashboard</p>
                </div>
                <div class="d-none d-md-block">
                    <i class="fas fa-shield-alt fa-6x opacity-25"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-4 text-center h-100" style="border-radius: 15px;">
                <h6 class="text-muted fw-bold small">TOTAL STUDENTS</h6>
                <h2 class="fw-bold mb-0 text-dark">{{ total }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-4 text-center h-100" style="border-radius: 15px;">
                <h6 class="text-muted fw-bold small">STAFF / FACULTY</h6>
                <h2 class="fw-bold mb-0 text-dark">{{ faculty_count }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-4 text-center h-100" style="border-radius: 15px;">
                <h6 class="text-muted fw-bold small">PRESENT TODAY</h6>
                <h2 class="fw-bold mb-0 text-success">{{ present }}</h2>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-4 text-center h-100" style="border-radius: 15px;">
                <h6 class="text-muted fw-bold small">OPERATIONAL %</h6>
                <h2 class="fw-bold mb-0 text-primary">{{ perc }}%</h2>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100" style="border-radius: 15px;">
                <div class="card-header bg-white border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0" style="color: var(--hq-primary);">RECENT SYSTEM ACTIVITY</h5>
                </div>
                <div class="card-body px-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr class="small text-muted">
                                    <th>STUDENT</th>
                                    <th>CLASS</th>
                                    <th>STATUS</th>
                                    <th>DATE</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for activity in recent_activity %}
                                <tr>
                                    <td class="fw-bold">{{ activity.student.full_name }}</td>
                                    <td>{{ activity.student.student_class }}-{{ activity.student.student_section }}</td>
                                    <td>
                                        {% if activity.status|upper == 'PRESENT' %}
                                            <span class="badge bg-success-subtle text-success px-3">P</span>
                                        {% else %}
                                            <span class="badge bg-danger-subtle text-danger px-3">A</span>
                                        {% endif %}
                                    </td>
                                    <td class="small text-muted">{{ activity.date }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" class="text-center py-4 text-muted">No recent activity found.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm p-4 h-100 text-white" style="background: var(--hq-primary); border-radius: 15px;">
                <h5 class="fw-bold mb-4">WING DISTRIBUTION</h5>
                
                <div class="mb-4 p-3 rounded" style="background: rgba(255,255,255,0.05);">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small fw-bold">BOYS WING</span>
                        <span class="badge bg-accent">{{ boys }}</span>
                    </div>
                    <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                        <div class="progress-bar bg-warning" style="width: 100%"></div>
                    </div>
                </div>

                <div class="mb-4 p-3 rounded" style="background: rgba(255,255,255,0.05);">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="small fw-bold">GIRLS WING</span>
                        <span class="badge bg-accent">{{ girls }}</span>
                    </div>
                    <div class="progress" style="height: 6px; background: rgba(255,255,255,0.1);">
                        <div class="progress-bar bg-info" style="width: 100%"></div>
                    </div>
                </div>

                <div class="mt-auto d-grid">
                    <a href="{% url 'hq_attendance' %}" class="btn btn-warning fw-bold py-2 shadow-sm">
                        GO TO ATTENDANCE PORTAL
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/student_profile.html ---

{% extends 'hq_admin_custom/base.html' %}
{% block content %}
<style>
    :root { --soft-navy: #1e293b; --slate-blue: #334155; --border-color: #e2e8f0; }
    body { background-color: #f1f5f9; color: #334155; }

    .exec-banner {
        background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
        color: white; padding: 25px 35px; border-radius: 12px;
        margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .exec-banner h1 { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
    .student-meta { font-size: 1rem; opacity: 0.9; display: flex; gap: 15px; flex-wrap: wrap; }
    .meta-tag { background: rgba(255,255,255,0.15); padding: 2px 12px; border-radius: 6px; font-weight: 500; }

    .stat-box {
        background: white; border-radius: 12px; padding: 18px;
        border: 1px solid var(--border-color); text-align: center;
    }
    .stat-num { font-size: 1.6rem; font-weight: 800; display: block; line-height: 1.2; }
    .stat-head { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; }

    .details-card {
        background: white; border-radius: 12px; padding: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04); margin-bottom: 25px;
    }
    .detail-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
    .detail-item { border-bottom: 1px solid #f8fafc; padding-bottom: 8px; }
    .detail-label { display: block; font-size: 0.65rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
    .detail-value { font-size: 0.95rem; font-weight: 600; color: #1e293b; }

    .table-card {
        background: white; border-radius: 12px; padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .table thead th { background: #f8fafc; color: #64748b; font-size: 0.75rem; border-bottom: 2px solid #e2e8f0; }
    .table td { padding: 12px 15px; font-size: 0.85rem; vertical-align: middle; }
    
    .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }

    @media print { .no-print { display: none !important; } .exec-banner { margin: 0; border-radius: 0; } }
</style>

<div class="container-fluid p-4">
    <div class="exec-banner d-flex justify-content-between align-items-center">
        <div>
            <h1>{{ s.full_name|upper }}</h1>
            <div class="student-meta">
                <span>S/O: <strong>{{ s.father_name }}</strong></span>
                <span class="meta-tag"><i class="fas fa-school me-1"></i> {{ s.student_class }} - {{ s.student_section }}</span>
                <span class="meta-tag"><i class="fas fa-users me-1"></i> {{ s.wing|upper }} WING</span>
                <span class="meta-tag"><i class="fas fa-hashtag me-1"></i> {{ s.roll_number }}</span>
            </div>
        </div>
        <div class="no-print d-flex gap-2">
            <a href="/admin/apsokara/student/{{ s.id }}/change/" class="btn btn-warning btn-sm fw-bold px-3">EDIT</a>
            <button onclick="window.print()" class="btn btn-light btn-sm fw-bold px-3">PRINT</button>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col"><div class="stat-box"><span class="stat-head">Total Days</span><span class="stat-num">{{ total_days }}</span></div></div>
        <div class="col"><div class="stat-box text-success"><span class="stat-head">Present</span><span class="stat-num">{{ present_count }}</span></div></div>
        <div class="col"><div class="stat-box text-danger"><span class="stat-head">Absent</span><span class="stat-num">{{ absent_count }}</span></div></div>
        <div class="col"><div class="stat-box text-warning"><span class="stat-head">Leaves</span><span class="stat-num">{{ leave_count }}</span></div></div>
        <div class="col"><div class="stat-box bg-primary text-white"><span class="stat-head text-white-50">Ratio</span><span class="stat-num">{{ percentage }}%</span></div></div>
    </div>

    <div class="details-card">
        <h6 class="fw-bold mb-4 text-uppercase" style="letter-spacing:1px; color:var(--slate-blue);"><i class="fas fa-database me-2"></i> Master Record</h6>
        <div class="detail-grid">
            <div class="detail-item"><span class="detail-label">B-Form / CNIC</span><span class="detail-value">{{ s.b_form }}</span></div>
            <div class="detail-item"><span class="detail-label">Date of Birth</span><span class="detail-value">{{ s.dob }}</span></div>
            <div class="detail-item"><span class="detail-label">Religion</span><span class="detail-value">{{ s.religion }}</span></div>
            <div class="detail-item"><span class="detail-label">Nationality</span><span class="detail-value">{{ s.nationality }}</span></div>
            <div class="detail-item"><span class="detail-label">Province</span><span class="detail-value">{{ s.province }}</span></div>
            <div class="detail-item"><span class="detail-label">Guardian Phone</span><span class="detail-value">{{ s.parents_phone }}</span></div>
            <div class="detail-item"><span class="detail-label">Wing Type</span><span class="detail-value">{{ s.wing }}</span></div>
            <div class="detail-item" style="grid-column: span 4;"><span class="detail-label">Home Address</span><span class="detail-value">{{ s.address }}</span></div>
        </div>
    </div>

    <div class="table-card">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h6 class="fw-bold m-0 text-uppercase" style="letter-spacing:1px;">Attendance Log History</h6>
            <form class="d-flex gap-2 no-print">
                <input type="date" name="start_date" class="form-control form-control-sm" value="{{ start_date }}">
                <input type="date" name="end_date" class="form-control form-control-sm" value="{{ end_date }}">
                <button class="btn btn-dark btn-sm px-3">Filter</button>
            </form>
        </div>
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>DATE</th>
                        <th>DAY</th>
                        <th>STATUS</th>
                        <th>REMARKS</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in attendance_history %}
                    <tr>
                        <td class="fw-bold text-dark">{{ record.date|date:"d M, Y" }}</td>
                        <td class="text-muted">{{ record.date|date:"l" }}</td>
                        <td>
                            {% if record.status == 'Present' %}
                                <span class="text-success fw-bold"><span class="status-dot bg-success"></span>Present</span>
                            {% elif record.status == 'Absent' %}
                                <span class="text-danger fw-bold"><span class="status-dot bg-danger"></span>Absent</span>
                            {% else %}
                                <span class="text-warning fw-bold"><span class="status-dot bg-warning"></span>Leave</span>
                            {% endif %}
                        </td>
                        <td class="text-muted italic small">{{ record.remarks|default:"---" }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center py-4">No data found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/base_nav.html ---

<div class="sidebar shadow">
    <div class="sidebar-header">
        <div class="sidebar-logo-main shadow-sm"></div>
        <h5 class="fw-bold mb-0 text-white" style="letter-spacing: 1px;">APS OKARA ADMIN</h5>
        <div class="online-indicator mt-2">
            <span class="dot"></span> <small class="text-uppercase" style="font-size: 0.65rem; color: #CAD2C5; letter-spacing: 1px;">System Active</small>
        </div>
    </div>
    
    <div class="nav flex-column mt-4 px-2" style="gap: 5px;">
        <a href="/hq-portal/" class="nav-btn {% if request.path == '/hq-portal/' %}active{% endif %}">
            <i class="fas fa-th-large"></i> <span>Dashboard</span>
        </a>
        
        <a href="/hq-portal/attendance/" class="nav-btn {% if 'attendance' in request.path %}active{% endif %}">
            <i class="fas fa-calendar-check"></i> <span>Attendance HQ</span>
        </a>

        <a href="/hq-portal/students/" class="nav-btn {% if 'students' in request.path %}active{% endif %}">
            <i class="fas fa-user-graduate"></i> <span>Students List</span>
        </a>

        <a href="/hq-portal/teachers/" class="nav-btn {% if 'teachers' in request.path %}active{% endif %}">
            <i class="fas fa-chalkboard-teacher"></i> <span>Teachers List</span>
        </a>
 
        <a href="/hq-portal/news-manager/" class="nav-btn {% if "news" in request.path %}active{% endif %}">
            <i class="fas fa-bullhorn"></i> <span>News Updates</span>
        </a>

        <div class="sidebar-label mt-4 mb-2">System Config</div>
        
        <a href="/admin/" class="nav-btn" target="_blank">
            <i class="fas fa-cog text-warning"></i> <span>System Admin</span>
        </a>
        
        <a href="/logout/" class="nav-btn text-danger mt-auto">
            <i class="fas fa-power-off"></i> <span>Sign Out</span>
        </a>
    </div>
</div>

<style>
    /* Professional Sidebar Styling */
    .sidebar { width: 260px; height: 100vh; background: var(--hq-primary); position: fixed; z-index: 1000; transition: 0.3s; }
    
    .sidebar-label { color: rgba(255,255,255,0.3); font-size: 0.7rem; font-weight: 800; text-transform: uppercase; padding-left: 15px; letter-spacing: 1px; }

    .nav-btn {
        display: flex;
        align-items: center;
        padding: 12px 18px;
        color: #CAD2C5;
        text-decoration: none;
        border-radius: 10px;
        transition: all 0.25s ease;
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 2px;
    }

    .nav-btn i { width: 28px; font-size: 1.1rem; transition: 0.3s; }
    .nav-btn span { transition: 0.2s; }

    /* Hover State */
    .nav-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        color: white;
        transform: translateX(5px);
    }

    /* Active State (Kis page par hain) */
    .nav-btn.active {
        background: var(--hq-accent) !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .nav-btn.active i { color: white !important; }

    /* Dot Indicator */
    .online-indicator .dot {
        height: 8px; width: 8px; background-color: #2ecc71; border-radius: 50%; display: inline-block;
        box-shadow: 0 0 8px #2ecc71;
    }
</style>

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/attendance.html ---

{% extends 'hq_admin_custom/base.html' %}

{% block title %}Attendance HQ | APS OKARA{% endblock title %}

{% block content %}
<style>
    /* Institutional Banner for Main HQ */
    .hq-institutional-banner {
        background: linear-gradient(135deg, var(--hq-primary) 0%, #1a252b 100%);
        color: white; border-radius: 15px; padding: 40px; margin-bottom: 30px;
        position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        border-left: 8px solid var(--hq-accent);
    }
    .hq-institutional-banner::after {
        content: '\f19c'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
        position: absolute; right: -20px; bottom: -20px; font-size: 18rem;
        opacity: 0.05; transform: rotate(-15deg);
    }
    .motto { font-style: italic; font-size: 0.95rem; opacity: 0.9; letter-spacing: 1px; }

    .hub-section {
        background: white; border: 1px solid var(--hq-border);
        border-radius: 15px; padding: 30px; margin-bottom: 30px;
    }
    .hub-header {
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 2px solid var(--hq-bg); padding-bottom: 20px; margin-bottom: 25px;
    }
    .ana-card-alt {
        text-align: center; padding: 20px; border-radius: 10px;
        background: #f8fafc; border: 1px solid #e2e8f0;
    }
    .ana-num { font-size: 2rem; font-weight: 800; display: block; color: var(--hq-primary); }
    .ana-label-alt { font-size: 0.7rem; font-weight: 700; color: #64748b; text-transform: uppercase; }

    .wing-card {
        background: white; border: 1px solid var(--hq-border);
        border-radius: 20px; padding: 40px; transition: 0.3s;
        text-decoration: none; color: inherit; display: block;
        position: relative; overflow: hidden;
    }
    .wing-card:hover { transform: translateY(-10px); border-color: var(--hq-accent); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
    .wing-card i { font-size: 3.5rem; color: var(--hq-accent); margin-bottom: 20px; }
    .wing-card h3 { font-weight: 800; color: var(--hq-primary); }
    .go-btn { position: absolute; bottom: 0; right: 0; background: var(--hq-primary); color: white; padding: 10px 25px; border-radius: 20px 0 0 0; font-size: 0.8rem; font-weight: bold; }
</style>

<div class="hq-institutional-banner d-flex justify-content-between align-items-center">
    <div>
        <div class="d-flex align-items-center mb-2">
            <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px;">
                <i class="fas fa-shield-halved fa-2x text-white"></i>
            </div>
            <h1 class="fw-black text-uppercase mb-0" style="letter-spacing: -1px;">Intelligence & Attendance HQ</h1>
        </div>
        <p class="motto mb-0">APS Okara Cantt ‚Äî Building a disciplined and enlightened future.</p>
        <div class="mt-3">
            <span class="badge bg-light text-dark px-3 py-2"><i class="fas fa-calendar-check me-2"></i>SESSION 2026-27</span>
            <span class="badge bg-light text-dark px-3 py-2 ms-2"><i class="fas fa-map-marker-alt me-2"></i>OKARA CANTT</span>
        </div>
    </div>
    <div class="text-end d-none d-md-block">
        <h4 class="mb-0 fw-bold">MAIN COMMAND</h4>
        <small class="opacity-75">Central Monitoring System</small>
    </div>
</div>

<div class="hub-section">
    <div class="hub-header">
        <h5 class="fw-bold mb-0 text-muted"><i class="fas fa-chart-pie me-2"></i>School-Wide Attendance Analytics</h5>
        <div class="d-flex gap-2 align-items-center">
            <span class="small fw-bold text-muted text-uppercase">Data Context:</span>
            <a href="/hq-portal/attendance/" class="btn btn-sm btn-dark px-3">TODAY</a>
            <form method="GET" class="d-flex gap-2"><input type="date" name="date" class="form-control form-control-sm w-auto" value="{{ today_date|date:"Y-m-d" }}" onchange="this.form.submit()"></form>
        </div>
    </div>
    <div class="row g-3">
        <div class="col-md-3"><div class="ana-card-alt"><span class="ana-num">{{ total_students }}</span><span class="ana-label-alt">Global Strength</span></div></div>
        <div class="col-md-3"><div class="ana-card-alt" style="border-bottom: 4px solid #10b981;"><span class="ana-num text-success">{{ present }}</span><span class="ana-label-alt">Present Assets</span></div></div>
        <div class="col-md-3"><div class="ana-card-alt" style="border-bottom: 4px solid #ef4444;"><span class="ana-num text-danger">{{ absent }}</span><span class="ana-label-alt">Absent Personnel</span></div></div>
        <div class="col-md-3"><div class="ana-card-alt" style="border-bottom: 4px solid #f59e0b;"><span class="ana-num text-warning">{{ leave }}</span><span class="ana-label-alt">Authorized Leave</span></div></div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <a href="/hq-portal/attendance/boys-wing/" class="wing-card">
            <i class="fas fa-mars"></i>
            <h3>BOYS WING</h3>
            <p class="text-muted">Explore boys' section from Junior to Senior levels. Manage records by class and section.</p>
            <div class="go-btn">ENTER WING <i class="fas fa-arrow-right ms-1"></i></div>
        </a>
    </div>
    <div class="col-md-6">
        <a href="/hq-portal/attendance/girls-wing/" class="wing-card">
            <i class="fas fa-venus"></i>
            <h3>GIRLS WING</h3>
            <p class="text-muted">Access girls' academic records, daily attendance trends, and class-wise reporting.</p>
            <div class="go-btn" style="background: var(--hq-accent);">ENTER WING <i class="fas fa-arrow-right ms-1"></i></div>
        </a>
    </div>
</div>
{% endblock content %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/teacher_profile.html ---

{% extends 'hq_admin_custom/base.html' %}
{% block content %}
<style>
    :root { --hq-primary: #2F3E46; --hq-accent: #52796F; }
    .profile-header { background: var(--hq-primary); color: white; padding: 40px; border-radius: 15px; margin-bottom: 25px; }
    .info-card { background: white; border-radius: 12px; border: 1px solid #e2e8f0; padding: 25px; height: 100%; }
    .label-pro { font-size: 0.7rem; color: #94a3b8; font-weight: 800; text-transform: uppercase; margin-bottom: 4px; display: block; }
    .value-pro { font-weight: 700; color: var(--hq-primary); font-size: 1.1rem; }
    .avatar-placeholder { width: 100px; height: 100px; background: var(--hq-accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; border: 4px solid rgba(255,255,255,0.2); }
</style>

<div class="container-fluid p-4">
    <div class="profile-header shadow">
        <div class="d-flex align-items-center gap-4">
            <div class="avatar-placeholder">{{ teacher.full_name|slice:":1" }}</div>
            <div>
                <h1 class="fw-bold mb-1">{{ teacher.full_name|upper }}</h1>
                <p class="mb-0 opacity-75"><i class="fas fa-id-badge me-2"></i> {{ teacher.cnic }} | {{ teacher.assigned_wing }} Wing</p>
                <div class="mt-3">
                    <span class="badge {% if teacher.is_class_teacher %}bg-success{% else %}bg-secondary{% endif %} px-3 py-2">
                        {% if teacher.is_class_teacher %}Class Teacher ({{ teacher.assigned_class }}-{{ teacher.assigned_section }}){% else %}Subject Teacher{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-8">
            <div class="info-card shadow-sm">
                <h5 class="fw-bold mb-4" style="color: var(--hq-accent); border-bottom: 2px solid #f1f5f9; padding-bottom: 10px;">
                    <i class="fas fa-user-circle me-2"></i>Personal Biodata
                </h5>
                <div class="row g-4">
                    <div class="col-md-6">
                        <span class="label-pro">Father's Name</span>
                        <div class="value-pro">{{ teacher.father_name|default:"---" }}</div>
                    </div>
                    <div class="col-md-6">
                        <span class="label-pro">Contact Number</span>
                        <div class="value-pro text-success">{{ teacher.contact }}</div>
                    </div>
                    <div class="col-md-6">
                        <span class="label-pro">Assigned Section</span>
                        <div class="value-pro">
                            {% if teacher.assigned_class %}
                                {{ teacher.assigned_class }}-{{ teacher.assigned_section }} ({{ teacher.assigned_wing }})
                            {% else %}
                                Not Assigned
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <span class="label-pro">CNIC Number</span>
                        <div class="value-pro">{{ teacher.cnic }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="info-card shadow-sm text-center">
                <h5 class="fw-bold mb-4 text-start"><i class="fas fa-tasks me-2"></i>Management</h5>
                <div class="d-grid gap-2">
                    <button class="btn btn-dark py-2"><i class="fas fa-edit me-2"></i> Edit Data</button>
                    {% if teacher.assigned_class %}
                    <a href="/hq-portal/class-view/{{ teacher.assigned_class }}/{{ teacher.assigned_section }}/" class="btn btn-outline-primary py-2">
                        <i class="fas fa-external-link-alt me-2"></i> Go to Class Dashboard
                    </a>
                    {% endif %}
                    <hr>
                    <a href="{% url 'teacher_master_list' %}" class="btn btn-light btn-sm text-muted">‚Üê Back to Ledger</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/base.html ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}APS OKARA | HQ Portal{% endblock title %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { 
            --hq-primary: #2F3E46; /* Professional Dark Slate */
            --hq-accent: #52796F;  /* Army Green/Grey Tone */
            --hq-border: #e2e8f0;
            --hq-bg: #f8fafc;
        }
        
        body { background-color: var(--hq-bg); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; }
        
        /* Classic Sidebar */
        .sidebar { 
            position: fixed; top: 0; left: 0; height: 100vh; width: 260px; 
            background: var(--hq-primary); color: white; z-index: 1000;
        }
        .sidebar-header { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .sidebar-logo-main { 
            width: 75px; height: 75px; border-radius: 50%; border: 3px solid var(--hq-accent); 
            margin: 0 auto 15px; background-image: url('/static/sami.png'); 
            background-size: cover; background-position: center;
        }
        .nav-link { color: #CAD2C5; padding: 14px 25px; display: flex; align-items: center; gap: 12px; text-decoration: none; transition: 0.2s; font-size: 0.95rem; }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: var(--hq-accent); color: white; border-left: 4px solid #fff; }

        /* Clean Classic Top Bar */
        .top-bar { 
            position: fixed; top: 0; left: 260px; right: 0; height: 70px; 
            background: #ffffff; display: flex; align-items: center; justify-content: space-between; 
            padding: 0 35px; z-index: 999; border-bottom: 1px solid var(--hq-border);
        }

        /* Search Section */
        .search-wrap { flex: 1; max-width: 400px; position: relative; }
        .search-field { 
            width: 100%; border: 1px solid var(--hq-border); padding: 8px 15px 8px 40px; 
            border-radius: 6px; background: #f1f5f9; font-size: 0.9rem;
        }
        .search-field:focus { outline: none; border-color: var(--hq-accent); background: #fff; }
        .search-ico { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        /* Clock & Date Section */
        .info-capsule { display: flex; align-items: center; gap: 15px; border-right: 1px solid var(--hq-border); padding-right: 20px; margin-right: 20px; }
        .date-display { text-align: right; line-height: 1; border-right: 2px solid var(--hq-accent); padding-right: 10px; }
        .date-display small { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .date-display span { display: block; font-size: 0.85rem; font-weight: 800; color: var(--hq-primary); }
        .time-display { font-size: 1.1rem; font-weight: 700; color: var(--hq-primary); font-family: 'Consolas', monospace; }

        /* Profile Area */
        .profile-box { display: flex; align-items: center; gap: 12px; }
        .top-pfp { width: 40px; height: 40px; border-radius: 4px; background-image: url('/static/sami.png'); background-size: cover; border: 1px solid var(--hq-border); }
        
        .main-wrapper { margin-left: 260px; padding-top: 70px; }
        .content-body { padding: 35px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <div class="sidebar-logo-main"></div>
        <h6 class="fw-bold mb-0">APS OKARA HQ</h6>
        <small class="opacity-50">ESTABLISHED 2026</small>
    </div>
    <div class="mt-3">
        <a href="/hq-portal/" class="nav-link active"><i class="fas fa-th-large"></i> Dashboard</a>
        <a href="/hq-portal/attendance/" class="nav-link"><i class="fas fa-calendar-check"></i> Attendance</a>
        <div style="margin-top: 200px; border-top: 1px solid rgba(255,255,255,0.05);">
            <a href="/admin/" class="nav-link small"><i class="fas fa-database"></i> Database</a>
            <a href="/admin/logout/" class="nav-link text-danger"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </div>
</div>

<div class="top-bar">
    <form action="/hq-portal/search/" method="GET" class="search-wrap">
        <i class="fas fa-search search-ico"></i>
        <input type="text" name="q" class="search-field" placeholder="Search by Name or CNIC..." required>
    </form>

    <div class="d-flex align-items-center">
        <div class="info-capsule">
            <div class="date-display">
                <small id="day-name">Loading</small>
                <span id="date-num">-- --</span>
            </div>
            <div class="time-display" id="live-clock">00:00:00</div>
        </div>

        <div class="profile-box">
            <div class="text-end d-none d-lg-block">
                <div class="fw-bold small">{{ user.username|upper }}</div>
                <div style="font-size: 0.7rem; color: var(--hq-accent); font-weight: 700;">ADMINISTRATOR</div>
            </div>
            <div class="top-pfp"></div>
        </div>
    </div>
</div>

<div class="main-wrapper">
    <div class="content-body">
{% include "hq_admin_custom/base_nav.html" %}
        {% block content %}{% endblock content %}
    </div>
</div>

<script>
    function refreshClock() {
        const now = new Date();
        document.getElementById('live-clock').textContent = now.toLocaleTimeString('en-GB');
        document.getElementById('day-name').textContent = now.toLocaleString('en-us', {weekday: 'short'}).toUpperCase();
        document.getElementById('date-num').textContent = now.getDate() + " " + now.toLocaleString('en-us', {month: 'short'}).toUpperCase();
    }
    setInterval(refreshClock, 1000);
    refreshClock();
</script>

</body>
</html>

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/news_manager.html ---

{% extends 'hq_admin_custom/dashboard.html' %}
{% block content %}
<div class="container mt-4" style="font-family: 'Inter', sans-serif; color: #333;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 style="font-weight: 800; color: #1a202c;">Announcement Manager</h3>
        <span class="badge badge-success p-2 px-3" style="border-radius: 50px;">Portal Active</span>
    </div>

    <div class="card border-0 shadow-sm mb-5" style="border-radius: 12px; background: #ffffff; border-top: 5px solid #800000;">
        <div class="card-body p-4">
            <h5 id="form-title" class="mb-4" style="font-weight: 700; color: #800000;">
                <i class="fas fa-bullhorn mr-2"></i>Create New Announcement
            </h5>
            <form method="POST" id="mainForm">
                {% csrf_token %}
                <input type="hidden" name="news_id" id="news_id">
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="small font-weight-bold text-muted text-uppercase">Message Content</label>
                        <textarea name="content" id="content" class="form-control" rows="2" placeholder="Write news details..." required style="border-radius: 8px; border: 1px solid #ddd;"></textarea>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="small font-weight-bold text-muted text-uppercase">Target Audience</label>
                        <select name="target_role" id="target_role" class="form-control" style="border-radius: 8px; font-weight: 600;">
                            <option value="All">üì¢ Everyone</option>
                            <option value="Student">üéì Students</option>
                            <option value="Class Teacher">üë®‚Äçüè´ Class Teachers</option>
                            <option value="Subject Teacher">üìñ Subject Teachers</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="small font-weight-bold text-muted text-uppercase">Start Date</label>
                        <input type="date" name="start_date" id="start_date" class="form-control" required value="{{ today }}" style="border-radius: 8px;">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="small font-weight-bold text-muted text-uppercase">End Date</label>
                        <input type="date" name="end_date" id="end_date" class="form-control" required style="border-radius: 8px;">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-block text-white shadow" style="background: #800000; border-radius: 8px; font-weight: 700; height: 38px;">
                            SAVE & PUBLISH
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <h5 class="mb-4" style="font-weight: 700; color: #2d3748;">
        <i class="fas fa-broadcast-tower text-success mr-2"></i>Live Announcements
    </h5>
    <div class="row">
        {% for n in active_news %}
        <div class="col-md-6 mb-4">
            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; border-bottom: 4px solid #edf2f7 !important;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center">
                            <div style="width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; margin-right: 8px;"></div>
                            <span class="small font-weight-bold text-uppercase text-muted">Audience: </span>
                            <span class="badge badge-pill badge-primary ml-2 px-3 py-1" style="font-size: 0.8rem; letter-spacing: 0.5px;">
                                {{ n.target_role|upper }}
                            </span>
                        </div>
                        <div class="btn-group">
                            <button onclick="fillEdit('{{n.id}}','{{n.target_role}}','{{n.start_date|date:'Y-m-d'}}','{{n.end_date|date:'Y-m-d'}}','{{n.content|escapejs}}')" 
                                    class="btn btn-sm btn-outline-secondary border-0 mr-1" title="Edit">‚úèÔ∏è</button>
                            <a href="{% url 'delete_news' n.id %}" class="btn btn-sm btn-outline-danger border-0" onclick="return confirm('Delete this?')">üóëÔ∏è</a>
                        </div>
                    </div>
                    
                    <p class="card-text mb-4" style="font-size: 1.1rem; font-weight: 500; color: #1a202c; line-height: 1.4;">
                        {{ n.content }}
                    </p>
                    
                    <div class="bg-light p-2 px-3 d-flex justify-content-between align-items-center" style="border-radius: 8px; font-size: 0.85rem;">
                        <span class="text-muted"><i class="far fa-calendar-check mr-1"></i> {{ n.start_date }}</span>
                        <span class="font-weight-bold text-danger">Until: {{ n.end_date }}</span>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12 text-center py-5">
            <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="80" class="mb-3" style="opacity: 0.3;">
            <p class="text-muted">No active announcements for any audience.</p>
        </div>
        {% endfor %}
    </div>

    <div class="mt-5 d-flex justify-content-between align-items-end mb-3">
        <h5 style="font-weight: 700; color: #718096;"><i class="fas fa-history mr-2"></i>Past History</h5>
        <input type="text" id="hSearch" class="form-control form-control-sm w-25 shadow-sm" placeholder="Search archive..." onkeyup="sHist()" style="border-radius: 20px;">
    </div>
    <div class="card border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
        <table class="table table-hover mb-0" id="hTable">
            <thead class="bg-light">
                <tr class="small text-muted text-uppercase">
                    <th class="px-4">Audience</th>
                    <th>Message</th>
                    <th class="text-right px-4">Expired Date</th>
                </tr>
            </thead>
            <tbody>
                {% for n in expired_news %}
                <tr class="text-muted">
                    <td class="px-4 align-middle font-weight-bold">FOR: {{ n.target_role|upper }}</td>
                    <td class="align-middle">{{ n.content }}</td>
                    <td class="text-right px-4 align-middle">{{ n.end_date }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function fillEdit(id, role, s, e, c) {
    document.getElementById('news_id').value = id;
    document.getElementById('target_role').value = role;
    document.getElementById('start_date').value = s;
    document.getElementById('end_date').value = e;
    document.getElementById('content').value = c;
    document.getElementById('form-title').innerHTML = "<i class='fas fa-edit mr-2'></i> Edit Announcement Settings";
    window.scrollTo({top: 0, behavior: 'smooth'});
}
function sHist() {
    let input = document.getElementById('hSearch').value.toUpperCase();
    let rows = document.getElementById('hTable').getElementsByTagName('tr');
    for (let i = 1; i < rows.length; i++) {
        rows[i].style.display = rows[i].innerText.toUpperCase().includes(input) ? "" : "none";
    }
}
</script>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/teachers_list.html ---

{% extends 'hq_admin_custom/base.html' %}
{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark"><i class="fas fa-chalkboard-teacher me-2"></i>Teacher Staff</h2>
        <span class="badge bg-dark px-3 py-2">Total: {{ total_count }}</span>
    </div>

    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body p-3">
            <form method="GET" class="row g-2">
                <div class="col-md-10">
                    <input type="text" name="q" class="form-control" placeholder="Search by name, ID or phone..." value="{{ query }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark w-100">Search</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Teacher Name</th>
                        <th>ID / Code</th>
                        <th>Status</th>
                        <th class="text-end pe-4">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in teachers %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold">{{ t.full_name|upper }}</div>
                            <small class="text-muted">{{ t.phone_number }}</small>
                        </td>
                        <td><code class="text-dark fw-bold">{{ t.employee_id|default:t.id }}</code></td>
                        <td>
                            {% if t.is_class_teacher %}
                            <span class="badge bg-success-subtle text-success border border-success">Class Teacher</span>
                            {% else %}
                            <span class="badge bg-light text-muted border">Subject Teacher</span>
                            {% endif %}
                        </td>
                        <td class="text-end pe-4">
                            <a href="{% url 'teacher_profile' t.id %}" class="btn btn-sm btn-outline-dark">VIEW PROFILE</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center py-5 text-muted">No teachers found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/wing_detail.html ---

{% extends 'hq_admin_custom/base.html' %}
{% block title %}{{ wing_title }} | APS OKARA{% endblock title %}
{% block content %}
<style>
    /* New Institutional Banner */
    .wing-institutional-banner {
        background: linear-gradient(135deg, {{ theme_color }} 0%, #1a252b 100%);
        color: white; border-radius: 15px; padding: 35px; margin-bottom: 30px;
        position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    .wing-institutional-banner::after {
        content: '\f19c'; font-family: 'Font Awesome 6 Free'; font-weight: 900;
        position: absolute; right: -20px; bottom: -20px; font-size: 15rem;
        opacity: 0.05; transform: rotate(-15deg);
    }
    .motto { font-style: italic; font-size: 0.9rem; opacity: 0.9; letter-spacing: 1px; }
    
    .stat-pill { background: #fff; border-radius: 12px; padding: 15px 25px; border-top: 4px solid {{ theme_color }}; flex: 1; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
    .stat-pill h6 { font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 800; margin-bottom: 5px; }
    .stat-pill span { font-size: 1.8rem; font-weight: 900; color: #1e293b; }
    
    .alert-box { background: #fff; border: 1px solid #e2e8f0; border-radius: 15px; padding: 20px; margin-bottom: 25px; }
    .class-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 15px; padding: 22px; transition: 0.3s; cursor: pointer; }
    .class-card:hover { transform: translateY(-5px); border-color: {{ theme_color }}; box-shadow: 0 12px 24px rgba(0,0,0,0.08); }
    .badge-sec { background: {{ theme_color }}; color: #fff; padding: 4px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: 900; }
</style>

<div class="wing-institutional-banner d-flex justify-content-between align-items-center">
    <div>
        <div class="d-flex align-items-center mb-2">
            <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                <i class="fas fa-university fa-lg"></i>
            </div>
            <h1 class="fw-black text-uppercase mb-0" style="letter-spacing: -1px;">{{ wing_title }}</h1>
        </div>
        <p class="motto mb-0">I shall rise and shine ‚Äî Army Public School & College System, Okara Cantt.</p>
        <div class="mt-3">
            <span class="badge bg-light text-dark px-3">CAMPUS: OKARA</span>
            <span class="badge bg-light text-dark px-3 ms-2">ACADEMIC YEAR: 2026</span>
        </div>
    </div>
    <div class="text-end d-none d-md-block">
        <h5 class="mb-0 fw-bold">ADMINISTRATION PORTAL</h5>
        <small class="opacity-75">Control Level: Wing HQ</small>
    </div>
</div>

<div class="d-flex gap-3 mb-5">
    <div class="stat-pill"><h6>Total Strength</h6><span>{{ total_students }}</span></div>
    <div class="stat-pill" style="border-top-color: #10b981;"><h6>Present Today</h6><span class="text-success">{{ present }}</span></div>
    <div class="stat-pill" style="border-top-color: #ef4444;"><h6>Absent Today</h6><span class="text-danger">{{ absent }}</span></div>
    <div class="stat-pill" style="border-top-color: #f59e0b;"><h6>On Leave</h6><span class="text-warning">{{ leave }}</span></div>
</div>

<div class="row">
    <div class="col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="position-relative w-50">
                <i class="fas fa-search position-absolute" style="left: 15px; top: 12px; color: #94a3b8;"></i>
                <input type="text" id="classSearch" class="form-control ps-5" placeholder="Search class or section (e.g. 9th B)..." style="height: 45px; border-radius: 12px; border: 1px solid #e2e8f0;">
            </div>
            <div class="text-muted small fw-bold text-uppercase">Active Classes: {{ class_sections|length }}</div>
        </div>

        <div class="row g-3" id="classGrid">
            {% for item in class_sections %}
            <div class="col-md-3 class-item" data-name="{{ item.student_class }} {{ item.student_section }}">
                <a href="/hq-portal/attendance/mark/{{ item.student_class }}/{{ item.student_section }}/{{ wing_slug }}/" class="text-decoration-none">
                    <div class="class-card text-center">
                        <div class="text-muted small fw-bold mb-1">GRADE</div>
                        <div class="h3 fw-black mb-2" style="color: var(--hq-primary);">{{ item.student_class }}</div>
                        <span class="badge-sec">SEC {{ item.student_section }}</span>
                        <div class="mt-3 pt-3 border-top">
                            <span class="fw-bold text-muted small"><i class="fas fa-users me-1"></i>{{ item.total }} Students</span>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="col-lg-3">
        <div class="alert-box shadow-sm">
            <h6 class="fw-black text-danger mb-3" style="font-size: 0.75rem;"><i class="fas fa-bell me-2"></i>CRITICAL ATTENDANCE</h6>
            {% for alert in critical_classes %}
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded bg-light border">
                <span class="small fw-bold">{{ alert.student_class }}-{{ alert.student_section }}</span>
                <span class="badge bg-danger rounded-pill">{{ alert.absent_count }} Absent</span>
            </div>
            {% empty %}
            <div class="text-center py-3">
                <i class="fas fa-check-circle text-success mb-2"></i>
                <p class="small text-muted mb-0">No unusual absence today.</p>
            </div>
            {% endfor %}
        </div>

        <div class="card border-0 shadow-sm p-3 text-white" style="border-radius: 15px; background: {{ theme_color }};">
            <h6><i class="fas fa-info-circle me-2"></i>Quick Guide</h6>
            <p class="small mb-0 opacity-75">Select a class to mark attendance, edit records, or view specific student performance for today.</p>
        </div>
    </div>
</div>

<script>
    document.getElementById('classSearch').addEventListener('keyup', function() {
        let filter = this.value.toUpperCase();
        let cards = document.getElementsByClassName('class-item');
        for (let i = 0; i < cards.length; i++) {
            let name = cards[i].getAttribute('data-name').toUpperCase();
            cards[i].style.display = name.indexOf(filter) > -1 ? "" : "none";
        }
    });
</script>
{% endblock content %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/search_results.html ---

{% extends 'hq_admin_custom/base.html' %}
{% block content %}
<div class="p-4" style="background: var(--hq-bg); min-height: 100vh;">
    
    <div class="mb-4 d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm border-start border-4" style="border-color: var(--hq-primary) !important;">
        <div>
            <h2 class="fw-bold mb-0" style="color: var(--hq-primary); letter-spacing: -1px;">HQ Command Center</h2>
            <p class="text-muted mb-0 small text-uppercase fw-bold">Query: <span class="text-dark">{{ query }}</span> | Results: {{ total_found }}</p>
        </div>
        <div class="d-flex gap-2">
            <input type="text" id="tableFilter" class="form-control form-control-sm border-0 bg-light px-3" placeholder="Live filter results..." style="width: 250px; border-radius: 20px;">
            <a href="/hq-portal/" class="btn btn-sm btn-dark px-3" style="border-radius: 20px;">Exit</a>
        </div>
    </div>

    {% if students %}
    <div class="card border-0 shadow-sm mb-5" style="border-radius: 12px; overflow: hidden;">
        <div class="card-header border-0 p-3 d-flex justify-content-between align-items-center" style="background: var(--hq-primary); color: white;">
            <span><i class="fas fa-user-graduate me-2"></i> STUDENT DIRECTORY</span>
            <span class="badge bg-white text-dark small">{{ students|length }} Matches</span>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="studentTable">
                <thead style="background: #f8fafc;">
                    <tr>
                        <th class="ps-4">Full Name & Father</th>
                        <th>Roll No</th>
                        <th>Class Info</th>
                        <th>B-Form Number</th>
                        <th>Wing</th>
                        <th class="text-end pe-4">Control</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in students %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-dark">{{ s.full_name }}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">S/O: {{ s.father_name }}</div>
                        </td>
                        <td><span class="badge bg-light text-dark border">{{ s.roll_number }}</span></td>
                        <td>
                            <div class="fw-bold">{{ s.student_class }}</div>
                            <div class="small text-muted">{{ s.student_section }}</div>
                        </td>
                        <td class="font-monospace small">{{ s.b_form|default:"---" }}</td>
                        <td><span class="badge" style="background: var(--hq-accent);">{{ s.wing }}</span></td>
                        <td class="text-end pe-4">
                            <a href="/hq-portal/student/profile/{{ s.id }}/" class="btn btn-sm btn-outline-dark fw-bold">PROFILE</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if teachers %}
    <div class="card border-0 shadow-sm mb-5" style="border-radius: 12px; overflow: hidden;">
        <div class="card-header border-0 p-3" style="background: var(--hq-accent); color: white;">
            <i class="fas fa-chalkboard-teacher me-2"></i> FACULTY & STAFF RECORDS
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="teacherTable">
                <thead style="background: #f8fafc;">
                    <tr>
                        <th class="ps-4">Teacher Name</th>
                        <th>CNIC</th>
                        <th>Assigned Class</th>
                        <th>Contact</th>
                        <th class="text-end pe-4">Control</th>
                    </tr>
                </thead>
                <tbody>
                    {% for t in teachers %}
                    <tr>
                        <td class="ps-4 fw-bold text-dark">{{ t.full_name }}</td>
                        <td class="font-monospace small">{{ t.cnic }}</td>
                        <td>{{ t.assigned_class }}-{{ t.assigned_section }} ({{ t.assigned_wing }})</td>
                        <td>{{ t.contact }}</td>
                        <td class="text-end pe-4">
                            <a href="/hq-portal/teacher/profile/{{ t.id }}/" class="btn btn-sm btn-dark fw-bold">MANAGE</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if not students and not teachers %}
    <div class="text-center py-5 bg-white rounded shadow-sm border">
        <div class="display-1 text-muted opacity-25 mb-3"><i class="fas fa-search"></i></div>
        <h4 class="text-muted fw-bold">Database mein koi record nahi mila!</h4>
        <p class="text-muted small">Search query: "{{ query }}"</p>
    </div>
    {% endif %}
</div>

<script>
document.getElementById('tableFilter').addEventListener('keyup', function() {
    let value = this.value.toLowerCase();
    
    // Filter Student Table
    let studentRows = document.querySelectorAll("#studentTable tbody tr");
    studentRows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
    });

    // Filter Teacher Table
    let teacherRows = document.querySelectorAll("#teacherTable tbody tr");
    teacherRows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(value) ? "" : "none";
    });
});
</script>

<style>
    .table thead th { font-size: 0.75rem; color: #64748b; padding: 12px; border-bottom: 2px solid #edf2f7; }
    .table tbody td { padding: 12px; font-size: 0.9rem; border-bottom: 1px solid #f1f5f9; }
    .btn-outline-dark:hover { background: var(--hq-primary); color: white; border-color: var(--hq-primary); }
    #tableFilter:focus { box-shadow: 0 0 0 2px var(--hq-accent); outline: none; }
</style>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/students_list.html ---

{% extends 'hq_admin_custom/base.html' %}
{% block content %}
<style>
    .filter-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; }
    .student-table-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .table thead { background: #1e293b; color: white; }
    .table th { font-weight: 600; text-transform: uppercase; font-size: 0.75rem; padding: 15px; }
    .table td { vertical-align: middle; padding: 12px 15px; font-size: 0.9rem; }
    .badge-wing { padding: 5px 10px; border-radius: 6px; font-weight: 700; font-size: 0.7rem; }
</style>

<div class="container-fluid p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold"><i class="fas fa-user-graduate me-2 text-primary"></i> Student Directory</h2>
        <span class="badge bg-dark px-3 py-2">Total Records: {{ total_count }}</span>
    </div>

    <div class="filter-section no-print">
        <form method="GET" method="GET" class="row g-3">
            <div class="col-md-4">
                <label class="small fw-bold text-muted">Search Name, Roll, or B-Form</label>
                <div class="input-group">
                    <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                    <input type="text" name="q" class="form-control bg-light border-start-0" placeholder="Type to search..." value="{{ query }}">
                </div>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold text-muted">Filter Wing</label>
                <select name="wing" class="form-select bg-light">
                    <option value="">All Wings</option>
                    {% for w in wings_list %}
                    <option value="{{ w }}" {% if w == selected_wing %}selected{% endif %}>{{ w }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="small fw-bold text-muted">Filter Class</label>
                <select name="class" class="form-select bg-light">
                    <option value="">All Classes</option>
                    {% for c in classes_list %}
                    <option value="{{ c }}" {% if c == selected_class %}selected{% endif %}>{{ c }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary px-4 fw-bold">Apply Filters</button>
                <a href="?" class="btn btn-outline-secondary px-4 fw-bold">Reset</a>
            </div>
        </form>
    </div>

    <div class="student-table-card">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Roll No</th>
                        <th>Student Name</th>
                        <th>Father's Name</th>
                        <th>Wing</th>
                        <th>Class & Sec</th>
                        <th>B-Form</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in page_obj %}
                    <tr>
                        <td class="fw-bold text-primary">#{{ s.roll_number }}</td>
                        <td class="fw-bold">{{ s.full_name|upper }}</td>
                        <td class="text-muted">{{ s.father_name }}</td>
                        <td>
                            <span class="badge-wing {% if s.wing == 'Boys' %}bg-primary-subtle text-primary border border-primary{% else %}bg-danger-subtle text-danger border border-danger{% endif %}">
                                {{ s.wing|upper }}
                            </span>
                        </td>
                        <td><span class="fw-semibold">{{ s.student_class }}</span> <small class="text-muted">({{ s.student_section }})</small></td>
                        <td class="small">{{ s.b_form }}</td>
                        <td class="text-center">
                            <a href="{% url 'student_profile' s.id %}" class="btn btn-sm btn-dark px-3 rounded-pill shadow-sm">View Profile</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="7" class="text-center py-5 text-muted">No students found matching your criteria.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% if page_obj.has_other_pages %}
        <div class="p-4 border-top d-flex justify-content-center">
            <nav>
                <ul class="pagination pagination-sm mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&q={{ query }}&wing={{ selected_wing }}&class={{ selected_class }}">Previous</a></li>
                    {% endif %}
                    
                    <li class="page-item active"><span class="page-link px-4">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>

                    {% if page_obj.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&q={{ query }}&wing={{ selected_wing }}&class={{ selected_class }}">Next</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/hq_admin_custom/classroom_detail.html ---

{% extends 'hq_admin_custom/base.html' %}
{% block title %}Class Registry | {{ class_name }}{% endblock title %}
{% block content %}
<style>
    @media print {
        body * { visibility: hidden; }
        .printable-area, .printable-area * { visibility: visible; }
        .printable-area { position: absolute; left: 0; top: 0; width: 100%; border: none; }
        .no-print { display: none !important; }
    }
    .aps-official-banner {
        background: var(--hq-primary); color: white; padding: 25px 35px; border-radius: 4px;
        margin-bottom: 20px; border-left: 12px solid var(--hq-accent);
        display: flex; justify-content: space-between; align-items: center;
    }
    .analytics-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 25px; }
    .stat-card { background: white; border: 1px solid #000; padding: 12px; border-radius: 4px; text-align: center; }
    .stat-card .label { display: block; font-size: 0.7rem; font-weight: 800; color: #475569; text-transform: uppercase; }
    .stat-card .value { font-size: 1.6rem; font-weight: 900; color: #000; }
    .history-card { background: white; border: 2px solid #000; border-radius: 4px; overflow: hidden; }
    .ledger-table { width: 100%; border-collapse: collapse; }
    .ledger-table th { background: #2F3E46; color: white; padding: 12px; font-size: 0.85rem; text-transform: uppercase; border: 1px solid #000; }
    .ledger-table td { padding: 12px; font-size: 1rem; font-weight: 700; color: #000; border: 1px solid #dee2e6; }
    .row-link:hover { background-color: #fef08a !important; cursor: pointer; }
</style>

<div class="aps-official-banner no-print shadow-sm">
    <div class="banner-content">
        <p>APS OKARA HQ / {{ wing_name|upper }} WING</p>
        <h1>CLASS {{ class_name }} - SECTION {{ section_name }}</h1>
        <p class="mt-1"><i class="fas fa-user-tie me-2"></i>CLASS IN-CHARGE: {{ class_teacher|upper }}</p>
    </div>
</div>

<div class="analytics-row no-print">
    <div class="stat-card"><span class="label">Total</span><span class="value">{{ total_count }}</span></div>
    <div class="stat-card" style="border-bottom: 5px solid #10b981;"><span class="label text-success">Present</span><span class="value text-success">{{ present }}</span></div>
    <div class="stat-card" style="border-bottom: 5px solid #ef4444;"><span class="label text-danger">Absent</span><span class="value text-danger">{{ absent }}</span></div>
    <div class="stat-card" style="border-bottom: 5px solid #f59e0b;"><span class="label text-warning">Leave</span><span class="value text-warning">{{ leave }}</span></div>
    <div class="stat-card" style="border-bottom: 5px solid #64748b;">
        <span class="label text-secondary">Not Marked</span>
        <span class="value text-secondary" id="notMarkedCount">
            0
        </span>
    </div>
</div>

<div class="history-card printable-area">
    <div class="p-3 bg-light no-print d-flex justify-content-between border-bottom border-dark">
        <div class="d-flex gap-3 align-items-center">
            <h5 class="mb-0 fw-black">REGISTRY - {{ selected_date|default:today_date }}</h5>
            <form method="GET"><input type="date" name="date" class="form-control form-control-sm border-dark fw-bold" value="{{ selected_date }}" onchange="this.form.submit()"></form>
        </div>
        <div class="d-flex gap-2">
            <input type="text" id="clerkSearch" class="form-control form-control-sm border-dark fw-bold" placeholder="Search..." style="width: 200px;">
            <button onclick="window.print()" class="btn btn-dark btn-sm fw-bold"><i class="fas fa-print me-1"></i>PRINT</button>
        </div>
    </div>

    <table class="ledger-table">
        <thead>
            <tr>
                <th class="text-center" style="width: 100px;">Roll No</th>
                <th>Full Name</th>
                <th>Father Name</th>
                <th>B-Form / Identity</th>
                <th class="text-center">Status</th>
            </tr>
        </thead>
        <tbody id="clerkTableBody">
            {% for record in attendance_data %}
            <tr class="row-link row-hover" ondblclick="window.location.href='/hq-portal/student/profile/{{ record.student.id }}/'">
                <td class="text-center fw-black">{{ record.student.roll_number }}</td>
                <td>{{ record.student.full_name|upper }}</td>
                <td>{{ record.student.father_name|upper }}</td>
                <td>{{ record.student.b_form }}</td>
                <td class="text-center">
                    <span class="fw-black 
                        {% if not record.status or record.status == '' %}text-secondary
                        {% elif record.status|upper == 'PRESENT' %}text-success
                        {% elif record.status|upper == 'ABSENT' %}text-danger
                        {% else %}text-warning{% endif %}">
                        {{ record.status|upper|default:"NOT MARKED" }}
                    </span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // JS Logic to calculate Not Marked without Template Errors
    document.addEventListener('DOMContentLoaded', function() {
        const total = parseInt("{{ total_count }}") || 0;
        const p = parseInt("{{ present }}") || 0;
        const a = parseInt("{{ absent }}") || 0;
        const l = parseInt("{{ leave }}") || 0;
        const notMarked = total - (p + a + l);
        document.getElementById('notMarkedCount').innerText = notMarked > 0 ? notMarked : 0;
    });

    const searchInput = document.getElementById('clerkSearch');
    const tableRows = document.querySelectorAll('.row-hover');
    searchInput.addEventListener('keyup', function() {
        const query = searchInput.value.toUpperCase();
        tableRows.forEach(row => { row.style.display = row.innerText.toUpperCase().includes(query) ? "" : "none"; });
    });
</script>
{% endblock content %}

--- FILE: /home/sami/sumyaman/templates/admin/index.html ---

{% extends "admin/index.html" %}
{% block content %}
<style>
    .dash-wrapper { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 10px; }
    .wing-section { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 10px; }
    .wing-box { flex: 1; min-width: 300px; background: #f4f7f6; padding: 20px; border-radius: 15px; border: 1px solid #ddd; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .class-tag { display: inline-block; padding: 8px 15px; background: white; border: 1px solid #1a237e; margin: 5px; border-radius: 8px; text-decoration: none; color: #1a237e; font-weight: 600; font-size: 13px; transition: 0.3s; }
    .class-tag:hover { background: #1a237e; color: white; transform: translateY(-3px); box-shadow: 0 4px 10px rgba(26, 35, 126, 0.2); }
    .wing-title { color: #1a237e; border-bottom: 2px solid #1a237e; padding-bottom: 10px; margin-top: 0; display: flex; align-items: center; gap: 10px; }
</style>

<div class="dash-wrapper">
    <div class="wing-section">
        {% for wing_name, classes in wings.items %}
        <div class="wing-box">
            <h2 class="wing-title">üèõÔ∏è {{ wing_name }} Wing</h2>
            <div style="margin-top: 15px;">
                {% for c in classes %}
                <a href="/admin/class-detail/{{ wing_name }}/{{ c.student_class }}/{{ c.student_section }}/?date={{ stats.date }}" class="class-tag">
                    Grade {{ c.student_class }}-{{ c.student_section }}
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<hr>
{{ block.super }}
{% endblock %}

--- FILE: /home/sami/sumyaman/templates/admin/class_detail.html ---

{% extends "admin/base_site.html" %}
{% block content %}
<div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05);">
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #1a237e; padding-bottom: 15px; margin-bottom: 20px;">
        <h1 style="margin:0; color:#1a237e;">Grade {{ info.class }}-{{ info.sec }} ({{ info.wing }})</h1>
        <form method="GET" style="display: flex; gap: 10px; align-items: center;">
            <input type="date" name="date" value="{{ info.date }}" onchange="this.form.submit()">
            <input type="hidden" name="range" value="{{ stats.range }}">
        </form>
    </div>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px;">
        <div style="background:#e3f2fd; padding:15px; border-radius:10px; text-align:center;"><b>Total:</b> {{ stats.total }}</div>
        <div style="background:#e8f5e9; padding:15px; border-radius:10px; text-align:center;"><b>Present:</b> {{ stats.present }}</div>
        <div style="background:#ffebee; padding:15px; border-radius:10px; text-align:center;"><b>Absent:</b> {{ stats.absent }}</div>
        <div style="background:#fff3e0; padding:15px; border-radius:10px; text-align:center;"><b>Leave:</b> {{ stats.leave }}</div>
    </div>
    <table style="width: 100%; border-collapse: collapse; background: white;">
        <thead>
            <tr style="background: #1a237e; color: white;">
                <th style="padding: 12px; border: 1px solid #ddd;">Roll No</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Student Name</th>
                <th style="padding: 12px; border: 1px solid #ddd;">Status ({{ info.date }})</th>
            </tr>
        </thead>
        <tbody>
            {% for s in student_list %}
            <tr style="text-align: center;">
                <td style="padding: 10px; border: 1px solid #ddd;">{{ s.roll }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: left;">{{ s.name }}</td>
                <td style="padding: 10px; border: 1px solid #ddd; font-weight: bold; color: {% if s.status == 'Present' %}#28a745{% elif s.status == 'Absent' %}#dc3545{% elif s.status == 'Leave' %}#ffc107{% else %}#999{% endif %};">
                    {{ s.status }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <br><a href="/admin/" class="button" style="background: #666;">‚Üê Back to Dashboard</a>
</div>
{% endblock %}
--- FILE: /home/sami/sumyaman/templates/classroom_detail.html ---

{% extends 'base.html' %}
{% block content %}
<style>
    /* Professional Banner Style */
    .class-banner { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; padding: 30px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .stat-card { background: white; border-radius: 12px; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-top: 4px solid #3b82f6; }
    .nav-tabs .nav-link { color: #4b5563; font-weight: 600; border: none; padding: 12px 25px; }
    .nav-tabs .nav-link.active { color: #1e3a8a; border-bottom: 3px solid #1e3a8a; background: transparent; }
    
    /* Search Bar & Filter Styling */
    .filter-box { background: #f9fafb; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e5e7eb; }

    /* Print Specific Styling */
    @media print {
        body * { visibility: hidden; }
        #printableAttendance, #printableAttendance * { visibility: visible; }
        #printableAttendance { position: absolute; left: 0; top: 0; width: 100%; }
        .no-print { display: none !important; }
    }
</style>

<div class="container mt-4">
    <div class="class-banner d-flex justify-content-between align-items-center">
        <div>
            <h1 class="display-5 fw-bold">Class {{ class_name }} - {{ section }}</h1>
            <p class="mb-0"><i class="fas fa-school"></i> {{ wing_name }} Wing | Gatekeeper V3 Professional Panel</p>
        </div>
        <div class="text-end">
            <span class="badge bg-light text-primary px-3 py-2 fs-6">{{ today }}</span>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3"><div class="stat-card"><h5>Total Students</h5><h3>{{ stats.total }}</h3></div></div>
        <div class="col-md-3"><div class="stat-card" style="border-color: #10b981;"><h5>Present</h5><h3>{{ stats.present_today }}</h3></div></div>
        <div class="col-md-3"><div class="stat-card" style="border-color: #ef4444;"><h5>Absent</h5><h3>{{ stats.absent_today }}</h3></div></div>
        <div class="col-md-3"><div class="stat-card" style="border-color: #f59e0b;"><h5>On Leave</h5><h3>{{ stats.leave_today }}</h3></div></div>
    </div>

    <ul class="nav nav-tabs no-print" id="classroomTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">Attendance History</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="leaves-tab" data-bs-toggle="tab" data-bs-target="#leaves" type="button">Leaves Management</button>
        </li>
    </ul>

    <div class="tab-content mt-4" id="classroomTabsContent">
        <div class="tab-pane fade show active" id="history" role="tabpanel">
            <div class="filter-box no-print d-flex gap-3 flex-wrap">
                <input type="text" id="studentSearch" class="form-control w-25" placeholder="Search Student/ID...">
                <input type="date" class="form-control w-auto" value="{{ today|date:'Y-m-d' }}">
                <select class="form-select w-auto">
                    <option>All Status</option><option>Present</option><option>Absent</option><option>Leave</option>
                </select>
                <button onclick="window.print()" class="btn btn-dark"><i class="fas fa-print"></i> Print Sheet</button>
            </div>
            
            <div id="printableAttendance">
                <h4 class="d-none d-print-block">Attendance Sheet: Class {{ class_name }}-{{ section }} ({{ today }})</h4>
                <table class="table table-hover border">
                    <thead class="table-light">
                        <tr>
                            <th>ID Number</th><th>Student Name</th><th>Father Name</th><th>Status</th><th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceBody">
                        {% for record in attendance_history %}
                        <tr>
                            <td>{{ record.student.cnic }}</td>
                            <td>{{ record.student.full_name }}</td>
                            <td>{{ record.student.father_full_name }}</td>
                            <td>
                                <span class="badge {% if record.status == 'Present' %}bg-success{% elif record.status == 'Absent' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                    {{ record.status }}
                                </span>
                            </td>
                            <td>{{ record.time|time:"H:i" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center">No records found for this selection.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="leaves" role="tabpanel">
            <div class="filter-box d-flex gap-3">
                <input type="text" class="form-control w-25" placeholder="Search Leaves...">
                <select class="form-select w-auto">
                    <option>All Status</option><option>Pending</option><option>Approved</option><option>Rejected</option>
                </select>
            </div>
            <table class="table border">
                <thead class="table-light">
                    <tr>
                        <th>Student</th><th>Dates</th><th>Reason</th><th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in leaves %}
                    <tr>
                        <td>{{ leave.full_name }}</td>
                        <td>{{ leave.from_date }} to {{ leave.to_date }}</td>
                        <td>{{ leave.reason|truncatechars:30 }}</td>
                        <td>
                            <span class="badge {% if leave.status == 'Approved' %}bg-success{% elif leave.status == 'Pending' %}bg-primary{% else %}bg-danger{% endif %}">
                                {{ leave.status }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Simple Filter Wiring
    document.getElementById('studentSearch').addEventListener('keyup', function() {
        let val = this.value.toLowerCase();
        let rows = document.querySelectorAll('#attendanceBody tr');
        rows.forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none';
        });
    });
</script>
{% endblock %}

--- FILE: /home/sami/sumyaman/manage.py ---

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'sumyaman_pro.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

--- FILE: /home/sami/sumyaman/hq_admin/attendance_pro.py ---

import streamlit as st
import pandas as pd
from apsokara.models import Attendance, Student

def show_attendance_viewer():
    st.header("üìÖ Attendance Radar")
    
    col1, col2 = st.columns(2)
    with col1:
        target_date = st.date_input("Select Date")
    with col2:
        view_type = st.selectbox("View By", ["All", "Boys Wing", "Girls Wing"])

    # Query Attendance
    qs = Attendance.objects.filter(date=target_date)
    
    if view_type != "All":
        wing_name = "Boys" if "Boys" in view_type else "Girls"
        qs = qs.filter(student__wing=wing_name)

    if qs.exists():
        data = []
        for att in qs:
            data.append({
                "Student": att.student.full_name,
                "Roll No": att.student.roll_number,
                "Class": att.student.student_class,
                "Status": att.status
            })
        df = pd.DataFrame(data)
        
        # Stats Cards
        p_count = len(df[df['Status'] == 'Present'])
        a_count = len(df[df['Status'] == 'Absent'])
        
        c1, c2 = st.columns(2)
        c1.metric("Present ‚úÖ", p_count)
        c2.metric("Absent ‚ùå", a_count)
        
        st.dataframe(df, use_container_width=True)
    else:
        st.warning(f"No attendance records found for {target_date}")

--- FILE: /home/sami/sumyaman/hq_admin/__init__.py ---


--- FILE: /home/sami/sumyaman/hq_admin/student_pro.py ---

import streamlit as st
import pandas as pd
from apsokara.models import Student

def show_student_manager():
    st.subheader("üë®‚Äçüéì Student Database (Secure View)")
    
    # Privacy Toggle
    privacy_on = st.toggle("üîí Privacy Mode (Mask Sensitive Data)", value=True)
    
    # Search
    search = st.text_input("üîç Search Student (Name/Roll No)")
    
    if search:
        qs = Student.objects.filter(full_name__icontains=search) | \
             Student.objects.filter(roll_number__icontains=search)
    else:
        qs = Student.objects.all().order_by('-id')[:20]

    if qs.exists():
        data = []
        for s in qs:
            # Privacy Logic: Data ko chupa dena agar toggle on ho
            phone = "XXXX-XXXXXXX" if privacy_on else s.parents_phone
            b_form = "XXXXX-XXXXXXX-X" if privacy_on else s.b_form
            
            data.append({
                "ID": s.id,
                "Full Name": s.full_name,
                "Roll No": s.roll_number,
                "Class": s.student_class,
                "B-Form": b_form,
                "Parent Phone": phone
            })
        
        df = pd.DataFrame(data)
        st.dataframe(df, use_container_width=True, hide_index=True)
        
        if privacy_on:
            st.warning("‚ö†Ô∏è Sensitive data is hidden. Turn off 'Privacy Mode' to see full details.")
            
        st.divider()
        # Admin Action Area
        with st.expander("üõ†Ô∏è Advanced Actions (Delete/Edit)"):
            target_id = st.number_input("Enter Student ID", min_value=0, step=1)
            if st.button("üóëÔ∏è Permanent Delete", type="primary"):
                try:
                    Student.objects.get(id=target_id).delete()
                    st.success(f"ID {target_id} deleted successfully!")
                    st.rerun()
                except:
                    st.error("Student ID not found!")
    else:
        st.info("No students found in the database.")

if __name__ == "__main__":
    pass

--- FILE: /home/sami/sumyaman/leave_approvals.py ---

import streamlit as st
import pandas as pd
import sqlite3

def render_leave_approvals(u):
    t_class = u.get('class') or u.get('incharge_class')
    t_sec = u.get('sec', '') or u.get('incharge_section', '')
    t_wing = u.get('wing', '')
    
    with sqlite3.connect("db.sqlite3", timeout=30) as conn:
        p_count = pd.read_sql("SELECT COUNT(*) as count FROM apsokara_studentleave WHERE student_id IN (SELECT id FROM apsokara_student WHERE student_class=? AND wing=?) ", 
                             conn, params=(t_class, t_wing)).iloc[0]['count']

    st.markdown(f"""
        <style>
        .stTabs [data-baseweb="tab-list"] {{ gap: 15px; }}
        .stTabs [data-baseweb="tab"] {{
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 8px 20px;
            color: #475569;
        }}
        .stTabs [aria-selected="true"] {{
            background: #2563eb !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }}
        /* Modern Apple-Style Card */
        .req-card {{
            background: white;
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #f1f5f9;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            transition: transform 0.2s ease;
        }}
        .req-card:hover {{ transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,0,0,0.06); }}
        .student-avatar {{
            background: #eff6ff;
            color: #2563eb;
            width: 45px; height: 45px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: bold;
            margin-right: 15px;
        }}
        .reason-bubble {{
            background: #f8fafc;
            padding: 15px;
            border-radius: 16px;
            color: #334155;
            font-size: 0.95rem;
            line-height: 1.5;
            border: 1px inset #f1f5f9;
        }}
        .status-badge {{
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }}
        </style>
    """, unsafe_allow_html=True)

    tab1, tab2 = st.tabs([f"üì• Pending ({p_count})", "üîç History & Search"])

    with tab1:
        with sqlite3.connect("db.sqlite3", timeout=30) as conn:
            pending = pd.read_sql("""
                SELECT l.*, s.full_name as name 
                FROM apsokara_studentleave l 
                LEFT JOIN apsokara_student s ON l.student_id = s.id 
                WHERE s.student_class=? AND s.wing=?
            """, conn, params=(t_class, t_wing))
        
        if pending.empty:
            st.info("‚ú® Everything is clear! No pending requests.")
        else:
            for _, r in pending.iterrows():
                display_name = r['name'] if (isinstance(r['name'], str) and r['name'].strip()) else f"Student ID: {r['student_id']}"
                st.markdown(f"""
                <div class="req-card">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div class="student-avatar">{display_name[0]}</div>
                        <div>
                            <div style="font-weight: 800; color: #1e293b; font-size: 1.1rem;">{display_name}</div>
                            <div style="font-size: 0.8rem; color: #64748b;">Section {r['section']} ‚Ä¢ {r['from_date']} to {r['to_date']}</div>
                        </div>
                    </div>
                    <div class="reason-bubble">
                        <b>Message:</b><br>{r['reason']}
                    </div>
                </div>
                """, unsafe_allow_html=True)
                
                c1, c2, _ = st.columns([1,1,2])
                if c1.button("‚úÖ Approve", key=f"a{r['id']}", use_container_width=True):
                    with sqlite3.connect("db.sqlite3", timeout=30) as conn:
                        conn.execute("UPDATE apsokara_studentleave SET status='Approved', is_read=1 WHERE id=?", (r['id'],))
                    st.rerun()
                if c2.button("‚ùå Reject", key=f"r{r['id']}", use_container_width=True):
                    with sqlite3.connect("db.sqlite3", timeout=30) as conn:
                        conn.execute("UPDATE apsokara_studentleave SET status='Rejected', is_read=1 WHERE id=?", (r['id'],))
                    st.rerun()

    with tab2:
        st.markdown("### üïµÔ∏è Global History Search")
        c1, c2 = st.columns(2)
        s_name = c1.text_input("üë§ Search Student Name", placeholder="Enter name...")
        s_date = c2.date_input("üóìÔ∏è Filter by Date", value=None)
        
        # Humne query loose rakhi hai taake filter sahi chalein
        query = """
            SELECT s.full_name as Name, l.from_date as Start, l.to_date as End, l.from_date as Date 
            FROM apsokara_studentleave l 
            LEFT JOIN apsokara_student s ON l.student_id = s.id 
            WHERE s.student_class=? AND s.wing=?
        """
        params = [t_class, t_wing]
        
        if s_name:
            query += " AND s.full_name LIKE ?"
            params.append(f"%{s_name}%")
        if s_date:
            query += " AND ? BETWEEN l.from_date AND l.to_date"
            params.append(str(s_date))
            
        with sqlite3.connect("db.sqlite3", timeout=30) as conn:
            hist = pd.read_sql(query + " ORDER BY l.id DESC", conn, params=params)
        
        if hist.empty:
            st.info("No records found for the selected filters.")
        else:
            st.dataframe(
                hist, 
                use_container_width=True, 
                hide_index=True,
                column_config={
                    "Status": st.column_config.TextColumn("Status", help="Approval Status")
                }
            )

--- FILE: /home/sami/sumyaman/attendance_system.py ---

import plotly.graph_objects as go
import streamlit as st
import pandas as pd
import sqlite3
import datetime
import pytz
import io
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from contextlib import contextmanager

@contextmanager
def get_db():
    conn = sqlite3.connect('db.sqlite3', timeout=60)
    conn.execute("PRAGMA journal_mode=WAL;")
    conn.execute("PRAGMA synchronous=NORMAL;")
    conn.execute("PRAGMA busy_timeout=30000;")
    try:
        yield conn
    finally:
        conn.close()

def render_attendance_system(user_info):
    if 'user_info' not in locals(): user_info = st.session_state.get('user_info', {})
    import uuid
    u_id = str(uuid.uuid4())[:4]
    import uuid
    if "call_id" not in st.session_state: st.session_state.call_id = str(uuid.uuid4())[:6]
    cid = st.session_state.call_id
    pk_tz = pytz.timezone("Asia/Karachi")
    today_obj = datetime.datetime.now(pk_tz).date()
    today = today_obj.isoformat()
    teacher_name = user_info.get('full_name', 'Teacher')
    c_name = user_info.get('assigned_class', user_info.get('class', None))
    u_wing = user_info.get('assigned_wing', user_info.get('wing', None))
    u_sec = user_info.get('section', user_info.get('sec', ''))

    if not c_name or not u_wing:
        st.error("‚ùå No Class/Wing assigned to this teacher profile.")

    st.markdown("""<style>@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap'); * { font-family: 'Plus Jakarta Sans', sans-serif; }</style>""", unsafe_allow_html=True)
    st.markdown(f'''<div style="background: linear-gradient(-45deg, #f0f9ff, #e0f2fe, #dbeafe, #f8fafc); padding: 30px; border-radius: 28px; border: 1px solid rgba(59, 130, 246, 0.3); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;"><div><h1 style="margin:0; background: linear-gradient(90deg, #1e3a8a, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">{u_wing} Administration</h1><p style="color: #475569; font-weight: 600;">‚ú® {teacher_name} | Section {c_name}-{u_sec}</p></div><div style="background: white; padding: 10px 20px; border-radius: 15px; border: 1px solid #bfdbfe; text-align: center;"><span style="color: #3b82f6; font-size: 10px; letter-spacing: 2px; display: block;">TIMELINE</span><b style="color: #1e40af; font-size: 18px;">{today_obj.strftime('%d %B, %Y')}</b></div></div>''', unsafe_allow_html=True)

    tab1, tab2, tab3 = st.tabs(["üñãÔ∏è MARKING", "üìÖ ARCHIVE", "üíé INTEL"])

    with get_db() as conn:
        with tab1:
            lock_res = conn.execute("SELECT MAX(edit_count) FROM apsokara_attendance WHERE date=? AND student_id IN (SELECT id FROM apsokara_student WHERE student_class=? AND wing=? AND student_section=?)", (today, c_name, u_wing, u_sec)).fetchone()
            edit_cnt = lock_res[0] if lock_res[0] is not None else 0

            if edit_cnt >= 2:
                st.markdown(f'''<div style="background: rgba(34, 197, 94, 0.1); border-left: 5px solid #22c55e; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid rgba(34, 197, 94, 0.2);"><div style="font-size: 50px;">üõ°Ô∏è</div><h2 style="color: #15803d; margin: 10px 0;">ATTENDANCE SECURED</h2><p style="color: #166534; font-weight: 500;">Today's record for <b style="color: #059669;">{c_name}-{u_sec}</b> is locked.</p><div style="display: inline-block; background: #22c55e; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;">FINALIZED</div></div>''', unsafe_allow_html=True)
                st.balloons()
            else:
                if edit_cnt == 0:
                    st.markdown('''<div style="background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px;"><span style="font-size: 20px;">üí°</span><span style="color: #1e40af; font-weight: 500;"><b>Instruction:</b> Check all students carefully. You can edit this <b>once</b> after syncing.</span></div>''', unsafe_allow_html=True)
                else:
                    st.markdown('''<div style="background: #fff1f2; border: 1px solid #fecdd3; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; animation: pulse 2s infinite;"><span style="font-size: 20px;">‚ö†Ô∏è</span><span style="color: #9f1239; font-weight: 600;"><b>CRITICAL:</b> This is your <b>LAST CHANCE</b>. Database will LOCK after this sync.</span></div><style>@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }</style>''', unsafe_allow_html=True)

                students = pd.read_sql("SELECT id, roll_number, full_name FROM apsokara_student WHERE student_class=? AND wing=? AND student_section=? ORDER BY CAST(roll_number AS INTEGER)", conn, params=(c_name, u_wing, u_sec))
                
                if students.empty:
                    st.warning(f"No students in {c_name}-{u_sec}")
                else:
                    attendance_results = {}
                    for _, s in students.iterrows():
                        st.markdown(f"**{s['full_name']}** (Roll: {s['roll_number']})")
                        attendance_results[s['id']] = {
                            'status': st.segmented_control("Status", ["Present", "Absent", "Leave"], default="Present", key=f"s_{s['id']}_{today}_{cid}", label_visibility="collapsed"),
                        }
                    
                    st.markdown("---")
                    if st.toggle("Verify All Entries", key=f"verify_toggle_{cid}"):
                        btn_label = "üöÄ FINAL LOCK & SYNC" if edit_cnt == 1 else "üöÄ SYNC TO DATABASE"
                        if st.button(btn_label, use_container_width=True, type="primary"):
                            with st.status("Writing to Secure Storage...", expanded=False) as status:
                                try:
                                    cur = conn.cursor()
                                    cur.execute("BEGIN IMMEDIATE TRANSACTION;")
                                    cur.execute("DELETE FROM apsokara_attendance WHERE date=? AND student_id IN (SELECT id FROM apsokara_student WHERE student_class=? AND wing=? AND student_section=?)", (today, c_name, u_wing, u_sec))
                                    final_data = [(sid, d['status'], today, edit_cnt+1, user_info.get('full_name', 'System')) for sid, d in attendance_results.items()]
                                    cur.executemany("INSERT INTO apsokara_attendance (student_id, status, date, edit_count, marked_by) VALUES (?,?,?,?,?)", final_data)
                                    conn.commit()
                                    status.update(label="Sync Complete!", state="complete")
                                    st.success("‚úÖ Attendance Successfully Synced.")
                                    st.rerun()
                                except Exception as e:
                                    conn.rollback()
                                    st.error(f"Critical Error: {e}")

        with tab2:
            v_date = st.date_input("Select Date", today_obj)
            hist = pd.read_sql("SELECT s.roll_number, s.full_name, CASE WHEN a.status IS NULL THEN 'Not Marked' ELSE a.status END as status FROM apsokara_student s LEFT JOIN apsokara_attendance a ON s.id = a.student_id AND DATE(a.date)=DATE(?) WHERE s.student_class=? AND s.wing=? AND s.student_section=? ORDER BY CAST(s.roll_number AS INTEGER)", conn, params=(v_date.isoformat(), c_name, u_wing, u_sec))
            st.dataframe(hist, use_container_width=True, hide_index=True)

        with tab3:
            st.markdown("""<style>
                .main-card { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 25px; padding: 25px; border: 1px solid #e2e8f0; }
                .stat-hero { background: white; border-radius: 20px; padding: 20px; text-align: center; border-bottom: 5px solid #3b82f6; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
                .stat-hero h1 { font-size: 45px; margin: 0; color: #1e3a8a; }
                .stat-hero p { font-size: 14px; color: #64748b; font-weight: 600; text-transform: uppercase; margin: 0; }
                .glass-list { background: rgba(255,255,255,0.6); backdrop-filter: blur(10px); border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); padding: 15px; }
            </style>""", unsafe_allow_html=True)

            st.markdown("<h2 style='color: #1e3a8a; font-weight: 800;'>üíé Student Intelligence Center</h2>", unsafe_allow_html=True)
            s_query = st.text_input("üîç Search Student Name", placeholder="Type name and press Enter...", label_visibility="collapsed")

            if s_query:
                s_data = pd.read_sql("SELECT id, roll_number, full_name, father_name FROM apsokara_student WHERE (full_name LIKE ? OR father_name LIKE ?)   ", conn, params=(f"%{s_query}%", f"%{s_query}%"))
                if not s_data.empty:
                    sel = s_data.iloc[0]; sid = int(sel["id"])
                    stats_df = pd.read_sql("SELECT date, status FROM apsokara_attendance WHERE student_id=? ORDER BY date DESC", conn, params=(sid,))
                    t_days, t_pres = len(stats_df), len(stats_df[stats_df["status"] == "Present"])
                    t_abs, t_leave = len(stats_df[stats_df["status"] == "Absent"]), len(stats_df[stats_df["status"] == "Leave"])
                    perc = (t_pres / t_days * 100) if t_days > 0 else 0

                    # --- Row 1: Hero Analytics ---
                    st.markdown(f"### üìä Academic Overview: {sel['full_name']}")
                    c1, c2, c3, c4 = st.columns(4)
                    with c1: st.markdown(f'<div class="stat-hero" style="border-color: #3b82f6;"><p>Sessions</p><h1>{t_days}</h1></div>', unsafe_allow_html=True)
                    with c2: st.markdown(f'<div class="stat-hero" style="border-color: #22c55e;"><p>Present</p><h1>{t_pres}</h1></div>', unsafe_allow_html=True)
                    with c3: st.markdown(f'<div class="stat-hero" style="border-color: #ef4444;"><p>Absent</p><h1>{t_abs}</h1></div>', unsafe_allow_html=True)
                    with c4: st.markdown(f'<div class="stat-hero" style="border-color: #f59e0b;"><p>Leave</p><h1>{t_leave}</h1></div>', unsafe_allow_html=True)

                    # --- Row 2: The "Intesting" Gauge Chart ---
                    st.markdown("---")
                    g1, g2 = st.columns([1.5, 1])
                    with g1:
                        st.markdown("#### ‚ö° Attendance Reliability Score")
                        fig = go.Figure(go.Indicator(
                            mode = "gauge+number+delta",
                            value = perc,
                            domain = {'x': [0, 1], 'y': [0, 1]},
                            title = {'text': "Current Integrity", 'font': {'size': 16}},
                            gauge = {
                                'axis': {'range': [None, 100], 'tickwidth': 1},
                                'bar': {'color': "#1e3a8a"},
                                'bgcolor': "white",
                                'borderwidth': 2,
                                'bordercolor': "#e2e8f0",
                                'steps': [
                                    {'range': [0, 50], 'color': "#fee2e2"},
                                    {'range': [50, 80], 'color': "#fef9c3"},
                                    {'range': [80, 100], 'color': "#dcfce7"}],
                                'threshold': {
                                    'line': {'color': "red", 'width': 4},
                                    'thickness': 0.75,
                                    'value': 75}}))
                        fig.update_layout(height=300, margin=dict(t=30, b=0, l=10, r=10), paper_bgcolor="rgba(0,0,0,0)")
                        st.plotly_chart(fig, use_container_width=True, key="intel_pdf_download")

                    with g2:
                        st.markdown("#### üéØ Quick Status Search")
                        target_date = st.date_input("Pick a date to verify", today_obj, key="final_intel_date")
                        match = stats_df[stats_df["date"] == target_date.isoformat()]
                        if not match.empty:
                            s_val = match.iloc[0]["status"]
                            color = "#22c55e" if s_val=="Present" else "#ef4444" if s_val=="Absent" else "#f59e0b"
                            st.markdown(f'''<div style="background: {color}; color: white; padding: 45px 20px; border-radius: 25px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-top:10px;">
                                <h2 style="margin:0;">{s_val}</h2><p style="opacity: 0.8; margin:0;">Record for {target_date}</p></div>''', unsafe_allow_html=True)
                        else:
                            st.info("No record found for this date.")

                    # --- Row 3: History & Export ---
                    st.markdown("---")
                    st.markdown("#### üìú Full Detailed Log")
                    st.dataframe(stats_df, use_container_width=True, height=250)
                    
                    def make_pdf():
                        b = io.BytesIO(); c = canvas.Canvas(b, pagesize=letter)
                        c.drawString(100, 750, f"INTEL REPORT: {sel['full_name']}"); y=700
                        for _, r in stats_df.iterrows(): c.drawString(100, y, f"{r['date']}: {r['status']}"); y-=20
                        c.save()
                        b.seek(0)
                        return b.getvalue()
                    st.download_button("üì• Download Official PDF History", make_pdf() or b"", f"{sel['full_name']}_Intel.pdf", "application/pdf", use_container_width=True, key=f"dl_{sel.get("id", 1)}")
                else: st.error("No student found in your assigned section.")

--- FILE: /home/sami/sumyaman/leave_apply.py ---

from datetime import datetime
import streamlit as st
import sqlite3
import pandas as pd
from datetime import date

def render_leave_apply(u):
    st.markdown("""
        <style>
        .stTabs [data-baseweb="tab-list"] { gap: 10px; background-color: transparent; }
        .stTabs [data-baseweb="tab"] {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #fee2e2;
            border-radius: 12px;
            padding: 10px 25px;
            color: #b91c1c;
        }
        .stTabs [aria-selected="true"] {
            background: #dc2626 !important;
            color: white !important;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(220, 38, 38, 0.1);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        .history-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 5px solid #dc2626;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }
        .status-tag {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 5px;
            font-weight: bold;
        }
        </style>
    """, unsafe_allow_html=True)

    tab1, tab2 = st.tabs(["üìù Apply New", "üìú My History"])

    with tab1:
        st.markdown('<div class="glass-card">', unsafe_allow_html=True)
        with st.form("st_form_new", border=False):
            c1, c2 = st.columns(2)
            start = c1.date_input("From Date", date.today())
            end = c2.date_input("To Date", date.today())
            reason = st.text_area("Reason for Leave", placeholder="Detailed reason...")
            if st.form_submit_button("üöÄ Submit Request", use_container_width=True):
                if reason.strip():
                    with sqlite3.connect("db.sqlite3", timeout=30) as conn:
                        conn.execute("INSERT INTO apsokara_studentleave (student_id, class, section, wing, reason, from_date, to_date, status, applied_on) VALUES (?,?,?,?,?,?,?,?,?)", 
                                     (u.get('id'), u.get('class'), u.get('sec'), u.get('wing'), reason, str(start), str(end), 'Pending', datetime.now()))
                    st.success("Application Sent Successfully!"); st.rerun()
        st.markdown('</div>', unsafe_allow_html=True)

    with tab2:
        st.markdown("### Filter History")
        f_date = st.date_input("Select Date", value=None)
        
        query = "SELECT * FROM apsokara_studentleave WHERE student_id=?"
        params = [u['id_num']]
        if f_date:
            query += " AND ? BETWEEN from_date AND to_date"
            params.append(str(f_date))
        
        with sqlite3.connect("db.sqlite3", timeout=30) as conn:
            df = pd.read_sql(query + " ORDER BY id DESC", conn, params=params)
        
        if df.empty: st.info("No records found.")
        for _, r in df.iterrows():
            read_status = "‚úÖ Viewed" if r['is_read'] == 1 else "üì© Unread"
            color = "#fef2f2" if r['status'] == "Pending" else "#f0fdf4"
            txt_color = "#991b1b" if r['status'] == "Pending" else "#166534"
            
            st.markdown(f"""
            <div class="history-card" style="background: {color};">
                <div style="display:flex; justify-content:space-between;">
                    <b style="color:#1e1b4b;">{r['from_date']} to {r['to_date']}</b>
                    <span class="status-tag" style="background:white; color:{txt_color}; border:1px solid {txt_color};">{r['status']}</span>
                </div>
                <p style="margin:10px 0; font-size:0.9rem;">{r['reason']}</p>
                <div style="font-size:0.75rem; color:#64748b; font-weight:bold;">Status: {read_status}</div>
            </div>
            """, unsafe_allow_html=True)

--- FILE: /home/sami/sumyaman/leave_utils.py ---

import sqlite3
import datetime

def check_on_leave(student_id, target_date=None):
    try:
        if target_date is None:
            target_date = datetime.date.today().isoformat()
        
        conn = sqlite3.connect('/home/sami/sumyaman/db.sqlite3')
        cur = conn.cursor()
        # Range check: target_date should be between from_date and to_date
        query = "SELECT id FROM apsokara_studentleave WHERE student_id=? AND status='Approved' AND ? BETWEEN from_date AND to_date"
        cur.execute(query, (student_id, target_date))
        res = cur.fetchone()
        conn.close()
        return True if res else False
    except Exception as e:
        return False

--- FILE: /home/sami/sumyaman/sumyaman_pro/asgi.py ---

"""
ASGI config for sumyaman_pro project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'sumyaman_pro.settings')

application = get_asgi_application()

--- FILE: /home/sami/sumyaman/sumyaman_pro/__init__.py ---


--- FILE: /home/sami/sumyaman/sumyaman_pro/urls.py ---

from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('hq-portal/', include('apsokara.urls')),
] + static(settings.STATIC_URL, document_root=settings.STATIC_ROOT)

--- FILE: /home/sami/sumyaman/sumyaman_pro/settings.py ---

import os
from pathlib import Path
BASE_DIR = Path(__file__).resolve().parent.parent
with open('.env_key') as f: SECRET_KEY = f.read().strip()
DEBUG = True
ALLOWED_HOSTS = ['*']

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'apsokara', 
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'sumyaman_pro.urls'

# Maine yahan se double 'DIRS' ko remove kar ke clean kar diya hai
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'
STATIC_URL = 'static/'
# Agar static files use karni hain to ye line bhi honi chahiye:
STATICFILES_DIRS = [BASE_DIR / "static"]
LOGOUT_REDIRECT_URL = '/admin/login/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

# --- HQ ADMIN EXTRA SECURITY LAYER ---
# Sirf local machine se access allow karne ke liye
ALLOWED_HOSTS = ['127.0.0.1', 'localhost', '0.0.0.0']

# Browser Security Headers
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'

# Session Security (Strict Mode)
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Lax'
# Note: SECURE_COOKIEs tab enable karte hain jab HTTPS ho, 
# lekin local use ke liye HTTPONLY kafi hai.

# --- ADVANCED HACKER PROTECTION ---
# 1. Clickjacking se bachao (Koi aapki site ko frame nahi kar sakega)
X_FRAME_OPTIONS = 'DENY'

# 2. Browser ko majboor karna ke wo sirf hamari scripts chalaye (CSP)
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True

# 3. Session Hijacking se bachne ke liye (Sirf browser read kar sakega)
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Strict'

# 4. Agar hacker SQL Injection try kare toh Django built-in protection active hai.
LOGIN_URL = '/admin/login/'

--- FILE: /home/sami/sumyaman/sumyaman_pro/wsgi.py ---

"""
WSGI config for sumyaman_pro project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'sumyaman_pro.settings')

application = get_wsgi_application()

--- FILE: /home/sami/sumyaman/debug_db.py ---

import os
import django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'sumyaman_pro.settings')
django.setup()

from apsokara.models import StudentLeave, Student

print("\n" + "="*50)
print("1. TOTAL LEAVES COUNT IN DB:", StudentLeave.objects.count())

print("\n2. ALL LEAVES DETAILS:")
leaves = StudentLeave.objects.all()
if not leaves:
    print("   ‚ùå Database mein koi leave record nahi hai!")
else:
    for l in leaves:
        s = l.student
        print(f"   - ID: {l.id} | Student: {s.full_name} | Class: '{s.student_class}' | Section: '{s.student_section}' | Status: '{l.status}'")

print("\n3. CLASS 2-D SPECIFIC CHECK:")
class_2d_students = Student.objects.filter(student_class='2', student_section='D')
print(f"   - Students found in 2-D: {class_2d_students.count()}")
leaves_2d = StudentLeave.objects.filter(student__in=class_2d_students)
print(f"   - Leaves found for these students: {leaves_2d.count()}")
print("="*50 + "\n")

--- FILE: /home/sami/sumyaman/recovery_zone/attendance_system.py ---

import plotly.graph_objects as go
import streamlit as st
import pandas as pd
import sqlite3
import datetime
import pytz
import io
from reportlab.lib.pagesizes import letter
from reportlab.pdfgen import canvas
from contextlib import contextmanager

@contextmanager
def get_db():
    conn = sqlite3.connect('db.sqlite3', timeout=60)
    conn.execute("PRAGMA journal_mode=WAL;")
    conn.execute("PRAGMA synchronous=NORMAL;")
    conn.execute("PRAGMA busy_timeout=30000;")
    try:
        yield conn
    finally:
        conn.close()

def render_attendance_system(u):
    pk_tz = pytz.timezone("Asia/Karachi")
    today_obj = datetime.datetime.now(pk_tz).date()
    today = today_obj.isoformat()
    teacher_name = u.get('name', 'Teacher')
    c_name = u.get('class', None)
    u_wing = u.get('wing', None)
    u_sec = u.get('section', u.get('sec', ''))

    if not c_name or not u_wing:
        st.error("‚ùå No Class/Wing assigned to this teacher profile.")
        return

    st.markdown("""<style>@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap'); * { font-family: 'Plus Jakarta Sans', sans-serif; }</style>""", unsafe_allow_html=True)
    st.markdown(f'''<div style="background: linear-gradient(-45deg, #f0f9ff, #e0f2fe, #dbeafe, #f8fafc); padding: 30px; border-radius: 28px; border: 1px solid rgba(59, 130, 246, 0.3); display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;"><div><h1 style="margin:0; background: linear-gradient(90deg, #1e3a8a, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">{u_wing} Administration</h1><p style="color: #475569; font-weight: 600;">‚ú® {teacher_name} | Section {c_name}-{u_sec}</p></div><div style="background: white; padding: 10px 20px; border-radius: 15px; border: 1px solid #bfdbfe; text-align: center;"><span style="color: #3b82f6; font-size: 10px; letter-spacing: 2px; display: block;">TIMELINE</span><b style="color: #1e40af; font-size: 18px;">{today_obj.strftime('%d %B, %Y')}</b></div></div>''', unsafe_allow_html=True)

    tab1, tab2, tab3 = st.tabs(["üñãÔ∏è MARKING", "üìÖ ARCHIVE", "üíé INTEL"])

    with get_db() as conn:
        with tab1:
            lock_res = conn.execute("SELECT MAX(edit_count) FROM apsokara_attendance WHERE date=? AND student_class=? AND wing=? AND student_section=?", (today, c_name, u_wing, u_sec)).fetchone()
            edit_cnt = lock_res[0] if lock_res[0] is not None else 0

            if edit_cnt >= 2:
                st.markdown(f'''<div style="background: rgba(34, 197, 94, 0.1); border-left: 5px solid #22c55e; padding: 25px; border-radius: 15px; text-align: center; border: 1px solid rgba(34, 197, 94, 0.2);"><div style="font-size: 50px;">üõ°Ô∏è</div><h2 style="color: #15803d; margin: 10px 0;">ATTENDANCE SECURED</h2><p style="color: #166534; font-weight: 500;">Today's record for <b style="color: #059669;">{c_name}-{u_sec}</b> is locked.</p><div style="display: inline-block; background: #22c55e; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; font-weight: bold;">FINALIZED</div></div>''', unsafe_allow_html=True)
                st.balloons()
            else:
                if edit_cnt == 0:
                    st.markdown('''<div style="background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px;"><span style="font-size: 20px;">üí°</span><span style="color: #1e40af; font-weight: 500;"><b>Instruction:</b> Check all students carefully. You can edit this <b>once</b> after syncing.</span></div>''', unsafe_allow_html=True)
                else:
                    st.markdown('''<div style="background: #fff1f2; border: 1px solid #fecdd3; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; animation: pulse 2s infinite;"><span style="font-size: 20px;">‚ö†Ô∏è</span><span style="color: #9f1239; font-weight: 600;"><b>CRITICAL:</b> This is your <b>LAST CHANCE</b>. Database will LOCK after this sync.</span></div><style>@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }</style>''', unsafe_allow_html=True)

                students = pd.read_sql("SELECT id, roll_no, full_name, session_year FROM apsokara_student WHERE student_class=? AND wing=? AND student_section=? AND is_active=1 ORDER BY CAST(roll_no AS INTEGER)", conn, params=(c_name, u_wing, u_sec))
                
                if students.empty:
                    st.warning(f"No students in {c_name}-{u_sec}")
                else:
                    attendance_results = {}
                    for _, s in students.iterrows():
                        st.markdown(f"**{s['full_name']}** (Roll: {s['roll_no']})")
                        attendance_results[s['id']] = {
                            'status': st.segmented_control("Status", ["Present", "Absent", "Leave"], default="Present", key=f"s_{s['id']}_{today}", label_visibility="collapsed"),
                            'year': s['session_year']
                        }
                    
                    st.markdown("---")
                    if st.toggle("Verify All Entries", key="verify_toggle"):
                        btn_label = "üöÄ FINAL LOCK & SYNC" if edit_cnt == 1 else "üöÄ SYNC TO DATABASE"
                        if st.button(btn_label, use_container_width=True, type="primary"):
                            with st.status("Writing to Secure Storage...", expanded=False) as status:
                                try:
                                    cur = conn.cursor()
                                    cur.execute("BEGIN IMMEDIATE TRANSACTION;")
                                    cur.execute("DELETE FROM apsokara_attendance WHERE date=? AND student_class=? AND wing=? AND student_section=?", (today, c_name, u_wing, u_sec))
                                    final_data = [(today, sid, edit_cnt+1, c_name, u_sec, u_wing, d['year'], d['status'], teacher_name) for sid, d in attendance_results.items()]
                                    cur.executemany("INSERT INTO apsokara_attendance (date, student_id, edit_count, student_class, student_section, wing, session_year, status, marked_by) VALUES (?,?,?,?,?,?,?,?,?)", final_data)
                                    conn.commit()
                                    status.update(label="Sync Complete!", state="complete")
                                    st.success("‚úÖ Attendance Successfully Synced.")
                                    st.rerun()
                                except Exception as e:
                                    conn.rollback()
                                    st.error(f"Critical Error: {e}")

        with tab2:
            v_date = st.date_input("Select Date", today_obj)
            hist = pd.read_sql("SELECT s.roll_no, s.full_name, IFNULL(a.status, 'Not Marked') as status FROM apsokara_student s LEFT JOIN apsokara_attendance a ON s.id = a.student_id AND a.date=? WHERE s.student_class=? AND s.wing=? AND s.student_section=? ORDER BY CAST(s.roll_no AS INTEGER)", conn, params=(v_date.isoformat(), c_name, u_wing, u_sec))
            st.dataframe(hist, use_container_width=True, hide_index=True)

        with tab3:
            st.markdown("""<style>
                .main-card { background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 25px; padding: 25px; border: 1px solid #e2e8f0; }
                .stat-hero { background: white; border-radius: 20px; padding: 20px; text-align: center; border-bottom: 5px solid #3b82f6; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
                .stat-hero h1 { font-size: 45px; margin: 0; color: #1e3a8a; }
                .stat-hero p { font-size: 14px; color: #64748b; font-weight: 600; text-transform: uppercase; margin: 0; }
                .glass-list { background: rgba(255,255,255,0.6); backdrop-filter: blur(10px); border-radius: 15px; border: 1px solid rgba(255,255,255,0.2); padding: 15px; }
            </style>""", unsafe_allow_html=True)

            st.markdown("<h2 style='color: #1e3a8a; font-weight: 800;'>üíé Student Intelligence Center</h2>", unsafe_allow_html=True)
            s_query = st.text_input("üîç Search Student Name", placeholder="Type name and press Enter...", label_visibility="collapsed")

            if s_query:
                s_data = pd.read_sql("SELECT id, roll_no, full_name, father_name FROM apsokara_student WHERE (full_name LIKE ? OR father_name LIKE ?) AND student_class=? AND wing=? AND student_section=?", conn, params=(f"%{s_query}%", f"%{s_query}%", c_name, u_wing, u_sec))
                if not s_data.empty:
                    sel = s_data.iloc[0]; sid = int(sel["id"])
                    stats_df = pd.read_sql("SELECT date, status FROM apsokara_attendance WHERE student_id=? ORDER BY date DESC", conn, params=(sid,))
                    t_days, t_pres = len(stats_df), len(stats_df[stats_df["status"] == "Present"])
                    t_abs, t_leave = len(stats_df[stats_df["status"] == "Absent"]), len(stats_df[stats_df["status"] == "Leave"])
                    perc = (t_pres / t_days * 100) if t_days > 0 else 0

                    # --- Row 1: Hero Analytics ---
                    st.markdown(f"### üìä Academic Overview: {sel['full_name']}")
                    c1, c2, c3, c4 = st.columns(4)
                    with c1: st.markdown(f'<div class="stat-hero" style="border-color: #3b82f6;"><p>Sessions</p><h1>{t_days}</h1></div>', unsafe_allow_html=True)
                    with c2: st.markdown(f'<div class="stat-hero" style="border-color: #22c55e;"><p>Present</p><h1>{t_pres}</h1></div>', unsafe_allow_html=True)
                    with c3: st.markdown(f'<div class="stat-hero" style="border-color: #ef4444;"><p>Absent</p><h1>{t_abs}</h1></div>', unsafe_allow_html=True)
                    with c4: st.markdown(f'<div class="stat-hero" style="border-color: #f59e0b;"><p>Leave</p><h1>{t_leave}</h1></div>', unsafe_allow_html=True)

                    # --- Row 2: The "Intesting" Gauge Chart ---
                    st.markdown("---")
                    g1, g2 = st.columns([1.5, 1])
                    with g1:
                        st.markdown("#### ‚ö° Attendance Reliability Score")
                        fig = go.Figure(go.Indicator(
                            mode = "gauge+number+delta",
                            value = perc,
                            domain = {'x': [0, 1], 'y': [0, 1]},
                            title = {'text': "Current Integrity", 'font': {'size': 16}},
                            gauge = {
                                'axis': {'range': [None, 100], 'tickwidth': 1},
                                'bar': {'color': "#1e3a8a"},
                                'bgcolor': "white",
                                'borderwidth': 2,
                                'bordercolor': "#e2e8f0",
                                'steps': [
                                    {'range': [0, 50], 'color': "#fee2e2"},
                                    {'range': [50, 80], 'color': "#fef9c3"},
                                    {'range': [80, 100], 'color': "#dcfce7"}],
                                'threshold': {
                                    'line': {'color': "red", 'width': 4},
                                    'thickness': 0.75,
                                    'value': 75}}))
                        fig.update_layout(height=300, margin=dict(t=30, b=0, l=10, r=10), paper_bgcolor="rgba(0,0,0,0)")
                        st.plotly_chart(fig, use_container_width=True)

                    with g2:
                        st.markdown("#### üéØ Quick Status Search")
                        target_date = st.date_input("Pick a date to verify", today_obj, key="final_intel_date")
                        match = stats_df[stats_df["date"] == target_date.isoformat()]
                        if not match.empty:
                            s_val = match.iloc[0]["status"]
                            color = "#22c55e" if s_val=="Present" else "#ef4444" if s_val=="Absent" else "#f59e0b"
                            st.markdown(f'''<div style="background: {color}; color: white; padding: 45px 20px; border-radius: 25px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-top:10px;">
                                <h2 style="margin:0;">{s_val}</h2><p style="opacity: 0.8; margin:0;">Record for {target_date}</p></div>''', unsafe_allow_html=True)
                        else:
                            st.info("No record found for this date.")

                    # --- Row 3: History & Export ---
                    st.markdown("---")
                    st.markdown("#### üìú Full Detailed Log")
                    st.dataframe(stats_df, use_container_width=True, height=250)
                    
                    def make_pdf():
                        b = io.BytesIO(); c = canvas.Canvas(b, pagesize=letter)
                        c.drawString(100, 750, f"INTEL REPORT: {sel['full_name']}"); y=700
                        for _, r in stats_df.iterrows(): c.drawString(100, y, f"{r['date']}: {r['status']}"); y-=20
                        c.save(); return b.getvalue()
                    st.download_button("üì• Download Official PDF History", make_pdf(), f"{sel['full_name']}_Intel.pdf", "application/pdf", use_container_width=True)
                else: st.error("No student found in your assigned section.")
